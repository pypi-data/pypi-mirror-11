$(document).ready(function(){$("#loading").fadeIn();var t,e,a,r,n,o,l,s,a,d=window.innerWidth,p=(window.innerHeight,.9*d),m=160,g=.8*m,u=20,v=45,f=7,y=colorbrewer.Set1[9],_=0,b="ws://"+location.host+"/pongsocket",w=new WebSocket(b);w.onmessage=function(e){var o=JSON.parse(e.data);if("pong-data"==o.type)for(a=o.pong,console.log(a),_+=a.qmatrices.length,_>0&&$("#loading").fadeIn(),r=a.popNames,n=a.popSizes,a.colors.length>0&&(y=a.colors),t=new Array,i=0;i<a.qmatrices.length;i++)majorID=a.qmatrices[i].major_mode_runid,plot=d3.select("#visualization").append("svg").attr("width",p).attr("height",m+15).attr("class","majorSVG").attr("id","plot"+majorID),t.push(plot),S(majorID,"no",null,null);else if("q-matrix"==o.type){var l=o.minor,s=o.minorID,d=o.is_first;"no"==l?k(d3.select("#plot"+o.name),o.K,o.matrix2d,o.minor,s,d):k(d3.select("#plot"+o.name+"_minor"),o.K,o.matrix2d,o.minor,s,d)}};var S=function(t,e,a,r){w.send(JSON.stringify({type:"get-qmatrix",name:t,minor:e,minorID:a,is_first:r}))},k=function(t,e,r,i,d,m){if("yes"==i)var u=.85*g;else var u=g;var v=r.length,f=a.qmatrices[e-a.K_min].color_perm;"yes"==i?(minorWidth=.75*p,s=.1*minorWidth,o=minorWidth-s-60):(s=.1*p,o=p-s-60),l=o/v;var b=a.qmatrices[e-a.K_min],w=b.major_mode_runid,S=Object.keys(b.modes),k=S.indexOf(w);k>-1&&S.splice(k,1);var z=I(b,S);0!=S.length&&"no"==i&&A(e,z),"no"==i?(q(t,e,b),D(t,e,w)):K(t,b,d,m);var P=t.append("g").attr("class","indiv");for(c=0;c<e;c++){if("yes"==i&&"no"==m)var M=d+"_minorCluster"+f[c].toString();else var M="cluster"+(c+1).toString();var W=P.selectAll("rect."+M).data(r).enter().append("rect");W.attr({x:function(t,e){return s+e*l},y:function(t){for(h=0,x=c+1;x<e;x++)h+=t[x]*u;return h},width:l,height:function(t){return t[c]*u},"class":M}),W.style("fill",y[f[c]])}var C=t.append("g").attr("class","lines"),L=t.append("g").attr("class","pop");if("yes"==i)var E=d3.select("#plot"+d.toString()+"_minor").append("g").attr("class","minorPop"+e);var J=s,B=s,T=s;if(null!=n)for(var F=0;F<n.length;F++){if(C.append("line").attr({x1:B,x2:B,y1:0,y2:u,"class":"delimiter"}),"no"==i)var G=L.selectAll("rect").data(a.indiv_avg[w]).enter().append("rect");else var G=E.selectAll("rect").data(a.indiv_avg[d]).enter().append("rect");L.call(O),d3.selectAll(".modes").on("click",function(){console.log("button clicked");var t=this.id,e=t.split("-")[1];console.log(e),d3.selectAll(".minorPop"+e).call(O)}),G.attr({"class":function(t,e){return"no"==i?"popNum pop"+(e+1):"minorPopNum minorPlot"+d},id:function(t,a){return"no"==i?"k"+e+"p"+(a+1):"minor_"+d+"_p"+(a+1)},x:function(t,e){var a=T;return T+=n[e]*l,a},y:0,width:function(t,e){return n[e]*l},height:u}),G.on("mouseover",O.show).on("mouseout",O.hide),G.style("fill","transparent"),G.style("stroke","black"),J=B,B+=n[F]*l}if(d3.selectAll(".delimiter").attr("stroke","green").style("stroke-width","0.3"),d3.select("#whiteout"+e).on("click",function(){for(F in z)N(e,z[F],f)}),d3.selectAll(".popNum").on("click",function(){console.log("population clicked");var t=this.id,e=t.indexOf("p"),a=t.substring(e+1);console.log(a);d3.selectAll(".popNum").style("fill","grey").style("opacity","0.85");d3.selectAll(".pop"+a.toString()).style("fill","transparent")}),$(document).mouseup(function(t){var e=$(".popNum"),a=$(".buttonDiv");e.is(t.target)||a.is(t.target)||0!==e.has(t.target).length||0!==a.has(t.target).length||e.css("fill","transparent")}),"no"==i&&r[0].length==a.K_max){var H=d3.select("#visualization").append("svg").attr("class","majorPopLabels").attr("width",p).attr("height",u+"px");j(H)}if("yes"==i&&d==z[z.length-1]){var H=d3.select("#modal_body_"+e).append("svg").attr("class","minorPopLabels").attr("width",.75*p).attr("height",u+"px");j(H)}_--,0===_&&$("#loading").delay(200).fadeOut()},j=function(t){var e=s,a=s;for(i in r){e=a,a+=n[i]*l;{var o=e+.5*(a-e)-.5*u,d=f,p="translate("+o+","+d+")rotate("+v+")";t.append("text").text(r[i]).attr("class","x-axis").attr("transform",p).style("font-size","12px")}}},A=function(t,r){var n=d3.select("body").append("div").attr("class","buttonDiv"),o=n.append("button").attr("type","button").attr("class","modes bt btn-info btn-lg").attr("data-toggle","modal").attr("data-target","#modal-"+t.toString()).attr("id","button-"+t);o.style("position","absolute"),o.style("top",215+1.131*m*(t-a.K_min)+"px"),o.style("left",(p-35).toString()+"px");{var l=(o.append("span").attr("class","glyphicon glyphicon-plus").attr("aria-hidden",!0).html('<strong style="margin-left: 5px;">'+r.length+"</strong>"),n.append("div").attr("class","modal fade").attr("id","modal-"+t).attr("role","dialog")),d=l.append("div").attr("class","modal-dialog"),c=d.append("div").attr("class","modal-content").style("width",(.75*p+60).toString()+"px").style("left",(s+10).toString()+"px"),g=c.append("div").attr("class","modal-header").attr("id","title"+t);g.append("button").attr("type","button").attr("class","close").attr("data-dismiss","modal").text("x"),g.append("h2").attr("class","modal-title").html("Clustering modes, K="+t)}e=new Array;var u=c.append("div").attr("class","modal-header").attr("id","modal_header2_"+t),v=u.append("label").attr("class","checkbox-inline");v.append("input").attr("type","checkbox").attr("class","check-input").attr("id","whiteout"+t);var h=(u.append("text").attr("class","checkbox-caption").text("\nCheck to highlight multimodality: "),a.qmatrices[t-a.K_min].major_mode_runid);plot=d3.select("#modal_header2_"+t).append("svg").attr("width",.75*p).attr("height",.85*m).attr("id","plot"+h+"_minor"),e.push(plot),console.log("about to getQmatrix of weird major"),S(h,"yes",h,"yes");c.append("div").attr("class","modal-body").attr("id","modal_body_"+t);for(i=0;i<r.length;i++){var f=r[i];plot=d3.select("#modal_body_"+t).append("svg").attr("width",.75*p).attr("height",.85*m).attr("id","plot"+f+"_minor"),e.push(plot),S(f,"yes",f,"no")}},q=function(t,e,a){var r=a.total_runs,n=a.major_mode_runid,i=a.modes[n].runs_represented.length,o=.5*g+.5*u;label=t.append("text").text("K = "+e.toString()),label.attr("class","label"),label.attr("x",0).attr("y",o),runs=t.append("text").text(i+"/"+r+" runs"),runs.attr("x",0).attr("y",o+25),avg_sim=a.modes[n].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg similarity: "+avg_sim.toString().substring(0,5)),sim.attr("x",s).attr("y",-5),sim.style("fill","rgb(70, 184, 218)"))},K=function(t,e,a,r){var n=e.total_runs,i=e.modes[a].runs_represented.length,o=.5*g*.85+.5*u;"yes"==r&&(major=t.append("text").text("major mode"),major.attr("class","majorMinorLabel"),major.attr("x",-1).attr("y",o-38)),label=t.append("text").text(a),label.attr("class","label"),label.attr("x",0).attr("y",o),rep=t.append("text").text("represents"),rep.attr("x",0).attr("y",o+14),runs=t.append("text").text(i+"/"+n+" runs"),runs.attr("class","minorRun"),runs.attr("x",0).attr("y",o+30),avg_sim=e.modes[a].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg similarity: "+avg_sim.toString().substring(0,5)),sim.attr("class","avg_sim"),sim.attr("x",s).attr("y",-5),sim.style("fill","rgb(70, 184, 218)"))},I=function(t,e){var a={};for(var r in e){var n=e[r],i=t.modes[n].runs_represented.length;a[n]=i}var o=Object.keys(a).map(function(t){return[t,a[t]]});o.sort(function(t,e){return e[1]-t[1]});var l=new Array;for(var r in o)l.push(o[r][0]);return l},N=function(t,e,r){var n=a.qmatrices[t-a.K_min].modes[e];if(null!=n.gray_indices){var o=n.gray_indices;for(i in n.gray_indices){var l=r[o[i]],s="."+e+"_minorCluster"+l.toString();"visible"==d3.selectAll(s).style("visibility")?d3.selectAll(s).style("visibility","hidden"):d3.selectAll(s).style("visibility","visible")}}},D=function(t,e){var r=Math.round(1e3*a.qmatrices[e-a.K_min].avg_sim_bt_modes)/1e3;null!=r&&(simMode=d3.select("#title"+e).append("h4").text("\nAvg similarity among modes = "+r))},O=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t,e){console.log("in tooltip");var i=t.length,o=a.qmatrices[i-a.K_min].color_perm,l="<strong>"+r[e]+"</strong><br>"+n[e]+" samples<br><br>";return t.forEach(function(t,e){var a=Math.round(1e3*t)/10,r=y[o[e]];0!=a&&(l+="<strong><font color="+r+">"+a+"%</font><strong><br>")}),l}),z=function(t,e){var r=t,n=new XMLSerializer;if(e){r="all";for(var i="<svg>",o=0;o<a.qmatrices.length;o++)i+=n.serializeToString(document.getElementById("plot"+a.qmatrices[o].major_mode_runid));i+="</svg>"}else var l=document.getElementById("plot"+plot),i=n.serializeToString(l);w.send(JSON.stringify({type:"svg",svg:i,name:r}))};$(document).on("click","#downloadPDF",function(){z("",!0)})});