$(document).ready(function(){function t(t,e){var a=(new XMLSerializer).serializeToString(t),n=e.getContext("2d"),r=new Image;return r.src="data:image/svg+xml;base64,"+btoa(a),r.onload=function(){n.drawImage(r,0,0)},r}$("#loading").fadeIn();var e,a,n,r,o,l,s,d,n,p=window.innerWidth,m=(window.innerHeight,.9*p),u=160,f=.8*u,g=20,v=45,y=17,b=colorbrewer.Set1[9],_=["#f0a3ff","#0075dc","#993f00","#4c005c","#191919","#005c31","#2bce48","#ffcc99","#808080","#94ffb5","#8f7c00","#9dcc00","#c20088","#003380","#ffa405","#ffa8bb","#426600","#ff0010","#5ef1f2","#00998f","#e0ff66","#740aff","#990000","#ffff80","#ffff00","#ff5005"],A=0,j=0,S=(new Array,"ws://"+location.host+"/pongsocket"),k=new WebSocket(S);k.onmessage=function(t){var a=JSON.parse(t.data);if("pong-data"==a.type)for(n=a.pong,console.log(n),A+=n.qmatrices.length,A>0&&$("#loading").fadeIn(),r=n.popNames,o=n.popSizes,n.colors.length>0?b=n.colors:n.K_max>9&&(b=_),e=new Array,i=0;i<n.qmatrices.length;i++)majorID=n.qmatrices[i].major_mode_runid,plot=d3.select("#visualization").append("svg").attr("width",m).attr("height",u+15).attr("class","majorSVG").attr("id","plot"+majorID),e.push(plot),P(majorID,"no",null,null);else if("q-matrix"==a.type){var l=a.minor,s=a.minorID,d=a.is_first;"no"==l?z(d3.select("#plot"+a.name),a.K,a.matrix2d,a.minor,s,d):z(d3.select("#plot"+a.name+"_minor"),a.K,a.matrix2d,a.minor,s,d)}};var P=function(t,e,a,n){k.send(JSON.stringify({type:"get-qmatrix",name:t,minor:e,minorID:a,is_first:n}))},z=function(t,e,a,i,p,u){if(console.log("generateVis"),"yes"==i)var g=.85*f;else var g=f;var v=a.length,y=n.qmatrices[e-n.K_min].color_perm;"yes"==i?(minorWidth=.75*m,l=.84*minorWidth,d=0,translate=.08*minorWidth):(l=.84*m,translate=.08*m,d=0),s=l/v;var _=n.qmatrices[e-n.K_min],w=_.major_mode_runid,S=Object.keys(_.modes),k=S.indexOf(w);k>-1&&S.splice(k,1);var K=C(_,S);0!=S.length&&"no"==i&&N(e,K),"no"==i?(q(t,e,_),V(t,e,w)):B(t,_,p,u);var P=15,z=t.append("g").attr("transform","translate("+translate+", "+P+")"),O=z.append("svg").attr("class","plotSVG").attr("width",l).attr("id","plotSVG_"+w),F=O.append("g").attr("class","indiv");for(c=0;c<e;c++){if("yes"==i&&"no"==u)var J=p+"_minorCluster"+y[c].toString();else var J="cluster"+(c+1).toString();var T=F.selectAll("rect."+J).data(a).enter().append("rect");T.attr({x:function(t,e){return d+e*s},y:function(t){for(h=0,x=c+1;x<e;x++)h+=t[x]*g;return h},width:s,height:function(t){return t[c]*g},"class":J}),T.style("fill",b[y[c]])}var H=O.append("g").attr("class","lines"),Q=O.append("g").attr("class","pop");if("yes"==i)var R=O.append("g").attr("class","minorPop"+e);var X=d,U=d,Y=d;if(null!=o)for(var Z=0;Z<o.length;Z++){if(H.append("line").attr({x1:U,x2:U,y1:0,y2:g,"class":"delimiter"}),Q.call(M),"no"==i)var te=Q.selectAll("rect").data(n.indiv_avg[w]).enter().append("rect").on("mouseover",M.show).on("mouseout",M.hide);else var te=R.selectAll("rect").data(n.indiv_avg[p]).enter().append("rect").on("mouseover",L.show).on("mouseout",L.hide);d3.select("#vizButton").on("click",function(){var t=new Array;for(popNum=1;popNum<o.length+1;popNum++){console.log("in viz");var e=".pop"+popNum.toString();"rgba(0, 0, 0, 0)"==d3.selectAll(e).style("fill")&&t.push(e)}console.log("vizButton clicked"),console.log(t),d3.selectAll(".modal-title-viz").html(function(){var e="<h2>Visualizing populations:  </h2>",a="";for(Z in t){var n=t[Z].indexOf("o"),i=t[Z].substring(n+2),o=r[i-1];a+=o+", "}return e+'<h3 style="color: rgb(70, 184, 218)">'+a.substring(0,a.length-2)+"</h3>"})}),d3.selectAll(".modes").on("click",function(){console.log("button clicked");var t=this.id,e=t.split("-")[1];d3.selectAll(".minorPop"+e).call(L)}),te.attr({"class":function(t,e){return"no"==i?"popNum pop"+(e+1):"minorPopNum minorPlot"+p},id:function(t,a){return"no"==i?"k"+e+"p"+(a+1):"minor_"+p+"_p"+(a+1)},x:function(t,e){var a=Y;return Y+=o[e]*s,a},y:0,width:function(t,e){return o[e]*s},height:g}),te.style("fill","transparent"),te.style("stroke","black"),X=U,U+=o[Z]*s}if(d3.selectAll(".delimiter").attr("stroke","green").style("stroke-width","0.3"),d3.select("#whiteout"+e).on("click",function(){for(Z in K)I(e,K[Z],y)}),d3.selectAll(".popNum").on("click",function(){console.log("population clicked");var t=this.id,e=t.indexOf("p"),a=t.substring(e+1);if(console.log(a),event.shiftKey)d3.selectAll(".pop"+a.toString()).style("fill","transparent");else{{d3.selectAll(".popNum").style("fill","grey").style("opacity","0.85")}d3.selectAll(".pop"+a.toString()).style("fill","transparent")}}),$(document).mouseup(function(t){var e=$(".popNum"),a=$(".buttonDiv"),n=$("#vizButton"),r=$(".modal-content");e.is(t.target)||a.is(t.target)||n.is(t.target)||0!==e.has(t.target).length||0!==a.has(t.target).length||0!==n.has(t.target).length||e.css("fill","transparent"),r.is(t.target)||0!==r.has(t.target).length||$(".close").click()}),"no"==i&&a[0].length==n.K_max){var ee=d3.select("#visualization").append("svg").attr("class","majorPopLabels").attr("width",m).attr("height",g+"px");D(ee)}if("yes"==i&&p==K[K.length-1]){var ee=d3.select("#modal_body_"+e).append("svg").attr("class","minorPopLabels").attr("width",.75*m).attr("height",g+"px");D(ee),E(e)}if(A--,0===A&&$("#loading").delay(200).fadeOut(),"yes"==i&&0===j&&$("#loading").delay(200).fadeOut(),G(t,e,_,i,n.K_min),"no"==i)var ae=_.major_mode_runid;if("yes"==i)var ae=t[0][0].getAttribute("id").slice(4);$("#"+ae+"_print").click(function(e){e.preventDefault(),W(_,i,t,ae).print()})},D=function(t){{var e=translate,a=translate;translate}for(i in r){e=a,a+=o[i]*s;{var n=e+.5*(a-e)-.5*g,l=y,d="translate("+n+","+l+")rotate("+v+")";t.append("text").text(r[i]).attr("class","x-axis").attr("transform",d).style("font-size","12px").style("font-family","Arial, sans-serif")}}},N=function(t,e){var a=d3.select("body").append("div").attr("class","buttonDiv"),r=a.append("button").attr("type","button").attr("class","modes bt btn-info btn-lg").attr("data-toggle","modal").attr("data-target","#modal-"+t.toString()).attr("id","button-"+t);r.style("position","absolute").style("top",214+1.131*u*(t-n.K_min)+15+"px").style("left",(translate+.84*m+10).toString()+"px");r.append("span").attr("class","glyphicon glyphicon-plus").attr("aria-hidden",!0).html('<strong style="margin-left: 5px; font-family: Arial, sans-serif;">'+e.length+"</strong>");O(t,e,r,a,!1)},O=function(t,e,r,o,l){{var s=o.append("div").attr("class","modal fade").attr("id",function(){return 0==l?"modal-"+t:"modal-viz"}).attr("role","dialog"),c=s.append("div").attr("class","modal-dialog"),p=c.append("div").attr("class","modal-content").attr("id","modal-content-"+t).style("width",(.75*m+80).toString()+"px").style("left",(d+10).toString()+"px"),f=p.append("div").attr("class","modal-header").attr("id",function(){return 0==l?"title"+t:"titleViz"});f.append("button").attr("type","button").attr("class","close").attr("data-dismiss","modal").text("x"),f.append("h2").attr("class",function(){return 0==l?"modal-title":"modal-title-viz"}).html(function(){return 0==l?"Clustering modes, K="+t:void 0})}if(a=new Array,0==l){var g=p.append("div").attr("class","modal-header").attr("id","modal_header2_"+t),v=g.append("label").attr("class","checkbox-inline");v.append("input").attr("type","checkbox").attr("class","check-input").attr("id","whiteout"+t),v.style("position","relative").style("top","5px");var y=(g.append("text").attr("class","checkbox-caption").text("\nCheck to highlight multimodality: "),n.qmatrices[t-n.K_min].major_mode_runid);plot=d3.select("#modal_header2_"+t).append("svg").attr("width",.75*m).attr("height",.95*u).attr("class","minorSVG-"+t).attr("id","plot"+y+"_minor"),a.push(plot),console.log("about to getQmatrix of weird major"),P(y,"yes",y,"yes")}p.append("div").attr("class","modal-body").attr("id",function(){return 0==l?"modal_body_"+t:"modal_body_viz"});if(0==l)for(i=0;i<e.length;i++){var h=e[i];plot=d3.select("#modal_body_"+t).append("svg").attr("width",.75*m).attr("height",.95*u).attr("class","minorSVG-"+t).attr("id","plot"+h+"_minor"),a.push(plot),P(h,"yes",h,"no")}},q=function(t,e,a){var n=a.total_runs,r=a.major_mode_runid,i=a.modes[r].runs_represented.length,o=.5*f+.5*g;label=t.append("text").text("K = "+e.toString()),label.attr("class","label").style("font","bold 20px Arial, sans-serif"),label.attr("x",0).attr("y",o),runs=t.append("text").text(i+"/"+n+" runs").attr("id","major_bigstring"),runs.attr("x",0).attr("y",o+25),runs.style("font","12px Arial, sans-serif");var l=document.getElementById("major_bigstring").getBBox(),s=l.width;s>translate&&(translate=s+5),avg_sim=a.modes[r].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg similarity: "+avg_sim.toString().substring(0,5)),sim.attr("x",translate).attr("y",10),sim.style("fill","rgb(70, 184, 218)"),sim.style("font","bold 12px Arial, sans-serif"))},B=function(t,e,a,n){var r=e.total_runs,i=e.modes[a].runs_represented.length,o=.5*f*.85+.5*g;return"yes"==n&&(major=t.append("text").text("major mode"),major.attr("class","majorMinorLabel").attr("id","minor_bigstring"),major.attr("x",0).attr("y",o-38-15),major.style("font","bold 14px Arial, sans-serif")),83.609>translate&&(translate=88.609),label=t.append("text").text(a),label.attr("class","label"),label.attr("x",0).attr("y",o-26),label.style("font","20px Arial, sans-serif"),rep=t.append("text").text("represents"),rep.attr("x",0).attr("y",o+14-26),rep.style("font","12px Arial, sans-serif"),runs=t.append("text").text(i+"/"+r+" runs"),runs.attr("class","minorRun"),runs.attr("x",0).attr("y",o+30-26),runs.style("font","12px Arial, sans-serif"),avg_sim=e.modes[a].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg similarity:"+avg_sim.toString().substring(0,5)),sim.attr("class","avg_sim"),sim.attr("x",translate).attr("y",10),sim.style("fill","rgb(70, 184, 218)"),sim.style("font","bold 12px Arial, sans-serif")),0},C=function(t,e){var a={};for(var n in e){var r=e[n],i=t.modes[r].runs_represented.length;a[r]=i}var o=Object.keys(a).map(function(t){return[t,a[t]]});o.sort(function(t,e){return e[1]-t[1]});var l=new Array;for(var n in o)l.push(o[n][0]);return l},I=function(t,e,a){var r=n.qmatrices[t-n.K_min].modes[e];if(null!=r.gray_indices){var o=r.gray_indices;for(i in r.gray_indices){var l=a[o[i]],s="."+e+"_minorCluster"+l.toString(),d=d3.select("#modal_body_"+t).select(".downloadModalPDF");"visible"==d3.selectAll(s).style("visibility")?(d3.selectAll(s).style("visibility","hidden"),d.classed("btn btn-primary",!0).text("Print highlighting multimodality at K="+t)):(d3.selectAll(s).style("visibility","visible"),d.classed("btn-primary",!1).text("Print all modes at K="+t))}}},V=function(t,e){var a=Math.round(1e3*n.qmatrices[e-n.K_min].avg_sim_bt_modes)/1e3;null!=a&&(simMode=d3.select("#title"+e).append("h4").text("\nAvg similarity among modes = "+a))},M=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t,e){var a=t.length,i=n.qmatrices[a-n.K_min].color_perm,l='<div class="text-center"><strong>'+r[e]+"</strong><br>"+o[e]+" samples</div><br>";return l+="<div><ul>",t.forEach(function(t,e){var a=Math.round(1e3*t)/10,n=b[i[e]];0!=a&&(l+='<i class="fa fa-circle" style="color: '+n+' "></i>',l+="&nbsp;<strong> "+a+"%</strong></li><br>")}),l+="</ul></div>"}),L=d3.tip().attr("class","d3-minorTip").offset(function(t){var e=t.length,a=d3.select("#modal-content-"+e).style("width"),n=a.substring(0,a.length-2),r=this.getBBox().x,i=this.getBBox().width,o=r+i,l=n-o;return[0,l+30]}).html(function(t,e){var a=t.length,i=n.qmatrices[a-n.K_min].color_perm,l='<div class="text-center"><strong>'+r[e]+"</strong><br>"+o[e]+" samples</div><br>";return l+="<div><ul>",t.forEach(function(t,e){var a=Math.round(1e3*t)/10,n=b[i[e]];0!=a&&(l+='<i class="fa fa-circle" style="color: '+n+' "></i>',l+="&nbsp;<strong> "+a+"%</strong></li><br>")}),l+="</ul></div>"});$(document).on("click","#downloadPDF",function(){F("no").print()}),$(document).on("click",".downloadModalPDF",function(){console.log($(this)),K=$(this)[0].id,console.log("K from button = "+K),F(K).print()});var E=function(t){{var e=d3.select("#modal_body_"+t).append("div").attr("class","modal-body");e.append("div").attr("class","row").append("div").attr("class","text-center").append("button").attr("type","submit").attr("class","btn btn-default downloadModalPDF").attr("id",t).text("Print all modes at K="+t)}},G=function(t,e,a,n,r){if("no"==n)var i=d3.select("body").append("div").attr("class","pbDiv"),o=a.major_mode_runid+"_print";if("yes"==n)var i=d3.select("#modal_body_"+e).append("div").attr("class","pbDiv"),o=t[0][0].getAttribute("id").slice(4)+"_print",l=t[0][0].getAttribute("id").slice(4).slice(0,t[0][0].getAttribute("id").slice(4).indexOf("_minor")),s=Object.keys(a.modes),d=C(a,s),c=d.indexOf(l);var p=i.append("a").attr("id",o).append("span").attr("class","glyphicon glyphicon-print");"no"==n&&p.attr("id","print-major-"+e),"yes"==n&&p.attr("id","print-minor-"+l),"no"==n&&(p.attr("title","Print K="+e+" barplot"),i.style("position","absolute").style("top",1.131*u*(e-r+1)+85+"px").style("left","20px")),"yes"==n&&(p.attr("title","Print "+l+" barplot"),i.style("position","absolute").style("left","35px"),0==c?i.style("top",.95*u*-1+108.8-15+"px"):i.style("top",(.95*u+5)*c+5-15+"px"))},W=function(e,a,n,r){var i=d3.select("#plot"+r).node();if("no"==a)var o=d3.select(".majorPopLabels").node();if("yes"==a)var o=d3.select(".minorPopLabels").node();var l=document.createElement("canvas"),s=t(i,l),d=t(o,l),c=window.open();return c.document.body.appendChild(s),c.document.body.appendChild(d),c},F=function(e){var a=document.createElement("canvas");if("no"==e)var n=document.getElementsByClassName("majorSVG"),r=d3.select(".majorPopLabels").node();else{console.log(e);var n=document.getElementsByClassName("minorSVG-"+e),r=d3.select(".minorPopLabels").node()}new Object;w=window.open();for(var i=0;i<n.length;i++){var o=t(n[i],a);w.document.body.appendChild(o)}return labs=t(r,a),w.document.body.appendChild(labs),w}});