$(document).ready(function(){$("#loading").fadeIn();var t,e,a,r,n,l,o,s,a,d=window.innerWidth,p=(window.innerHeight,.9*d),m=160,u=.8*m,g=20,f=45,v=7,y=colorbrewer.Set1[9],b=["#f0a3ff","#0075dc","#993f00","#4c005c","#191919","#005c31","#2bce48","#ffcc99","#808080","#94ffb5","#8f7c00","#9dcc00","#c20088","#003380","#ffa405","#ffa8bb","#426600","#ff0010","#5ef1f2","#00998f","#e0ff66","#740aff","#990000","#ffff80","#ffff00","#ff5005"],_=0,w=(new Array,"ws://"+location.host+"/pongsocket"),S=new WebSocket(w);S.onmessage=function(e){var l=JSON.parse(e.data);if("pong-data"==l.type)for(a=l.pong,console.log(a),_+=a.qmatrices.length,_>0&&$("#loading").fadeIn(),r=a.popNames,n=a.popSizes,a.colors.length>0?y=a.colors:a.K_max>9&&(y=b),t=new Array,i=0;i<a.qmatrices.length;i++)majorID=a.qmatrices[i].major_mode_runid,plot=d3.select("#visualization").append("svg").attr("width",p).attr("height",m+15).attr("class","majorSVG").attr("id","plot"+majorID),t.push(plot),k(majorID,"no",null,null);else if("q-matrix"==l.type){var o=l.minor,s=l.minorID,d=l.is_first;"no"==o?A(d3.select("#plot"+l.name),l.K,l.matrix2d,l.minor,s,d):A(d3.select("#plot"+l.name+"_minor"),l.K,l.matrix2d,l.minor,s,d)}};var k=function(t,e,a,r){S.send(JSON.stringify({type:"get-qmatrix",name:t,minor:e,minorID:a,is_first:r}))},A=function(t,e,i,d,m,g){if(console.log("generateVis"),"yes"==d)var f=.85*u;else var f=u;var v=i.length,b=a.qmatrices[e-a.K_min].color_perm;"yes"==d?(minorWidth=.75*p,l=.84*minorWidth,s=0,translate=.08*minorWidth):(l=.84*p,translate=.08*p,s=0),o=l/v;var w=a.qmatrices[e-a.K_min],S=w.major_mode_runid,k=Object.keys(w.modes),A=k.indexOf(S);A>-1&&k.splice(A,1);var K=O(w,k);0!=k.length&&"no"==d&&z(e,K),"no"==d?(N(t,e,w),I(t,e,S)):q(t,w,m,g);var V=t.append("g").attr("transform","translate("+translate+", 0)"),C=V.append("svg").attr("class","plotSVG").attr("width",l).attr("id","plotSVG_"+S),M=C.append("g").attr("class","indiv");for(c=0;c<e;c++){if("yes"==d&&"no"==g)var W=m+"_minorCluster"+b[c].toString();else var W="cluster"+(c+1).toString();var B=M.selectAll("rect."+W).data(i).enter().append("rect");B.attr({x:function(t,e){return s+e*o},y:function(t){for(h=0,x=c+1;x<e;x++)h+=t[x]*f;return h},width:o,height:function(t){return t[c]*f},"class":W}),B.style("fill",y[b[c]])}var G=C.append("g").attr("class","lines"),L=C.append("g").attr("class","pop");if("yes"==d)var J=C.append("g").attr("class","minorPop"+e);var E=s,F=s,H=s;if(null!=n)for(var Q=0;Q<n.length;Q++){if(G.append("line").attr({x1:F,x2:F,y1:0,y2:f,"class":"delimiter"}),L.call(P),"no"==d)var R=L.selectAll("rect").data(a.indiv_avg[S]).enter().append("rect").on("mouseover",P.show).on("mouseout",P.hide);else var R=J.selectAll("rect").data(a.indiv_avg[m]).enter().append("rect").on("mouseover",P.show).on("mouseout",P.hide);d3.select("#vizButton").on("click",function(){var t=new Array;for(popNum=1;popNum<n.length+1;popNum++){console.log("in viz");var e=".pop"+popNum.toString();"rgba(0, 0, 0, 0)"==d3.selectAll(e).style("fill")&&t.push(e)}console.log("vizButton clicked"),console.log(t),d3.selectAll(".modal-title-viz").html(function(){var e="<h2>Visualizing populations:  </h2>",a="";for(Q in t){var n=t[Q].indexOf("o"),i=t[Q].substring(n+2),l=r[i-1];a+=l+", "}return e+'<h3 style="color: rgb(70, 184, 218)">'+a.substring(0,a.length-2)+"</h3>"})}),d3.selectAll(".modes").on("click",function(){console.log("button clicked");var t=this.id,e=t.split("-")[1];console.log(e),d3.selectAll(".minorPop"+e).call(P)}),R.attr({"class":function(t,e){return"no"==d?"popNum pop"+(e+1):"minorPopNum minorPlot"+m},id:function(t,a){return"no"==d?"k"+e+"p"+(a+1):"minor_"+m+"_p"+(a+1)},x:function(t,e){var a=H;return H+=n[e]*o,a},y:0,width:function(t,e){return n[e]*o},height:f}),R.style("fill","transparent"),R.style("stroke","black"),E=F,F+=n[Q]*o}if(d3.selectAll(".delimiter").attr("stroke","green").style("stroke-width","0.3"),d3.select("#whiteout"+e).on("click",function(){for(Q in K)D(e,K[Q],b)}),d3.selectAll(".popNum").on("click",function(){console.log("population clicked");var t=this.id,e=t.indexOf("p"),a=t.substring(e+1);if(console.log(a),event.shiftKey)d3.selectAll(".pop"+a.toString()).style("fill","transparent");else{{d3.selectAll(".popNum").style("fill","grey").style("opacity","0.85")}d3.selectAll(".pop"+a.toString()).style("fill","transparent")}}),$(document).mouseup(function(t){var e=$(".popNum"),a=$(".buttonDiv"),r=$("#vizButton"),n=$(".modal-content");e.is(t.target)||a.is(t.target)||r.is(t.target)||0!==e.has(t.target).length||0!==a.has(t.target).length||0!==r.has(t.target).length||e.css("fill","transparent"),n.is(t.target)||0!==n.has(t.target).length||$(".close").click()}),"no"==d&&i[0].length==a.K_max){var T=d3.select("#visualization").append("svg").attr("class","majorPopLabels").attr("width",p).attr("height",f+"px");j(T)}if("yes"==d&&m==K[K.length-1]){var T=d3.select("#modal_body_"+e).append("svg").attr("class","minorPopLabels").attr("width",.75*p).attr("height",f+"px");j(T)}_--,0===_&&$("#loading").delay(200).fadeOut()},j=function(t){{var e=translate,a=translate;translate}for(i in r){e=a,a+=n[i]*o;{var l=e+.5*(a-e)-.5*g,s=v,d="translate("+l+","+s+")rotate("+f+")";t.append("text").text(r[i]).attr("class","x-axis").attr("transform",d).style("font-size","12px")}}},z=function(t,e){var r=d3.select("body").append("div").attr("class","buttonDiv"),n=r.append("button").attr("type","button").attr("class","modes bt btn-info btn-lg").attr("data-toggle","modal").attr("data-target","#modal-"+t.toString()).attr("id","button-"+t);n.style("position","absolute").style("top",214+1.131*m*(t-a.K_min)+"px").style("left",(p-35).toString()+"px");n.append("span").attr("class","glyphicon glyphicon-plus").attr("aria-hidden",!0).html('<strong style="margin-left: 5px;">'+e.length+"</strong>");K(t,e,n,r,!1)},K=function(t,r,n,l,o){{var d=l.append("div").attr("class","modal fade").attr("id",function(){return 0==o?"modal-"+t:"modal-viz"}).attr("role","dialog"),c=d.append("div").attr("class","modal-dialog"),u=c.append("div").attr("class","modal-content").style("width",(.75*p+60).toString()+"px").style("left",(s+10).toString()+"px"),g=u.append("div").attr("class","modal-header").attr("id",function(){return 0==o?"title"+t:"titleViz"});g.append("button").attr("type","button").attr("class","close").attr("data-dismiss","modal").text("x"),g.append("h2").attr("class",function(){return 0==o?"modal-title":"modal-title-viz"}).html(function(){return 0==o?"Clustering modes, K="+t:void 0})}if(e=new Array,0==o){var f=u.append("div").attr("class","modal-header").attr("id","modal_header2_"+t),v=f.append("label").attr("class","checkbox-inline");v.append("input").attr("type","checkbox").attr("class","check-input").attr("id","whiteout"+t);var h=(f.append("text").attr("class","checkbox-caption").text("\nCheck to highlight multimodality: "),a.qmatrices[t-a.K_min].major_mode_runid);plot=d3.select("#modal_header2_"+t).append("svg").attr("width",.75*p).attr("height",.85*m).attr("id","plot"+h+"_minor"),e.push(plot),console.log("about to getQmatrix of weird major"),k(h,"yes",h,"yes")}u.append("div").attr("class","modal-body").attr("id",function(){return 0==o?"modal_body_"+t:"modal_body_viz"});if(0==o)for(i=0;i<r.length;i++){var y=r[i];plot=d3.select("#modal_body_"+t).append("svg").attr("width",.75*p).attr("height",.85*m).attr("id","plot"+y+"_minor"),e.push(plot),k(y,"yes",y,"no")}},N=function(t,e,a){var r=a.total_runs,n=a.major_mode_runid,i=a.modes[n].runs_represented.length,l=.5*u+.5*g;label=t.append("text").text("K = "+e.toString()),label.attr("class","label"),label.attr("x",0).attr("y",l),runs=t.append("text").text(i+"/"+r+" runs"),runs.attr("x",0).attr("y",l+25),avg_sim=a.modes[n].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg similarity: "+avg_sim.toString().substring(0,5)),sim.attr("x",translate).attr("y",-5),sim.style("fill","rgb(70, 184, 218)"))},q=function(t,e,a,r){var n=e.total_runs,i=e.modes[a].runs_represented.length,l=.5*u*.85+.5*g;"yes"==r&&(major=t.append("text").text("major mode"),major.attr("class","majorMinorLabel"),major.attr("x",-10).attr("y",l-38)),label=t.append("text").text(a),label.attr("class","label"),label.attr("x",0).attr("y",l),rep=t.append("text").text("represents"),rep.attr("x",0).attr("y",l+14),runs=t.append("text").text(i+"/"+n+" runs"),runs.attr("class","minorRun"),runs.attr("x",0).attr("y",l+30),avg_sim=e.modes[a].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg similarity: "+avg_sim.toString().substring(0,5)),sim.attr("class","avg_sim"),sim.attr("x",translate).attr("y",-5),sim.style("fill","rgb(70, 184, 218)"))},O=function(t,e){var a={};for(var r in e){var n=e[r],i=t.modes[n].runs_represented.length;a[n]=i}var l=Object.keys(a).map(function(t){return[t,a[t]]});l.sort(function(t,e){return e[1]-t[1]});var o=new Array;for(var r in l)o.push(l[r][0]);return o},D=function(t,e,r){var n=a.qmatrices[t-a.K_min].modes[e];if(null!=n.gray_indices){var l=n.gray_indices;for(i in n.gray_indices){var o=r[l[i]],s="."+e+"_minorCluster"+o.toString();"visible"==d3.selectAll(s).style("visibility")?d3.selectAll(s).style("visibility","hidden"):d3.selectAll(s).style("visibility","visible")}}},I=function(t,e){var r=Math.round(1e3*a.qmatrices[e-a.K_min].avg_sim_bt_modes)/1e3;null!=r&&(simMode=d3.select("#title"+e).append("h4").text("\nAvg similarity among modes = "+r))},P=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t,e){console.log("in tooltip");var i=t.length,l=a.qmatrices[i-a.K_min].color_perm,o='<div class="text-center"><strong>'+r[e]+"</strong><br>"+n[e]+" samples</div><br>";return o+="<div><ul>",t.forEach(function(t,e){var a=Math.round(1e3*t)/10,r=y[l[e]];0!=a&&(o+='<i class="fa fa-circle" style="color: '+r+' "></i>',o+="&nbsp;<strong> "+a+"%</strong></li><br>")}),o+="</ul></div>"}),V=function(){for(var t=new XMLSerializer,e=document.getElementsByClassName("plotSVG"),a=new Object,r=0;r<e.length;r++)a[e[r].id]=t.serializeToString(e[r]);S.send(JSON.stringify({type:"multi-svg","svg-dict":a}))};$(document).on("click","#downloadPDF",function(){V()})});