<tool id="cloudmap_prepare" name="Prepare variant data for mapping" version="0.1.6.1">
  <description>with the CloudMap series of tools.</description>
  <version_command>mimodd version -q</version_command>
  <command>
    mimodd cloudmap "$ifile" ${run.mode} "$sample"
    
    #if $str($run.related_parent_sample):
        -r "${run.related_parent_sample}"
    #end if
    #if $str($run.unrelated_parent_sample):
        -u "${run.unrelated_parent_sample}"
    #end if
    
    $run.infer_missing
    -o "$ofile"
    
    #if $seqdict:
        -s "$dictfile"
    #end if
  </command>

  <inputs>
    <param name="ifile" type="data" format="vcf" label="vcf input file" />
    <conditional name="run">
      <param name="mode" type="select" label="Type of CloudMap analysis to prepare data for" help="select Simple Variant Density (SVD) Mapping to generate output for the CloudMap EMS Variant Density Mapping tool or Variant Allele Frequency (VAF) Mapping for output for the CloudMap Variant Discovery or Hawaiian Variant Mapping tools.">
        <option value="SVD">Simple Variant Density Mapping</option>
        <option value="VAF">Variant Allele Frequency Mapping</option>
      </param>
      <when value="SVD">
        <param name="related_parent_sample" type="hidden" value="" />
        <param name="unrelated_parent_sample" type="hidden" value="" />
        <param name="infer_missing" type="hidden" value="" />
      </when>
      <when value="VAF">
        <param name="related_parent_sample" type="text" label="name of the related parent sample" help="the sample that provides variants present in your original mutant strain or in an ancestor (like the pre-mutagenesis strain); leave blank if not available" />
        <param name="unrelated_parent_sample" type="text" label="name of the unrelated parent sample" help="the sample that provides variants present in the unrelated mapping strain (or in an ancestor of it) used in the mapping cross; leave blank if not available" />
        <param name="infer_missing" type="boolean" checked="false" truevalue="--infer-missing" falsevalue="" label="Infer alleles for missing parent" help="if variant data for either the related or the unrelated parent strain is not available, the tool can try to infer the alleles present in that parent from the allele spectrum found in the mapping sample. This is an experimental option that will give a benefit only in certain situations. Enable at your own risk." />
      </when>
    </conditional>
    <param name="sample" type="text" label="mapping sample name" help="the sample to perform mutation mapping for" />
    <param name="seqdict" type="boolean" checked="true" label="Generate species configuration file for CloudMap" />      
  </inputs>

  <outputs>
    <data name="ofile" format="vcf" label="CloudMap-ready ${run.mode} File from ${on_string}" />
    <data name="dictfile" format="tabular" label="Species Configuration File for CloudMap from ${on_string}">
      <filter>seqdict</filter>
    </data>
  </outputs>

  <help>
.. class:: infomark

   **What it does**

The purpose of this tool is to provide compatibility of the MiModD analysis workflow with the external `CloudMap`_ *EMS Variant Density Mapping*, *Variant Discovery Mapping* and *Hawaiian Variant Mapping* tools. These tools complement MiModD by providing easily interpreted visualizations of mapping-by-sequencing analysis workflows.

The tool converts a VCF file as generated by the *Extract Variant Sites* or *VCF Filter* tools to the format expected by the *CloudMap* series of tools.

Optionally, it also extracts the chromosome names and sizes and reports them in the *CloudMap* *species configuration file* format.
Such a file is required as input to the current versions of the *CloudMap* *Hawaiian* and *Variant Density* mapping tools, if you are working with a species other than the natively supported ones (i.e., other than *C. elegans*, *A. thaliana* or *Brachypodium distachyon*).

To use the output datasets of the tool with *CloudMap*, you only have to upload them to any public Galaxy server that hosts *CloudMap* like, e.g., the main Galaxy server at https://usegalaxy.org .

**Notes:**

1) Simple Variant Density (SVD) Mapping mode generates output for use with the CloudMap EMS Variant Density Mapping tool. The aim of SVD analysis is to identify clusters of variants that appear linked to a mutant phenotype selected for during several rounds of outcrossing or backcrossing to a non-mutagenized strain. The "mapping sample" is the out-/backcrossed strain and only its variants are taken into account for the analysis.

.. class:: warningmark

   EMS Variant Density Mapping is currently limited to *C. elegans* and other species with six chromosomes on the *CloudMap* side.

2) Variant Allele Frequency (VAF) Mapping mode generates output for use with the CloudMap Variant Discovery or Hawaiian Variant Mapping tools. The aim of VAF analysis is to identify clusters of variants with (near) homozygous inheritance in a F2 population obtained from a cross between a mutant strain of interest and an unrelated mapping strain. Here, the "mapping sample" is the pooled F2 population. To analyze inheritance patterns this mode **requires either** a list of variants that could have been inherited through the mapping strain, i.e. the "unrelated parent strain", or through the mutant parent, i.e. through the "related parent strain". If variants are available for both parents, they can be analyzed together for higher mapping accuracy.

3) More information on combining MiModD and CloudMap in mapping-by-sequencing analyses can be found in the `corresponding section of the MiModD User Guide`_.

.. _CloudMap: https://usegalaxy.org/u/gm2123/p/cloudmap
.. _corresponding section of the MiModD User Guide: http://mimodd.readthedocs.org/en/latest/cloudmap.html

  </help>
</tool>
