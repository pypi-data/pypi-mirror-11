<?xml version="1.0" encoding="UTF-8"?>
{% load i18n %}
<schedule>
    <conference>
        <title>{{ WAFER_CONFERENCE_NAME }}</title>
        {% if schedule_days %}
        {% with day=schedule_days|first %}
            <start>{{ day.day.date|date:"Y-m-d" }}</start>
        {% endwith %}
        {% with day=schedule_days|last %}
            <end>{{ day.day.date|date:"Y-m-d" }}</end>
        {% endwith %}
        <days>{{ schedule_days|length }}</days>
        {% endif %}
        <day_change>00:00</day_change>
        <timeslot_duration>00:15</timeslot_duration>
    </conference>
    {% for schedule_day in schedule_days %}
    <day date="{{ schedule_day.day.date|date:'Y-m-d' }}" index="{{ forloop.counter }}">
        {% for venue in schedule_day.venues %}
        <room name="{{ venue.name }}">
            {% for row in schedule_day.rows %}
            {% if venue in row.items %}
                {# this is more than a little horrible, but will do for testing #}
                {% for row_venue, items in row.items.items %}
                {% if row_venue == venue %}
                {# The event id is the ScheduleItem pk, which should be unique enough #}
                <event id="{{ items.item.pk }}">
                    {# Not sure what to do about timezones here #}
                    <date>{{ schedule_day.day.date|date:"Y-m-d" }}T{{ row.slot.get_start_time|time:"H:i:s" }}+00:00</date>
                    <start>{{ row.slot.get_start_time|time:"H:i" }}</start>
                    {% with dur=row.slot.get_duration %}
                        <duration>{{ dur.hours|stringformat:"02d" }}:{{ dur.minutes|stringformat:"02d" }}</duration>
                    {% endwith %}
                    <room>{{ venue.name }}</room>
                    {# Confclerk needs this to import the conference. #}
                    <track/> {# Set this to be the same as room? #}
                    {# These fields aren't needed, but it may be useful to include them if we can find sensible data to fill them with #}
                    {# <type/> - Talk type or "event" for non-talk pages? #}
                    {# <description/> - For non-talk items? #}
                    {% if items.item.talk %}
                       <title>{{ items.item.get_title }}</title>
                       <persons>
                           {% for author in items.item.talk.authors.all %}
                               {# person id is the author pk, which should be the right thing #}
                               <person id="{{ author.pk }}">{{ author.get_full_name|default:author.username }}</person>
                           {% endfor %}
                       </persons>
                    {# It looks like abstract needs to be stripped of markup so punt on including that for now #}
                    <abstract/>
                    {% else %}
                        <title>{{ items.item.get_details|escape }}</title>
                        {# No abstract for non-talk items #}
                        <abstract/>
                    {% endif %}
                    <conf_url>{{ items.item.get_url }}</conf_url>
                </event>
                {% endif %}
                {% endfor %}
            {% endif %}
            {% endfor %}
        </room>
        {% endfor %}
    </day>
    {% endfor %}
</schedule>
