<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>yt.analysis_modules.sunrise_export.sunrise_exporter &mdash; The yt Project 3.2-dev documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/bootswatch-3.3.4/readable/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '3.2-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="The yt Project 3.2-dev documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
    
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-391373-2']);
      _gaq.push(['_setDomainName', 'yt-project.org']);
      _gaq.push(['_setAllowHash', false]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html"><img src="../../../../_static/yt_icon.png">
          The yt Project</a>
        <span class="navbar-text navbar-version pull-left"><b>3.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../help/index.html">How to get help</a></li>
                <li><a href="../../../../quickstart/index.html">Quickstart notebooks</a></li>
                <li><a href="../../../../cookbook/index.html">Cookbook</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installing.html">Getting and Installing yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../installing.html#getting-yt">Getting yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../installing.html#testing-your-installation">Testing Your Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../installing.html#switching-between-yt-2-x-and-yt-3-x">Switching between yt-2.x and yt-3.x</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/index.html">yt Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../quickstart/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quickstart/data_inspection.html">Data Inspection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quickstart/simple_visualization.html">Simple Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quickstart/data_objects_and_time_series.html">Data Objects and Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quickstart/derived_fields_and_profiles.html">Derived Fields and Profiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../quickstart/volume_rendering.html">Volume Rendering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../yt3differences.html">What&#8217;s New and Different in yt 3.0?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../yt3differences.html#updating-to-yt-3-0-from-old-versions-and-going-back">Updating to yt 3.0 from Old Versions (and going back)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../yt3differences.html#converting-old-scripts-to-work-with-yt-3-0">Converting Old Scripts to Work with yt 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../yt3differences.html#cool-new-things">Cool New Things</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../yt3differences.html#api-changes">API Changes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cookbook/index.html">The Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../cookbook/index.html#getting-the-sample-data">Getting the Sample Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../cookbook/index.html#example-scripts">Example Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../cookbook/index.html#example-notebooks">Example Notebooks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../visualizing/index.html">Visualizing Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/plots.html">How to Make Plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/callbacks.html">Plot Modifications: Overplotting Contours, Velocities, Particles, and More</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/manual_plotting.html">Using the Manual Plotting Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/volume_rendering.html">Volume Rendering: Making 3D Photorealistic Isocontoured Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/hardware_volume_rendering.html">Hardware Volume Rendering on NVidia Graphics cards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/sketchfab.html">3D Surfaces and Sketchfab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/mapserver.html">Mapserver - A Google-Maps-like Interface to your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/streamlines.html">Streamlines: Tracking the Trajectories of Tracers in your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/colormaps/index.html">Colormaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../visualizing/writing_fits_images.html">Writing FITS Images</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing/index.html">General Data Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/fields.html">Fields in yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/creating_derived_fields.html">Creating Derived Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/objects.html">Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/units/index.html">Symbolic Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/filtering.html">Filtering your Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/generating_processed_data.html">Generating Processed Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/time_series_analysis.html">Time Series Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/parallel_computation.html">Parallel Computation With yt</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing/analysis_modules/index.html">Topic-Specific Analysis Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/analysis_modules/halo_analysis.html">Halo Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/analysis_modules/synthetic_observation.html">Synthetic Observation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/analysis_modules/exporting.html">Exporting to External Radiation Transport Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/analysis_modules/two_point_functions.html">Two Point Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/analysis_modules/clump_finding.html">Clump Finding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/analysis_modules/particle_trajectories.html">Particle Trajectories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analyzing/analysis_modules/ellipsoid_analysis.html">Halo Ellipsoid Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examining/index.html">Loading and Examining Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../examining/loading_data.html">Loading Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examining/generic_array_data.html">Loading Generic Array Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examining/generic_particle_data.html">Loading Generic Particle Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examining/spherical_data.html">Loading Spherical Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examining/low_level_inspection.html">Low-Level Data Inspection: Accessing Raw Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../developing/index.html">Developing in yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/intro.html">Getting Involved</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/developing.html">How to Develop yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/building_the_docs.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/debugdrive.html">Debugging yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/creating_datatypes.html">Creating Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/creating_derived_fields.html">Creating Derived Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/creating_derived_quantities.html">Creating Derived Quantities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/creating_frontend.html">Creating A New Code Frontend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../developing/external_analysis.html">Using yt with External Analysis Tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/index.html">Reference Materials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/code_support.html">Code Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/command-line.html">Command-Line Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/api/api.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/configuration.html">Customizing yt: The Configuration and Plugin Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/field_list.html">Field List</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/changelog.html">ChangeLog</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/index.html">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../faq/index.html#version-installation">Version &amp; Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../faq/index.html#code-errors-and-failures">Code Errors and Failures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../faq/index.html#units">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../faq/index.html#fields">Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../faq/index.html#data-objects">Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../faq/index.html#developing">Developing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../faq/index.html#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../help/index.html">Getting Help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#don-t-panic-and-don-t-give-up">Don&#8217;t panic and don&#8217;t give up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#update-to-the-latest-version">Update to the latest version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#search-the-documentation-faq-and-mailing-lists">Search the documentation, FAQ, and mailing lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#look-at-the-source-code">Look at the source code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#isolate-and-document-your-problem">Isolate and document your problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#go-on-irc-to-ask-a-question">Go on IRC to ask a question</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#ask-the-mailing-list">Ask the mailing list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#submit-a-bug-report">Submit a bug report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../help/index.html#special-issues">Special Issues</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about/index.html">About yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../about/index.html#what-is-yt">What is yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about/index.html#who-is-yt">Who is yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about/index.html#history-of-yt">History of yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about/index.html#how-do-i-contact-yt">How do I contact yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about/index.html#how-do-i-cite-yt">How do I cite yt?</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <h1>Source code for yt.analysis_modules.sunrise_export.sunrise_exporter</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Code to export from yt to Sunrise</span>



<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="c">#-----------------------------------------------------------------------------</span>
<span class="c"># Copyright (c) 2013, yt Development Team.</span>
<span class="c">#</span>
<span class="c"># Distributed under the terms of the Modified BSD License.</span>
<span class="c">#</span>
<span class="c"># The full license is in the file COPYING.txt, distributed with this software.</span>
<span class="c">#-----------------------------------------------------------------------------</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyfits</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> 
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">yt.funcs</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">yt.utilities.lib.api</span> <span class="kn">as</span> <span class="nn">amr_utils</span>
<span class="kn">from</span> <span class="nn">yt.utilities.physical_constants</span> <span class="kn">import</span> \
    <span class="n">kpc_per_cm</span><span class="p">,</span> \
    <span class="n">sec_per_year</span>
<span class="kn">from</span> <span class="nn">yt.mods</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="export_to_sunrise"><a class="viewcode-back" href="../../../../reference/api/generated/yt.analysis_modules.sunrise_export.sunrise_exporter.export_to_sunrise.html#yt.analysis_modules.sunrise_export.sunrise_exporter.export_to_sunrise">[docs]</a><span class="k">def</span> <span class="nf">export_to_sunrise</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">star_particle_type</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">fwidth</span><span class="p">,</span> <span class="n">ncells_wide</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;Convert the contents of a dataset to a FITS file format that Sunrise</span>
<span class="sd">    understands.</span>

<span class="sd">    This function will accept a dataset, and from that dataset</span>
<span class="sd">    construct a depth-first octree containing all of the data in the parameter</span>
<span class="sd">    file.  This octree will be written to a FITS file.  It will probably be</span>
<span class="sd">    quite big, so use this function with caution!  Sunrise is a tool for</span>
<span class="sd">    generating synthetic spectra, available at</span>
<span class="sd">    http://sunrise.googlecode.com/ .</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : `Dataset`</span>
<span class="sd">       The dataset to convert.</span>
<span class="sd">    fn : string</span>
<span class="sd">       The filename of the output FITS file.</span>
<span class="sd">    fc : array</span>
<span class="sd">       The center of the extraction region</span>
<span class="sd">    fwidth  : array  </span>
<span class="sd">       Ensure this radius around the center is enclosed</span>
<span class="sd">       Array format is (nx,ny,nz) where each element is floating point</span>
<span class="sd">       in unitary position units where 0 is leftmost edge and 1</span>
<span class="sd">       the rightmost. </span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Note that the process of generating simulated images from Sunrise will</span>
<span class="sd">    require substantial user input; see the Sunrise wiki at</span>
<span class="sd">    http://sunrise.googlecode.com/ for more information.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>
    <span class="n">fwidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwidth</span><span class="p">)</span>
    
    <span class="c">#we must round the dle,dre to the nearest root grid cells</span>
    <span class="n">ile</span><span class="p">,</span><span class="n">ire</span><span class="p">,</span><span class="n">super_level</span><span class="p">,</span><span class="n">ncells_wide</span><span class="o">=</span> \
            <span class="n">round_ncells_wide</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">domain_dimensions</span><span class="p">,</span><span class="n">fc</span><span class="o">-</span><span class="n">fwidth</span><span class="p">,</span><span class="n">fc</span><span class="o">+</span><span class="n">fwidth</span><span class="p">,</span><span class="n">nwide</span><span class="o">=</span><span class="n">ncells_wide</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">ile</span><span class="o">-</span><span class="n">ire</span><span class="p">)</span><span class="o">==</span><span class="p">(</span><span class="n">ile</span><span class="o">-</span><span class="n">ire</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mylog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;rounding specified region:&quot;</span><span class="p">)</span>
    <span class="n">mylog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;from [</span><span class="si">%1.5f</span><span class="s"> </span><span class="si">%1.5f</span><span class="s"> </span><span class="si">%1.5f</span><span class="s">]-[</span><span class="si">%1.5f</span><span class="s"> </span><span class="si">%1.5f</span><span class="s"> </span><span class="si">%1.5f</span><span class="s">]&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">fc</span><span class="o">-</span><span class="n">fwidth</span><span class="p">)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">fc</span><span class="o">+</span><span class="n">fwidth</span><span class="p">)))</span>
    <span class="n">mylog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;to   [</span><span class="si">%07i</span><span class="s"> </span><span class="si">%07i</span><span class="s"> </span><span class="si">%07i</span><span class="s">]-[</span><span class="si">%07i</span><span class="s"> </span><span class="si">%07i</span><span class="s"> </span><span class="si">%07i</span><span class="s">]&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ile</span><span class="p">)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ire</span><span class="p">)))</span>
    <span class="n">fle</span><span class="p">,</span><span class="n">fre</span> <span class="o">=</span> <span class="n">ile</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">ds</span><span class="o">.</span><span class="n">domain_dimensions</span><span class="p">,</span> <span class="n">ire</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">ds</span><span class="o">.</span><span class="n">domain_dimensions</span>
    <span class="n">mylog</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;to   [</span><span class="si">%1.5f</span><span class="s"> </span><span class="si">%1.5f</span><span class="s"> </span><span class="si">%1.5f</span><span class="s">]-[</span><span class="si">%1.5f</span><span class="s"> </span><span class="si">%1.5f</span><span class="s"> </span><span class="si">%1.5f</span><span class="s">]&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">fle</span><span class="p">)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">fre</span><span class="p">)))</span>

    <span class="c">#Create a list of the star particle properties in PARTICLE_DATA</span>
    <span class="c">#Include ID, parent-ID, position, velocity, creation_mass, </span>
    <span class="c">#formation_time, mass, age_m, age_l, metallicity, L_bol</span>
    <span class="n">particle_data</span><span class="p">,</span><span class="n">nstars</span> <span class="o">=</span> <span class="n">prepare_star_particles</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">star_particle_type</span><span class="p">,</span><span class="n">fle</span><span class="o">=</span><span class="n">fle</span><span class="p">,</span><span class="n">fre</span><span class="o">=</span><span class="n">fre</span><span class="p">,</span>
                                           <span class="n">dd</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c">#Create the refinement hilbert octree in GRIDSTRUCTURE</span>
    <span class="c">#For every leaf (not-refined) cell we have a column n GRIDDATA</span>
    <span class="c">#Include mass_gas, mass_metals, gas_temp_m, gas_teff_m, cell_volume, SFR</span>
    <span class="c">#since the octree always starts with one cell, an our 0-level mesh</span>
    <span class="c">#may have many cells, we must create the octree region sitting </span>
    <span class="c">#ontop of the first mesh by providing a negative level</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">refinement</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">nleaf</span> <span class="o">=</span> <span class="n">prepare_octree</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ile</span><span class="p">,</span><span class="n">start_level</span><span class="o">=</span><span class="n">super_level</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span><span class="n">dd</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">fc</span><span class="p">)</span>

    <span class="n">create_fits_file</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span> <span class="n">refinement</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">particle_data</span><span class="p">,</span><span class="n">fle</span><span class="p">,</span><span class="n">fre</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fle</span><span class="p">,</span><span class="n">fre</span><span class="p">,</span><span class="n">ile</span><span class="p">,</span><span class="n">ire</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">nleaf</span><span class="p">,</span><span class="n">nstars</span>
</div>
<div class="viewcode-block" id="export_to_sunrise_from_halolist"><a class="viewcode-back" href="../../../../reference/api/generated/yt.analysis_modules.sunrise_export.sunrise_exporter.export_to_sunrise_from_halolist.html#yt.analysis_modules.sunrise_export.sunrise_exporter.export_to_sunrise_from_halolist">[docs]</a><span class="k">def</span> <span class="nf">export_to_sunrise_from_halolist</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">fni</span><span class="p">,</span><span class="n">star_particle_type</span><span class="p">,</span>
                                        <span class="n">halo_list</span><span class="p">,</span><span class="n">domains_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Using the center of mass and the virial radius</span>
<span class="sd">    for a halo, calculate the regions to extract for sunrise.</span>
<span class="sd">    The regions are defined on the root grid, and so individual</span>
<span class="sd">    octs may span a large range encompassing many halos</span>
<span class="sd">    and subhalos. Instead of repeating the oct extraction for each</span>
<span class="sd">    halo, arrange halos such that we only calculate what we need to.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : `Dataset`</span>
<span class="sd">        The dataset to convert. We use the root grid to specify the domain.</span>
<span class="sd">    fni : string</span>
<span class="sd">        The filename of the output FITS file, but depends on the domain. The</span>
<span class="sd">        dle and dre are appended to the name.</span>
<span class="sd">    particle_type : int</span>
<span class="sd">        The particle index for stars</span>
<span class="sd">    halo_list : list of halo objects</span>
<span class="sd">        The halo list objects must have halo.CoM and halo.Rvir,</span>
<span class="sd">        both of which are assumed to be in unitary length units.</span>
<span class="sd">    frvir (optional) : float</span>
<span class="sd">        Ensure that CoM +/- frvir*Rvir is contained within each domain</span>
<span class="sd">    domains_list (optiona): dict of halos</span>
<span class="sd">        Organize halos into a dict of domains. Keys are DLE/DRE tuple</span>
<span class="sd">        values are a list of halos</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">domain_dimensions</span>
    <span class="k">if</span> <span class="n">domains_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">domains_list</span> <span class="o">=</span> <span class="n">domains_from_halos</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">halo_list</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fni</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.fits&#39;</span><span class="p">):</span>
        <span class="n">fni</span> <span class="o">=</span> <span class="n">fni</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.fits&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">num_halos</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">halos</span><span class="p">)</span> <span class="ow">in</span> <span class="n">domains_list</span><span class="p">:</span>
        <span class="n">dle</span><span class="p">,</span><span class="n">dre</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;exporting: &#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%03i</span><span class="s"> </span><span class="si">%03i</span><span class="s"> </span><span class="si">%03i</span><span class="s">] -&quot;</span><span class="o">%</span><span class="nb">tuple</span><span class="p">(</span><span class="n">dle</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%03i</span><span class="s"> </span><span class="si">%03i</span><span class="s"> </span><span class="si">%03i</span><span class="s">] &quot;</span><span class="o">%</span><span class="nb">tuple</span><span class="p">(</span><span class="n">dre</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot; with </span><span class="si">%i</span><span class="s"> halos&quot;</span><span class="o">%</span><span class="n">num_halos</span><span class="p">)</span>
        <span class="n">dle</span><span class="p">,</span><span class="n">dre</span> <span class="o">=</span> <span class="n">domain</span>
        <span class="n">dle</span><span class="p">,</span> <span class="n">dre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dle</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dre</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">fni</span> 
        <span class="n">fn</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%03i</span><span class="s">_</span><span class="si">%03i</span><span class="s">_</span><span class="si">%03i</span><span class="s">-&quot;</span><span class="o">%</span><span class="nb">tuple</span><span class="p">(</span><span class="n">dle</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%03i</span><span class="s">_</span><span class="si">%03i</span><span class="s">_</span><span class="si">%03i</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">tuple</span><span class="p">(</span><span class="n">dre</span><span class="p">)</span>
        <span class="n">fnf</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="s">&#39;.fits&#39;</span>
        <span class="n">fnt</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="s">&#39;.halos&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fnt</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fnt</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fnt</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">halo</span> <span class="ow">in</span> <span class="n">halos</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%i</span><span class="s"> &quot;</span><span class="o">%</span><span class="n">halo</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%6.6e</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">halo</span><span class="o">.</span><span class="n">CoM</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;kpc&#39;</span><span class="p">]))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%6.6e</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">halo</span><span class="o">.</span><span class="n">CoM</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;kpc&#39;</span><span class="p">]))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%6.6e</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">halo</span><span class="o">.</span><span class="n">CoM</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;kpc&#39;</span><span class="p">]))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%6.6e</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">halo</span><span class="o">.</span><span class="n">Mvir</span><span class="p">))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%6.6e</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">halo</span><span class="o">.</span><span class="n">Rvir</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;kpc&#39;</span><span class="p">]))</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">export_to_sunrise</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">fnf</span><span class="p">,</span> <span class="n">star_particle_type</span><span class="p">,</span> <span class="n">dle</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">dn</span><span class="p">,</span> <span class="n">dre</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">dn</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">domains_from_halos</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">halo_list</span><span class="p">,</span><span class="n">frvir</span><span class="o">=</span><span class="mf">0.15</span><span class="p">):</span>
    <span class="n">domains</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">domain_dimensions</span>
    <span class="k">for</span> <span class="n">halo</span> <span class="ow">in</span> <span class="n">halo_list</span><span class="p">:</span>
        <span class="n">fle</span><span class="p">,</span> <span class="n">fre</span> <span class="o">=</span> <span class="n">halo</span><span class="o">.</span><span class="n">CoM</span><span class="o">-</span><span class="n">frvir</span><span class="o">*</span><span class="n">halo</span><span class="o">.</span><span class="n">Rvir</span><span class="p">,</span><span class="n">halo</span><span class="o">.</span><span class="n">CoM</span><span class="o">+</span><span class="n">frvir</span><span class="o">*</span><span class="n">halo</span><span class="o">.</span><span class="n">Rvir</span>
        <span class="n">dle</span><span class="p">,</span><span class="n">dre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">fle</span><span class="o">*</span><span class="n">dn</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">fre</span><span class="o">*</span><span class="n">dn</span><span class="p">)</span>
        <span class="n">dle</span><span class="p">,</span><span class="n">dre</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dle</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)),</span><span class="nb">tuple</span><span class="p">(</span><span class="n">dre</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dle</span><span class="p">,</span><span class="n">dre</span><span class="p">)</span> <span class="ow">in</span> <span class="n">domains</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">domains</span><span class="p">[(</span><span class="n">dle</span><span class="p">,</span><span class="n">dre</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">halo</span><span class="p">,</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">domains</span><span class="p">[(</span><span class="n">dle</span><span class="p">,</span><span class="n">dre</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">halo</span><span class="p">,]</span>
    <span class="c">#for niceness, let&#39;s process the domains in order of </span>
    <span class="c">#the one with the most halos</span>
    <span class="n">domains_list</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">domains</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
    <span class="n">domains_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> 
    <span class="n">domains_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span> <span class="c">#we want the most populated domains first</span>
    <span class="k">return</span> <span class="n">domains_list</span>

<span class="k">def</span> <span class="nf">prepare_octree</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ile</span><span class="p">,</span><span class="n">start_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">dd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">#we keep passing dd around to not regenerate the data all the time</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">all_data</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dd</span><span class="p">[</span><span class="s">&#39;MetalMass&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">add_fields</span><span class="p">()</span> <span class="c">#add the metal mass field that sunrise wants</span>
    <span class="k">def</span> <span class="nf">_temp_times_mass</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;Temperature&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s">&quot;CellMassMsun&quot;</span><span class="p">]</span>
    <span class="n">add_field</span><span class="p">(</span><span class="s">&quot;TemperatureTimesCellMassMsun&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">_temp_times_mass</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;CellMassMsun&quot;</span><span class="p">,</span><span class="s">&quot;TemperatureTimesCellMassMsun&quot;</span><span class="p">,</span> 
              <span class="s">&quot;MetalMass&quot;</span><span class="p">,</span><span class="s">&quot;CellVolumeCode&quot;</span><span class="p">]</span>
    
    <span class="c">#gather the field data from octs</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">get_pbar</span><span class="p">(</span><span class="s">&quot;Retrieving field data&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>
    <span class="n">field_data</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="k">for</span> <span class="n">fi</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">field_data</span> <span class="o">+=</span> <span class="n">dd</span><span class="p">[</span><span class="n">f</span><span class="p">],</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">field_data</span>

    <span class="c">#first we cast every cell as an oct</span>
    <span class="c">#ngrids = np.max([g.id for g in ds._grids])</span>
    <span class="n">grids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">levels_all</span> <span class="o">=</span> <span class="p">{}</span> 
    <span class="n">levels_finest</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span> 
        <span class="n">levels_finest</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">levels_all</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">get_pbar</span><span class="p">(</span><span class="s">&quot;Initializing octs &quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">grids</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">gi</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">grids</span><span class="p">):</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>
        <span class="n">og</span> <span class="o">=</span> <span class="n">amr_utils</span><span class="o">.</span><span class="n">OctreeGrid</span><span class="p">(</span>
                <span class="n">g</span><span class="o">.</span><span class="n">child_index_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">),</span>
                <span class="n">ff</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&quot;float64&quot;</span><span class="p">),</span>
                <span class="n">g</span><span class="o">.</span><span class="n">LeftEdge</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&quot;float64&quot;</span><span class="p">),</span>
                <span class="n">g</span><span class="o">.</span><span class="n">ActiveDimensions</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&quot;int32&quot;</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float64&quot;</span><span class="p">)</span><span class="o">*</span><span class="n">g</span><span class="o">.</span><span class="n">dds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">g</span><span class="o">.</span><span class="n">Level</span><span class="p">,</span>
                <span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">grids</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">og</span>
        <span class="c">#how many refinement cells will we have?</span>
        <span class="c">#measure the &#39;volume&#39; of each mesh, but many</span>
        <span class="c">#cells do not exist. an overstimate</span>
        <span class="n">levels_all</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">Level</span><span class="p">]</span> <span class="o">+=</span> <span class="n">g</span><span class="o">.</span><span class="n">ActiveDimensions</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="c">#how many leaves do we have?</span>
        <span class="c">#this overestimates. a child of -1 means no child,</span>
        <span class="c">#but that cell may still be expanded on a submesh because</span>
        <span class="c">#(at least in ART) the meshes are inefficient.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">clear_data</span><span class="p">()</span>
        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    
    <span class="c">#create the octree grid list</span>
    <span class="c">#oct_list =  amr_utils.OctreeGridList(grids)</span>
    
    <span class="c">#initialize arrays to be passed to the recursion algo</span>
    <span class="n">o_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">levels_all</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">r_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">levels_all</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">output</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">o_length</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">refined</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">levels</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">ids</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">position</span><span class="p">()</span>
    <span class="n">hs</span>       <span class="o">=</span> <span class="n">hilbert_state</span><span class="p">()</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">printing</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">print_oct</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printing</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">get_pbar</span><span class="p">(</span><span class="s">&quot;Building Hilbert DFO octree&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">refined</span><span class="p">))</span>
    <span class="n">RecurseOctreeDepthFirstHilbert</span><span class="p">(</span>
            <span class="n">ile</span><span class="p">,</span>
            <span class="n">pos</span><span class="p">,</span>
            <span class="n">grids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="c">#we always start on the root grid</span>
            <span class="n">hs</span><span class="p">,</span> 
            <span class="n">output</span><span class="p">,</span><span class="n">refined</span><span class="p">,</span><span class="n">levels</span><span class="p">,</span>
            <span class="n">grids</span><span class="p">,</span>
            <span class="n">start_level</span><span class="p">,</span>
            <span class="n">ids</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">printing</span><span class="p">,</span>
            <span class="n">tracker</span><span class="o">=</span><span class="n">pbar</span><span class="p">)</span>
    <span class="n">pbar</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="c">#by time we get it here the &#39;current&#39; position is actually </span>
    <span class="c">#for the next spot, so we&#39;re off by 1</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;took </span><span class="si">%1.2e</span><span class="s"> seconds&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;refinement tree # of cells </span><span class="si">%i</span><span class="s">, # of leaves </span><span class="si">%i</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="p">,</span><span class="n">pos</span><span class="o">.</span><span class="n">output_pos</span><span class="p">))</span> 
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;first few entries :&#39;</span><span class="p">,</span><span class="n">refined</span><span class="p">[:</span><span class="mi">12</span><span class="p">])</span>
    <span class="n">output</span>  <span class="o">=</span> <span class="n">output</span><span class="p">[:</span><span class="n">pos</span><span class="o">.</span><span class="n">output_pos</span><span class="p">]</span>
    <span class="n">refined</span> <span class="o">=</span> <span class="n">refined</span><span class="p">[:</span><span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="p">]</span> 
    <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[:</span><span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="p">]</span> 
    <span class="k">return</span> <span class="n">output</span><span class="p">,</span><span class="n">refined</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span>

<span class="k">def</span> <span class="nf">print_oct</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">nd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">nc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;cell_index&#39;</span><span class="p">]</span>
    <span class="n">l</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;level&#39;</span><span class="p">]</span>
    <span class="n">g</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;grid&#39;</span><span class="p">]</span>
    <span class="n">o</span>  <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">offset</span>
    <span class="n">fle</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">left_edges</span><span class="o">+</span><span class="n">g</span><span class="o">.</span><span class="n">dx</span><span class="o">*</span><span class="n">ci</span>
    <span class="n">fre</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">left_edges</span><span class="o">+</span><span class="n">g</span><span class="o">.</span><span class="n">dx</span><span class="o">*</span><span class="p">(</span><span class="n">ci</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fle</span> <span class="o">*=</span> <span class="n">nd</span>
        <span class="n">fre</span> <span class="o">*=</span> <span class="n">nd</span>
        <span class="k">if</span> <span class="n">nc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fle</span> <span class="o">-=</span> <span class="n">nc</span>
            <span class="n">fre</span> <span class="o">-=</span> <span class="n">nc</span>
    <span class="n">txt</span>  <span class="o">=</span> <span class="s">&#39;</span><span class="si">%+1i</span><span class="s"> &#39;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%+1i</span><span class="s"> &#39;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%+1.3f</span><span class="s"> &#39;</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="s">&#39;- &#39;</span>
    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%+1.3f</span><span class="s"> &#39;</span><span class="o">*</span><span class="mi">3</span>
    <span class="k">if</span> <span class="n">l</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">txt</span><span class="o">%</span><span class="p">((</span><span class="n">l</span><span class="p">,)</span><span class="o">+</span><span class="p">(</span><span class="n">o</span><span class="p">,)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">fle</span><span class="p">)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">fre</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">RecurseOctreeDepthFirstHilbert</span><span class="p">(</span><span class="n">cell_index</span><span class="p">,</span> <span class="c">#integer (rep as a float) on the [grid_index]</span>
                            <span class="n">pos</span><span class="p">,</span> <span class="c">#the output hydro data position and refinement position</span>
                            <span class="n">grid</span><span class="p">,</span>  <span class="c">#grid that this oct lives on (not its children)</span>
                            <span class="n">hilbert</span><span class="p">,</span>  <span class="c">#the hilbert state</span>
                            <span class="n">output</span><span class="p">,</span> <span class="c">#holds the hydro data</span>
                            <span class="n">refined</span><span class="p">,</span> <span class="c">#holds the refinement status  of Octs, 0s and 1s</span>
                            <span class="n">levels</span><span class="p">,</span> <span class="c">#For a given Oct, what is the level</span>
                            <span class="n">grids</span><span class="p">,</span> <span class="c">#list of all patch grids available to us</span>
                            <span class="n">level</span><span class="p">,</span> <span class="c">#starting level of the oct (not the children)</span>
                            <span class="n">ids</span><span class="p">,</span> <span class="c">#record the oct ID</span>
                            <span class="n">debug</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">tracker</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tracker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="o">%</span><span class="mi">1000</span> <span class="o">==</span> <span class="mi">500</span> <span class="p">:</span> <span class="n">tracker</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> 
        <span class="n">debug</span><span class="p">(</span><span class="nb">vars</span><span class="p">())</span>
    <span class="n">child_grid_index</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">child_indices</span><span class="p">[</span><span class="n">cell_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cell_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">cell_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="c">#record the refinement state</span>
    <span class="n">levels</span><span class="p">[</span><span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="p">]</span>  <span class="o">=</span> <span class="n">level</span>
    <span class="n">is_leaf</span> <span class="o">=</span> <span class="p">(</span><span class="n">child_grid_index</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">level</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">refined</span><span class="p">[</span><span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_leaf</span> <span class="c">#True is oct, False is leaf</span>
    <span class="n">ids</span><span class="p">[</span><span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_grid_index</span> <span class="c">#True is oct, False is leaf</span>
    <span class="n">pos</span><span class="o">.</span><span class="n">refined_pos</span><span class="o">+=</span> <span class="mi">1</span> 
    <span class="k">if</span> <span class="n">is_leaf</span><span class="p">:</span> <span class="c">#never subdivide if we are on a superlevel</span>
        <span class="c">#then we have hit a leaf cell; write it out</span>
        <span class="k">for</span> <span class="n">field_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">output</span><span class="p">[</span><span class="n">pos</span><span class="o">.</span><span class="n">output_pos</span><span class="p">,</span><span class="n">field_index</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">grid</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_index</span><span class="p">,</span><span class="n">cell_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cell_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">cell_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">pos</span><span class="o">.</span><span class="n">output_pos</span><span class="o">+=</span> <span class="mi">1</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">child_grid_index</span><span class="o">&gt;-</span><span class="mi">1</span>
        <span class="c">#find the grid we descend into</span>
        <span class="c">#then find the eight cells we break up into</span>
        <span class="n">subgrid</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">child_grid_index</span><span class="p">]</span>
        <span class="c">#calculate the floating point LE of the children</span>
        <span class="c">#then translate onto the subgrid integer index </span>
        <span class="n">parent_fle</span>  <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">left_edges</span> <span class="o">+</span> <span class="n">cell_index</span><span class="o">*</span><span class="n">grid</span><span class="o">.</span><span class="n">dx</span>
        <span class="n">subgrid_ile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">parent_fle</span> <span class="o">-</span> <span class="n">subgrid</span><span class="o">.</span><span class="n">left_edges</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid</span><span class="o">.</span><span class="n">dx</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">vertex</span><span class="p">,</span> <span class="n">hilbert_child</span><span class="p">)</span> <span class="ow">in</span> <span class="n">hilbert</span><span class="p">:</span>
            <span class="c">#vertex is a combination of three 0s and 1s to </span>
            <span class="c">#denote each of the 8 octs</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">subgrid</span> <span class="o">=</span> <span class="n">grid</span> <span class="c">#we don&#39;t actually descend if we&#39;re a superlevel</span>
                <span class="c">#child_ile = cell_index + np.array(vertex)*2**(-level)</span>
                <span class="n">child_ile</span> <span class="o">=</span> <span class="n">cell_index</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vertex</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">child_ile</span> <span class="o">=</span> <span class="n">child_ile</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">child_ile</span> <span class="o">=</span> <span class="n">subgrid_ile</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vertex</span><span class="p">)</span>
                <span class="n">child_ile</span> <span class="o">=</span> <span class="n">child_ile</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>

            <span class="n">RecurseOctreeDepthFirstHilbert</span><span class="p">(</span><span class="n">child_ile</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">subgrid</span><span class="p">,</span><span class="n">hilbert_child</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">refined</span><span class="p">,</span><span class="n">levels</span><span class="p">,</span><span class="n">grids</span><span class="p">,</span>
                <span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span><span class="n">tracker</span><span class="o">=</span><span class="n">tracker</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">create_fits_file</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span> <span class="n">refined</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">particle_data</span><span class="p">,</span><span class="n">fle</span><span class="p">,</span><span class="n">fre</span><span class="p">):</span>
    <span class="c">#first create the grid structure</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;structure&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">refined</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&quot;bool&quot;</span><span class="p">))</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">([</span><span class="n">structure</span><span class="p">])</span>
    <span class="n">st_table</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">st_table</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GRIDSTRUCTURE&quot;</span>
    <span class="n">st_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;hierarch lengthunit&quot;</span><span class="p">,</span> <span class="s">&quot;kpc&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&quot;Length unit for grid&quot;</span><span class="p">)</span>
    <span class="n">fdx</span> <span class="o">=</span> <span class="n">fre</span><span class="o">-</span><span class="n">fle</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s">&#39;xyz&#39;</span><span class="p">):</span>
        <span class="n">st_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;min</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="p">,</span> <span class="n">fle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ds</span><span class="p">[</span><span class="s">&#39;kpc&#39;</span><span class="p">])</span>
        <span class="n">st_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;max</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="p">,</span> <span class="n">fre</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">ds</span><span class="p">[</span><span class="s">&#39;kpc&#39;</span><span class="p">])</span>
        <span class="n">st_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="p">,</span> <span class="n">fdx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">st_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;subdiv</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">st_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;subdivtp&quot;</span><span class="p">,</span> <span class="s">&quot;OCTREE&quot;</span><span class="p">,</span> <span class="s">&quot;Type of grid subdivision&quot;</span><span class="p">)</span>

    <span class="c">#not the hydro grid data</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;CellMassMsun&quot;</span><span class="p">,</span><span class="s">&quot;TemperatureTimesCellMassMsun&quot;</span><span class="p">,</span> 
              <span class="s">&quot;MetalMass&quot;</span><span class="p">,</span><span class="s">&quot;CellVolumeCode&quot;</span><span class="p">]</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span> 
        <span class="n">fd</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">=</span><span class="n">output</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">output</span>
    <span class="n">col_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s">&quot;CellMassMsun&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">tm</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="s">&quot;CellMassMsun&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;mass_gas&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">,</span>
                    <span class="n">array</span><span class="o">=</span><span class="n">fd</span><span class="p">[</span><span class="s">&#39;CellMassMsun&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;Msun&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;mass_metals&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">,</span>
                    <span class="n">array</span><span class="o">=</span><span class="n">fd</span><span class="p">[</span><span class="s">&#39;MetalMass&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;Msun&quot;</span><span class="p">))</span>
    <span class="c"># col_list.append(pyfits.Column(&quot;mass_stars&quot;, format=&#39;D&#39;,</span>
    <span class="c">#                 array=np.zeros(size,dtype=&#39;D&#39;),unit=&quot;Msun&quot;))</span>
    <span class="c"># col_list.append(pyfits.Column(&quot;mass_stellar_metals&quot;, format=&#39;D&#39;,</span>
    <span class="c">#                 array=np.zeros(size,dtype=&#39;D&#39;),unit=&quot;Msun&quot;))</span>
    <span class="c"># col_list.append(pyfits.Column(&quot;age_m&quot;, format=&#39;D&#39;,</span>
    <span class="c">#                 array=np.zeros(size,dtype=&#39;D&#39;),unit=&quot;yr*Msun&quot;))</span>
    <span class="c"># col_list.append(pyfits.Column(&quot;age_l&quot;, format=&#39;D&#39;,</span>
    <span class="c">#                 array=np.zeros(size,dtype=&#39;D&#39;),unit=&quot;yr*Msun&quot;))</span>
    <span class="c"># col_list.append(pyfits.Column(&quot;L_bol&quot;, format=&#39;D&#39;,</span>
    <span class="c">#                 array=np.zeros(size,dtype=&#39;D&#39;)))</span>
    <span class="c"># col_list.append(pyfits.Column(&quot;L_lambda&quot;, format=&#39;D&#39;,</span>
    <span class="c">#                 array=np.zeros(size,dtype=&#39;D&#39;)))</span>
    <span class="c"># The units for gas_temp are really K*Msun. For older Sunrise versions</span>
    <span class="c"># you must set the unit to just K  </span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;gas_temp_m&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">,</span>
                    <span class="n">array</span><span class="o">=</span><span class="n">fd</span><span class="p">[</span><span class="s">&#39;TemperatureTimesCellMassMsun&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;K*Msun&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;gas_teff_m&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">,</span>
                    <span class="n">array</span><span class="o">=</span><span class="n">fd</span><span class="p">[</span><span class="s">&#39;TemperatureTimesCellMassMsun&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;K*Msun&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;cell_volume&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">,</span>
                    <span class="n">array</span><span class="o">=</span><span class="n">fd</span><span class="p">[</span><span class="s">&#39;CellVolumeCode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float64&#39;</span><span class="p">)</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;kpc&#39;</span><span class="p">]</span><span class="o">**</span><span class="mf">3.0</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="s">&quot;kpc^3&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;SFR&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">,</span>
                    <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;D&#39;</span><span class="p">)))</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">(</span><span class="n">col_list</span><span class="p">)</span>
    <span class="n">mg_table</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">mg_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;M_g_tot&quot;</span><span class="p">,</span> <span class="n">tm</span><span class="p">)</span>
    <span class="n">mg_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;timeunit&quot;</span><span class="p">,</span> <span class="s">&quot;yr&quot;</span><span class="p">)</span>
    <span class="n">mg_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;tempunit&quot;</span><span class="p">,</span> <span class="s">&quot;K&quot;</span><span class="p">)</span>
    <span class="n">mg_table</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GRIDDATA&quot;</span>

    <span class="c"># Add a dummy Primary; might be a better way to do this!</span>
    <span class="n">col_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;dummy&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float32&#39;</span><span class="p">))]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">(</span><span class="n">col_list</span><span class="p">)</span>
    <span class="n">md_table</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">md_table</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&quot;snaptime&quot;</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">current_time</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;years&#39;</span><span class="p">])</span>
    <span class="n">md_table</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;YT&quot;</span>

    <span class="n">phdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">()</span>
    <span class="n">phdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;nbodycod&#39;</span><span class="p">,</span><span class="s">&#39;yt&#39;</span><span class="p">)</span>
    <span class="n">hls</span> <span class="o">=</span> <span class="p">[</span><span class="n">phdu</span><span class="p">,</span> <span class="n">st_table</span><span class="p">,</span> <span class="n">mg_table</span><span class="p">,</span><span class="n">md_table</span><span class="p">]</span>
    <span class="n">hls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particle_data</span><span class="p">)</span>
    <span class="n">hdus</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">hls</span><span class="p">)</span>
    <span class="n">hdus</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">nearest_power</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c">#round to the nearest power of 2</span>
    <span class="n">x</span><span class="o">-=</span><span class="mi">1</span>
    <span class="n">x</span> <span class="o">|=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
    <span class="n">x</span> <span class="o">|=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> 
    <span class="n">x</span> <span class="o">|=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span>
    <span class="n">x</span> <span class="o">|=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>
    <span class="n">x</span> <span class="o">|=</span> <span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
    <span class="n">x</span><span class="o">+=</span><span class="mi">1</span> 
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">round_ncells_wide</span><span class="p">(</span><span class="n">dds</span><span class="p">,</span><span class="n">fle</span><span class="p">,</span><span class="n">fre</span><span class="p">,</span><span class="n">nwide</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">fc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fle</span><span class="o">+</span><span class="n">fre</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">fle</span> <span class="o">&lt;</span> <span class="n">fc</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">fre</span> <span class="o">&gt;</span> <span class="n">fc</span><span class="p">)</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">fc</span><span class="o">*</span><span class="n">dds</span><span class="p">)</span> <span class="c">#nearest vertex to the center</span>
    <span class="n">ile</span><span class="p">,</span><span class="n">ire</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">),</span><span class="n">ic</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">cfle</span><span class="p">,</span><span class="n">cfre</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">fc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c">#just a random non-equal array</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">nwide</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">#expand until borders are included and</span>
        <span class="c">#we have an equaly-sized, non-zero box</span>
        <span class="n">idxq</span><span class="p">,</span><span class="n">out</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">out</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">idxq</span><span class="p">:</span>
            <span class="n">cfle</span><span class="p">,</span><span class="n">cfre</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="n">fc</span><span class="o">+</span><span class="n">width</span>
            <span class="n">ile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">cfle</span><span class="o">*</span><span class="n">dds</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">ire</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">cfre</span><span class="o">*</span><span class="n">dds</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">ire</span><span class="o">-</span><span class="n">ile</span>
            <span class="n">width</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">/</span><span class="n">dds</span>
            <span class="c">#quit if idxq is true:</span>
            <span class="n">idxq</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">idx</span><span class="o">==</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">out</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">fle</span><span class="o">&gt;</span><span class="n">cfle</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">fre</span><span class="o">&lt;</span><span class="n">cfre</span><span class="p">)</span> 
            <span class="n">out</span> <span class="o">&amp;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">&lt;</span><span class="mf">1e-5</span> <span class="c">#nwide should be a power of 2</span>
            <span class="k">assert</span> <span class="n">width</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.1</span> <span class="c">#can&#39;t go larger than the simulation volume</span>
        <span class="n">nwide</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#expand until we are nwide cells span</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">idx</span><span class="o">==</span><span class="n">nwide</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">idx</span><span class="o">&lt;=</span><span class="n">nwide</span><span class="p">)</span>
            <span class="n">cfle</span><span class="p">,</span><span class="n">cfre</span> <span class="o">=</span> <span class="n">fc</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="n">fc</span><span class="o">+</span><span class="n">width</span>
            <span class="n">ile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">cfle</span><span class="o">*</span><span class="n">dds</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">ire</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">cfre</span><span class="o">*</span><span class="n">dds</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">ire</span><span class="o">-</span><span class="n">ile</span>
            <span class="n">width</span> <span class="o">+=</span> <span class="mf">1e-2</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">dds</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">idx</span><span class="o">==</span><span class="n">nwide</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="n">maxlevel</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">nwide</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">nwide</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">nwide</span><span class="p">)))</span><span class="o">&lt;</span><span class="mf">1e-5</span> <span class="c">#nwide should be a power of 2</span>
    <span class="k">return</span> <span class="n">ile</span><span class="p">,</span><span class="n">ire</span><span class="p">,</span><span class="n">maxlevel</span><span class="p">,</span><span class="n">nwide</span>

<span class="k">def</span> <span class="nf">round_nearest_edge</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">fle</span><span class="p">,</span><span class="n">fre</span><span class="p">):</span>
    <span class="n">dds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">domain_dimensions</span>
    <span class="n">ile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">fle</span><span class="o">*</span><span class="n">dds</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">ire</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">fre</span><span class="o">*</span><span class="n">dds</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span> 
    
    <span class="c">#this is the number of cells the super octree needs to expand to</span>
    <span class="c">#must round to the nearest power of 2</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ire</span><span class="o">-</span><span class="n">ile</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">nearest_power</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
    
    <span class="n">maxlevel</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">width</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ile</span><span class="p">,</span><span class="n">ire</span><span class="p">,</span><span class="n">maxlevel</span>

<span class="k">def</span> <span class="nf">prepare_star_particles</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">star_type</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">vel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">creation_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">initial_mass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">current_mass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">metallicity</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">radius</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                          <span class="n">fle</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span><span class="n">fre</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span>
                          <span class="n">dd</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">all_data</span><span class="p">()</span>
    <span class="n">idxst</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s">&quot;particle_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">star_type</span>

    <span class="c">#make sure we select more than a single particle</span>
    <span class="k">assert</span> <span class="n">na</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idxst</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dd</span><span class="p">[</span><span class="s">&quot;particle_position_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ax</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="s">&#39;xyz&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">idxst</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">pos</span><span class="o">&gt;</span><span class="n">fle</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">pos</span><span class="o">&lt;</span><span class="n">fre</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;kpc&#39;</span><span class="p">]</span> <span class="c">#unitary units -&gt; kpc</span>
    <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s">&quot;particle_age&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;years&#39;</span><span class="p">]</span> <span class="c"># seconds-&gt;years</span>
    <span class="k">if</span> <span class="n">vel</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dd</span><span class="p">[</span><span class="s">&quot;particle_velocity_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ax</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="s">&#39;xyz&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="c"># Velocity is cm/s, we want it to be kpc/yr</span>
        <span class="c">#vel *= (ds[&quot;kpc&quot;]/ds[&quot;cm&quot;]) / (365*24*3600.)</span>
        <span class="n">vel</span> <span class="o">*=</span> <span class="n">kpc_per_cm</span> <span class="o">*</span> <span class="n">sec_per_year</span>
    <span class="k">if</span> <span class="n">initial_mass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">#in solar masses</span>
        <span class="n">initial_mass</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s">&quot;particle_mass_initial&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;Msun&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">current_mass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">#in solar masses</span>
        <span class="n">current_mass</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s">&quot;particle_mass&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;Msun&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">metallicity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c">#this should be in dimensionless units, metals mass / particle mass</span>
        <span class="n">metallicity</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s">&quot;particle_metallicity&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">metallicity</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">initial_mass</span><span class="o">*</span><span class="mf">0.0</span><span class="o">+</span><span class="mf">10.0</span><span class="o">/</span><span class="mf">1000.0</span> <span class="c">#10pc radius</span>
    <span class="n">formation_time</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">current_time</span><span class="o">*</span><span class="n">ds</span><span class="p">[</span><span class="s">&#39;years&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">age</span>
    <span class="c">#create every column</span>
    <span class="n">col_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;ID&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;J&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">current_mass</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">)))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;parent_ID&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;J&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">current_mass</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;int32&#39;</span><span class="p">)))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;position&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;3D&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;kpc&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;velocity&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;3D&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">vel</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;kpc/yr&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;creation_mass&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">initial_mass</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;Msun&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;formation_time&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">formation_time</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;yr&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;radius&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;kpc&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;mass&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">current_mass</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;Msun&quot;</span><span class="p">))</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="n">age</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s">&#39;yr&#39;</span><span class="p">))</span>
    <span class="c">#For particles, Sunrise takes </span>
    <span class="c">#the dimensionless metallicity, not the mass of the metals</span>
    <span class="n">col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyfits</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s">&quot;metallicity&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&quot;D&quot;</span><span class="p">,</span>
        <span class="n">array</span><span class="o">=</span><span class="n">metallicity</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s">&quot;Msun&quot;</span><span class="p">))</span> 
    
    <span class="c">#make the table</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">ColDefs</span><span class="p">(</span><span class="n">col_list</span><span class="p">)</span>
    <span class="n">pd_table</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">new_table</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">pd_table</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PARTICLEDATA&quot;</span>
    
    <span class="c">#make sure we have nonzero particle number</span>
    <span class="k">assert</span> <span class="n">pd_table</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="k">return</span> <span class="n">pd_table</span><span class="p">,</span><span class="n">na</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_fields</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Add three Eulerian fields Sunrise uses&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_MetalMass</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;Metallicity&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;CellMassMsun&quot;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">_convMetalMass</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.0</span>
    <span class="n">add_field</span><span class="p">(</span><span class="s">&quot;MetalMass&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">_MetalMass</span><span class="p">,</span>
              <span class="n">convert_function</span><span class="o">=</span><span class="n">_convMetalMass</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_initial_mass_cen_ostriker</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c"># SFR in a cell. This assumes stars were created by the Cen &amp; Ostriker algorithm</span>
        <span class="c"># Check Grid_AddToDiskProfile.C and star_maker7.src</span>
        <span class="n">star_mass_ejection_fraction</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s">&quot;StarMassEjectionFraction&quot;</span><span class="p">,</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">star_maker_minimum_dynamical_time</span> <span class="o">=</span> <span class="mf">3e6</span> <span class="c"># years, which will get divided out</span>
        <span class="n">dtForSFR</span> <span class="o">=</span> <span class="n">star_maker_minimum_dynamical_time</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s">&quot;years&quot;</span><span class="p">]</span>
        <span class="n">xv1</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s">&quot;InitialTime&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;creation_time&quot;</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;dynamical_time&quot;</span><span class="p">])</span>
        <span class="n">xv2</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="s">&quot;InitialTime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dtForSFR</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;creation_time&quot;</span><span class="p">])</span>
                <span class="o">/</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;dynamical_time&quot;</span><span class="p">])</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">star_mass_ejection_fraction</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">xv1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xv1</span><span class="p">)))</span>
        <span class="n">minitial</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;ParticleMassMsun&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="k">return</span> <span class="n">minitial</span>

    <span class="n">add_field</span><span class="p">(</span><span class="s">&quot;InitialMassCenOstriker&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">_initial_mass_cen_ostriker</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">position</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refined_pos</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">class</span> <span class="nc">hilbert_state</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sgn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">octant</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sgn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">sgn</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">octant</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">octant</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="o">=</span> <span class="n">sgn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">octant</span> <span class="o">=</span> <span class="n">octant</span>
    <span class="k">def</span> <span class="nf">flip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*=-</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">temp</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span>
    <span class="k">def</span> <span class="nf">reorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> 
        <span class="n">nsgn</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">ndim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span> <span class="o">=</span> <span class="n">nsgn</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hilbert_state</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                             <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">octant</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">descend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">o</span><span class="p">):</span>
        <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">child</span><span class="o">.</span><span class="n">octant</span> <span class="o">=</span> <span class="n">o</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">o</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">o</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">o</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">o</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">o</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">o</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">o</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">child</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vertex</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">vertex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">yield</span> <span class="n">vertex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">vertex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">yield</span> <span class="n">vertex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">vertex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
        <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">yield</span> <span class="n">vertex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">vertex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">yield</span> <span class="n">vertex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">vertex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> 
        <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">yield</span> <span class="n">vertex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">vertex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">yield</span> <span class="n">vertex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">vertex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
        <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">yield</span> <span class="n">vertex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">vertex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sgn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
        <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">yield</span> <span class="n">vertex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descend</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
</pre></div>

    </div>
      
  </div>
</div>
    <div class="footer">
      &copy; Copyright 2013, the yt Project.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>