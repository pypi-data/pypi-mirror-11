<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Two Point Functions &mdash; The yt Project 3.2-dev documentation</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootswatch-3.3.4/readable/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.2-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="The yt Project 3.2-dev documentation" href="../../index.html" />
    <link rel="up" title="Topic-Specific Analysis Modules" href="index.html" />
    <link rel="next" title="Clump Finding" href="clump_finding.html" />
    <link rel="prev" title="Exporting to RADMC-3D" href="radmc3d_export.html" />
    
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-391373-2']);
      _gaq.push(['_setDomainName', 'yt-project.org']);
      _gaq.push(['_setAllowHash', false]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><img src="../../_static/yt_icon.png">
          The yt Project</a>
        <span class="navbar-text navbar-version pull-left"><b>3.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../help/index.html">How to get help</a></li>
                <li><a href="../../quickstart/index.html">Quickstart notebooks</a></li>
                <li><a href="../../cookbook/index.html">Cookbook</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installing.html">Getting and Installing yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installing.html#getting-yt">Getting yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installing.html#testing-your-installation">Testing Your Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installing.html#switching-between-yt-2-x-and-yt-3-x">Switching between yt-2.x and yt-3.x</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">yt Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/data_inspection.html">Data Inspection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/simple_visualization.html">Simple Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/data_objects_and_time_series.html">Data Objects and Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/derived_fields_and_profiles.html">Derived Fields and Profiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/volume_rendering.html">Volume Rendering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../yt3differences.html">What&#8217;s New and Different in yt 3.0?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../yt3differences.html#updating-to-yt-3-0-from-old-versions-and-going-back">Updating to yt 3.0 from Old Versions (and going back)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../yt3differences.html#converting-old-scripts-to-work-with-yt-3-0">Converting Old Scripts to Work with yt 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../yt3differences.html#cool-new-things">Cool New Things</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../yt3differences.html#api-changes">API Changes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbook/index.html">The Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#getting-the-sample-data">Getting the Sample Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#example-scripts">Example Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#example-notebooks">Example Notebooks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../visualizing/index.html">Visualizing Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/plots.html">How to Make Plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/callbacks.html">Plot Modifications: Overplotting Contours, Velocities, Particles, and More</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/manual_plotting.html">Using the Manual Plotting Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/volume_rendering.html">Volume Rendering: Making 3D Photorealistic Isocontoured Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/hardware_volume_rendering.html">Hardware Volume Rendering on NVidia Graphics cards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/sketchfab.html">3D Surfaces and Sketchfab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/mapserver.html">Mapserver - A Google-Maps-like Interface to your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/streamlines.html">Streamlines: Tracking the Trajectories of Tracers in your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/colormaps/index.html">Colormaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/writing_fits_images.html">Writing FITS Images</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">General Data Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../fields.html">Fields in yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_derived_fields.html">Creating Derived Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../objects.html">Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../units/index.html">Symbolic Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filtering.html">Filtering your Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generating_processed_data.html">Generating Processed Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../time_series_analysis.html">Time Series Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parallel_computation.html">Parallel Computation With yt</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Topic-Specific Analysis Modules</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="halo_analysis.html">Halo Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="synthetic_observation.html">Synthetic Observation</a></li>
<li class="toctree-l2"><a class="reference internal" href="exporting.html">Exporting to External Radiation Transport Codes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Two Point Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="clump_finding.html">Clump Finding</a></li>
<li class="toctree-l2"><a class="reference internal" href="particle_trajectories.html">Particle Trajectories</a></li>
<li class="toctree-l2"><a class="reference internal" href="ellipsoid_analysis.html">Halo Ellipsoid Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examining/index.html">Loading and Examining Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examining/loading_data.html">Loading Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examining/generic_array_data.html">Loading Generic Array Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examining/generic_particle_data.html">Loading Generic Particle Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examining/spherical_data.html">Loading Spherical Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examining/low_level_inspection.html">Low-Level Data Inspection: Accessing Raw Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/index.html">Developing in yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developing/intro.html">Getting Involved</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/developing.html">How to Develop yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/building_the_docs.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/debugdrive.html">Debugging yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_datatypes.html">Creating Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_derived_fields.html">Creating Derived Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_derived_quantities.html">Creating Derived Quantities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_frontend.html">Creating A New Code Frontend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/external_analysis.html">Using yt with External Analysis Tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference Materials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/code_support.html">Code Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/command-line.html">Command-Line Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/api/api.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/configuration.html">Customizing yt: The Configuration and Plugin Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/field_list.html">Field List</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/changelog.html">ChangeLog</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#version-installation">Version &amp; Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#code-errors-and-failures">Code Errors and Failures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#units">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#fields">Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#data-objects">Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#developing">Developing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../help/index.html">Getting Help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#don-t-panic-and-don-t-give-up">Don&#8217;t panic and don&#8217;t give up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#update-to-the-latest-version">Update to the latest version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#search-the-documentation-faq-and-mailing-lists">Search the documentation, FAQ, and mailing lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#look-at-the-source-code">Look at the source code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#isolate-and-document-your-problem">Isolate and document your problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#go-on-irc-to-ask-a-question">Go on IRC to ask a question</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#ask-the-mailing-list">Ask the mailing list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#submit-a-bug-report">Submit a bug report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#special-issues">Special Issues</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#what-is-yt">What is yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#who-is-yt">Who is yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#history-of-yt">History of yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#how-do-i-contact-yt">How do I contact yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#how-do-i-cite-yt">How do I cite yt?</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Two Point Functions</a><ul>
<li><a class="reference internal" href="#requirements">Requirements</a></li>
<li><a class="reference internal" href="#quick-example">Quick Example</a></li>
<li><a class="reference internal" href="#probability-distribution-function">Probability Distribution Function</a></li>
<li><a class="reference internal" href="#how-it-works">How It Works</a></li>
<li><a class="reference internal" href="#a-step-by-step-overview">A Step By Step Overview</a><ul>
<li><a class="reference internal" href="#define-functions">Define Functions</a></li>
<li><a class="reference internal" href="#create-the-two-point-function-generator-object">Create the Two Point Function Generator Object</a></li>
<li><a class="reference internal" href="#add-functions">Add Functions</a></li>
<li><a class="reference internal" href="#set-pdf-parameters">Set PDF Parameters</a></li>
<li><a class="reference internal" href="#run-the-tpf">Run the TPF</a></li>
<li><a class="reference internal" href="#output-the-results">Output the Results</a></li>
</ul>
</li>
<li><a class="reference internal" href="#strategies-for-computational-efficiency">Strategies for Computational Efficiency</a></li>
<li><a class="reference internal" href="#advanced-two-point-function-techniques">Advanced Two Point Function Techniques</a><ul>
<li><a class="reference internal" href="#density-threshold">Density Threshold</a></li>
<li><a class="reference internal" href="#multidimensional-pdfs">Multidimensional PDFs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#two-point-correlation-functions">Two-Point Correlation Functions</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="two-point-functions">
<span id="id1"></span><h1>Two Point Functions<a class="headerlink" href="#two-point-functions" title="Permalink to this headline">¶</a></h1>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.7.</span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As of <code class="code docutils literal"><span class="pre">yt-3.0</span></code>, the two point function analysis module is not
currently functional.  This functionality is still available in
<code class="code docutils literal"><span class="pre">yt-2.x</span></code>.  If you would like to use these features in <code class="code docutils literal"><span class="pre">yt-3.x</span></code>,
help is needed to port them over.  Contact the yt-users mailing list if you
are interested in doing this.</p>
</div>
<p>The Two Point Functions framework (TPF) is capable of running several
multi-dimensional two point functions simultaneously on a dataset using
memory and workload parallelism.
Examples of two point functions are structure functions and two-point
correlation functions.
It can analyze the entire simulation, or a small rectangular subvolume.
The results can be output in convenient text format and in efficient
HDF5 files.</p>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The TPF relies on the Fortran kD-tree that is used
by the parallel HOP halo finder. The kD-tree is not built by default with yt
so it must be built by hand.</p>
</div>
<div class="section" id="quick-example">
<h2>Quick Example<a class="headerlink" href="#quick-example" title="Permalink to this headline">¶</a></h2>
<p>It is very simple to setup and run a structure point function on a dataset.
The script below will output the RMS velocity difference over the entire volume
for a range of distances. There are some brief comments given below for each
step.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">yt.mods</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.two_point_functions.api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s">&quot;data0005&quot;</span><span class="p">)</span>

<span class="c"># Calculate the S in RMS velocity difference between the two points.</span>
<span class="c"># All functions have five inputs. The first two are containers</span>
<span class="c"># for field values, and the second two are the raw point coordinates</span>
<span class="c"># for the point pair. The fifth is the normal vector between the two points</span>
<span class="c"># in r1 and r2. Not all the inputs must be used.</span>
<span class="c"># The name of the function is used to name output files.</span>
<span class="k">def</span> <span class="nf">rms_vel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
    <span class="n">vdiff</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
    <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">vdiff</span><span class="p">)</span>
    <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vdiff</span>


<span class="c"># Initialize a function generator object.</span>
<span class="c"># Set the input fields for the function(s),</span>
<span class="c"># the number of pairs of points to calculate, how big a data queue to</span>
<span class="c"># use, the range of pair separations and how many lengths to use,</span>
<span class="c"># and how to divide that range (linear or log).</span>
<span class="n">tpf</span> <span class="o">=</span> <span class="n">TwoPointFunctions</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;velocity_x&quot;</span><span class="p">,</span> <span class="s">&quot;velocity_y&quot;</span><span class="p">,</span> <span class="s">&quot;velocity_z&quot;</span><span class="p">],</span>
    <span class="n">total_values</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">comm_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">length_number</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">length_range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mi">128</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">length_type</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">)</span>

<span class="c"># Adds the function to the generator. An output label is given,</span>
<span class="c"># and whether or not to square-root the results in the text output is given.</span>
<span class="c"># Note that the items below are being added as lists.</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">rms_vel</span><span class="p">,</span> <span class="n">out_labels</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;RMSvdiff&#39;</span><span class="p">],</span> <span class="n">sqrt</span><span class="o">=</span><span class="p">[</span><span class="bp">True</span><span class="p">])</span>

<span class="c"># Define the bins used to store the results of the function.</span>
<span class="n">f1</span><span class="o">.</span><span class="n">set_pdf_params</span><span class="p">(</span><span class="n">bin_type</span><span class="o">=</span><span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="n">bin_range</span><span class="o">=</span><span class="p">[</span><span class="mf">5e4</span><span class="p">,</span> <span class="mf">5.5e13</span><span class="p">],</span> <span class="n">bin_number</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c"># Runs the functions.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">run_generator</span><span class="p">()</span>

<span class="c"># This calculates the M in RMS and writes out a text file with</span>
<span class="c"># the RMS values and the lengths. The R happens because sqrt=True in</span>
<span class="c"># add_function, above.</span>
<span class="c"># If one is doing turbulence, the contents of this text file are what</span>
<span class="c"># is wanted for plotting.</span>
<span class="c"># The file is named &#39;rms_vel.txt&#39;.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">write_out_means</span><span class="p">()</span>
<span class="c"># Writes out the raw PDF bins and bin edges to a HDF5 file.</span>
<span class="c"># The file is named &#39;rms_vel.h5&#39;.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">write_out_arrays</span><span class="p">()</span>
</pre></div>
</div>
<p>As an aside, note that any analysis function in yt can be accessed directly
and imported automatically using the <code class="docutils literal"><span class="pre">amods</span></code> construct.
Here is an abbreviated example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">yt.mods</span> <span class="kn">import</span> <span class="o">*</span>
<span class="o">...</span>
<span class="n">tpf</span> <span class="o">=</span> <span class="n">amods</span><span class="o">.</span><span class="n">two_point_functions</span><span class="o">.</span><span class="n">TwoPointFunctions</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="probability-distribution-function">
<h2>Probability Distribution Function<a class="headerlink" href="#probability-distribution-function" title="Permalink to this headline">¶</a></h2>
<p>For a given length of separation between points, the TPF stores the
Probability Distribution Function (PDF) of the output values.
The PDF allows more varied analysis of the TPF output than storing
the function itself.
The image below assists in how to think about this.
If the function is measuring the absolute difference in temperature
between two points, for each point separation length L, the measured
differences are binned by temperature difference (delta T).
Therefore in the figure below, for a length L, the x-axis is temperature difference
(delta T), and the y-axis is the probability of finding that temperature
difference.
To find the mean temperature difference for the length L, one just needs
to multiply the value of the temperature difference bin by its probability,
and add up over all the bins.</p>
<a class="reference internal image-reference" href="../../_images/PDF.png"><img alt="../../_images/PDF.png" src="../../_images/PDF.png" style="width: 538px; height: 494px;" /></a>
</div>
<div class="section" id="how-it-works">
<h2>How It Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>In order to use the TPF, one must understand how it works.
When run in parallel the defined analysis volume, whether it is the full
volume or a small region, is subdivided evenly and each task is assigned
a different subvolume.
The total number of point pairs to be created per pair separation length
is <code class="docutils literal"><span class="pre">total_values</span></code>, and each
task is given an equal share of that total.
Each task will create its share of <code class="docutils literal"><span class="pre">total_values</span></code> by first making
a randomly placed point in its local volume.
The second point will be placed a distance away with location set by random
values of (phi, theta) in spherical coordinates and length by the length ranges.
If that second point is inside the tasks subvolume, the functions
are evaluated and their results binned.
However, if the second point lies outside the subvolume (as in a different
tasks subvolume), the point pair is stored in a point data queue, as well as the
field values for the first point in a companion data queue.
When a task makes its share of <code class="docutils literal"><span class="pre">total_values</span></code>, or it fills up its data
queue with points it can&#8217;t fully process, it passes its queues to its neighbor on
the right.
It then receives the data queues from its neighbor on the left, and processes
the queues.
If it can evaluate a point in the received data queues, meaning it can find the
field values for the second point, it computes the functions for
that point pair, and removes that entry from the queue.
If it still needs to fulfill <code class="docutils literal"><span class="pre">total_values</span></code>, it can put its own point pair
into that entry in the queues.
Once the queues are full of points that a task cannot process, it passes them
on.
The data communication cycle ends when all tasks have made their share of
<code class="docutils literal"><span class="pre">total_values</span></code>, and all the data queues are cleared.
When all the cycles have run, the bins are added up globally to find the
global PDF.</p>
<p>Below is a two-dimensional representation of how the full simulation is
subdivided into 16 smaller subvolumes.
Each subvolume is assigned to one of 16 tasks
labelled with an integer [0-15].
Each task is responsible for only the field
values inside its subvolume - it is completely ignorant about all the other
subvolumes.
When point separation rulers are laid down, some like the ruler
labelled A, have both points completely inside a single subvolume.
In this case,
task 5 can evaluate the function(s) on its own.
In situations like
B or C, the points lie in different subvolumes, and no one task can evaluate
the functions independently.</p>
<a class="reference internal image-reference" href="../../_images/struct_fcn_subvolumes0.png"><img alt="../../_images/struct_fcn_subvolumes0.png" src="../../_images/struct_fcn_subvolumes0.png" style="width: 403px; height: 403px;" /></a>
<p>This next figure shows how the data queues are passed from task to task.
Once task 0 is done with its points, or its queue is full, it passes the queue
to task 1.
Likewise, 1 passes to 2, and 15 passes back around to 0, completing the circle.
If a point pair lies in the subvolumes of 0 and 15, it can take up to 15
communication cycles for that pair to be evaluated.</p>
<a class="reference internal image-reference" href="../../_images/struct_fcn_subvolumes1.png"><img alt="../../_images/struct_fcn_subvolumes1.png" src="../../_images/struct_fcn_subvolumes1.png" style="width: 526px; height: 403px;" /></a>
<p>Sometimes the sizes of the data fields being computed on are not very large,
and the memory-parallelism of the TPF isn&#8217;t crucial.
However, if one still wants to run with lots of processors to make large amounts of
random pairs, subdividing the volumes as above is not as efficient as it could
be due to communication overhead.
By using the <code class="docutils literal"><span class="pre">vol_ratio</span></code> setting of TPF (see <a class="reference internal" href="#tpf-tpf"><span>Create the
Function Generator Object</span></a>), the full
volume can be subdivided into larger subvolumes than above,
and tasks will own non-unique copies of the fields data.
In the figure below, the two-dimensional volume has been subdivided into
four subvolumes, and four tasks each own a copy of the data in each subvolume.
As shown, the queues are handed off in the same order as before.
But in this simple example, the maximum number of communication cycles for any
point to be evaluated is three.
This means that the communication overhead will be lower and runtimes
somewhat faster.</p>
<a class="reference internal image-reference" href="../../_images/struct_fcn_subvolumes2.png"><img alt="../../_images/struct_fcn_subvolumes2.png" src="../../_images/struct_fcn_subvolumes2.png" style="width: 526px; height: 403px;" /></a>
</div>
<div class="section" id="a-step-by-step-overview">
<h2>A Step By Step Overview<a class="headerlink" href="#a-step-by-step-overview" title="Permalink to this headline">¶</a></h2>
<p>In order to run the TPF, these steps must be taken:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Load yt (of course), and any other Python modules that are needed.</li>
<li>Define any non-default fields in the standard yt manner.</li>
<li><a class="reference internal" href="#tpf-fcns"><span>Define Functions</span></a>.</li>
<li><a class="reference internal" href="#tpf-tpf"><span>Create the Two Point Function Generator Object</span></a>.</li>
<li><a class="reference internal" href="#tpf-add-fcns"><span>Add Functions</span></a>.</li>
<li><a class="reference internal" href="#tpf-pdf"><span>Set PDF Parameters</span></a>.</li>
<li><a class="reference internal" href="#tpf-run"><span>Run the TPF</span></a>.</li>
<li><a class="reference internal" href="#tpf-output"><span>Output the Results</span></a>.</li>
</ol>
</div></blockquote>
<div class="section" id="define-functions">
<span id="tpf-fcns"></span><h3>Define Functions<a class="headerlink" href="#define-functions" title="Permalink to this headline">¶</a></h3>
<p>All functions must adhere to these specifications:</p>
<blockquote>
<div><ul class="simple">
<li>There must be five input variables. The first two are arrays for the
fields needed by the function, and the next two are the raw coordinate
values for the points. The fifth input is an array with the normal
vector between each of the points in r1 and r2.</li>
<li>The output must be in array format.</li>
<li>The names of the functions need to be unique.</li>
</ul>
</div></blockquote>
<p>The first two variables of a function are arrays that contain the field values.
The order of the field values in the lists is set by the call to <code class="docutils literal"><span class="pre">TwoPointFunctions</span></code>
(that comes later).
In the example above, <code class="docutils literal"><span class="pre">a</span></code> and <code class="docutils literal"><span class="pre">b</span></code>
contain the field velocities for the two points, respectively, in an N by M
array, where N is equal to <code class="docutils literal"><span class="pre">comm_size</span></code> (set in <code class="docutils literal"><span class="pre">TwoPointFunctions</span></code>), and M
is the total number of input fields used by functions.
<code class="docutils literal"><span class="pre">a[:,0]</span></code> and <code class="docutils literal"><span class="pre">b[:,0]</span></code> are the <code class="docutils literal"><span class="pre">x-velocity</span></code> field values because that field
is the first field given in the <code class="docutils literal"><span class="pre">TwoPointFunctions</span></code>.</p>
<p>The second two variables <code class="docutils literal"><span class="pre">r1</span></code> and <code class="docutils literal"><span class="pre">r2</span></code> are the raw point coordinates for the two points.
The fifth input is an array containing the normal vector between each pair of points.
These arrays are all N by 3 arrays.
Note that they are not used in the example above because they are not needed.</p>
<p>Functions need to output in array format, with dimensionality
N by R, where R is the dimensionality of the function.
Multi-dimensional functions can be written that output
several values simultaneously.</p>
<p>The names of the functions must be unique because they are used to name
output files, and name collisions will result in over-written output.</p>
</div>
<div class="section" id="create-the-two-point-function-generator-object">
<span id="tpf-tpf"></span><h3>Create the Two Point Function Generator Object<a class="headerlink" href="#create-the-two-point-function-generator-object" title="Permalink to this headline">¶</a></h3>
<p>Before any functions can be added, the <code class="docutils literal"><span class="pre">TwoPointFunctions</span></code> object needs
to be created. It has these inputs:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">ds</span></code> (the only required input and is always the first term).</li>
<li>Field list, required, an ordered list of field names used by the
functions. The order in this list will need to be referenced when writing
functions. Derived fields may be used here if they are defined first.</li>
<li><code class="docutils literal"><span class="pre">left_edge</span></code>, <code class="docutils literal"><span class="pre">right_edge</span></code>, three-element lists of floats:
Used to define a sub-region of the full volume in which to run the TDS.
Default=None, which is equivalent to running on the full volume. Both must
be set to have any effect.</li>
<li><code class="docutils literal"><span class="pre">total_values</span></code>, integer: The number of random points to generate globally
per point separation length. If run in parallel, each task generates its
fair share of this number.
Default=1000000.</li>
<li><code class="docutils literal"><span class="pre">comm_size</span></code>, integer: How many pairs of points that are stored in the
data queue objects on each task. Too large wastes memory, and too small will
result in longer run times due to extra communication cycles. Each unit of
<code class="docutils literal"><span class="pre">comm_size</span></code> costs (6 + number_of_fields)*8 bytes, where number_of_fields
is the size of the set of unique data fields used by all the functions added to the
TPF. In the RMS velocity example above, number_of_fields=3, and a
<code class="docutils literal"><span class="pre">comm_size</span></code> of 10,000 means each queue costs 10,000*8*(6+3) =
720 KB per task.
Default=10000.</li>
<li><code class="docutils literal"><span class="pre">length_type</span></code>, string (&#8220;lin&#8221; or &#8220;log&#8221;): Sets how to evenly space the point
separation lengths, either linearly or logarithmic (log10).
Default=&#8221;lin&#8221;.</li>
<li><code class="docutils literal"><span class="pre">length_number</span></code>, integer: How many point separations to run.
Default=10.</li>
<li><code class="docutils literal"><span class="pre">length_range</span></code>, two-element list of floats: Two values that define
the minimum and maximum point separations to run over. The lengths that will
be used are divided into <code class="docutils literal"><span class="pre">length_number</span></code> pieces evenly separated according
to <code class="docutils literal"><span class="pre">length_type</span></code>.
Default=None, which is equivalent to [sqrt(3)*dx, min_simulation_edge/2.], where
min_simulation_edge is the length of the smallest edge (1D) of the simulation,
and dx is the smallest cell size in the dataset. The sqrt(3) is there because
that is the distance between opposite corners of a unit cube, and that
guarantees that the point pairs will be in different cells for the most
refined regions.
If the first term of the list is -1, the minimum length will be automatically
set to sqrt(3)*dx, ex: <code class="docutils literal"><span class="pre">length_range</span> <span class="pre">=</span> <span class="pre">[-1,</span> <span class="pre">10/ds['kpc']]</span></code>.</li>
<li><code class="docutils literal"><span class="pre">vol_ratio</span></code>, integer: How to multiply-assign subvolumes to the parallel
tasks. This number must be an integer factor of the total number of tasks or
very bad things will happen. The default value of 1 will assign one task
to each subvolume, and there will be an equal number of subvolumes as tasks.
A value of 2 will assign two tasks to each subvolume and there will be
one-half as many subvolumes as tasks.
A value equal to the number of parallel tasks will result in each task
owning a complete copy of all the fields data, meaning each task will be
operating on the identical full volume.
Setting this to -1 automatically adjusts <code class="docutils literal"><span class="pre">vol_ratio</span></code> such that all tasks
are given the full volume.</li>
<li><code class="docutils literal"><span class="pre">salt</span></code>, integer: A number that will be added to the random number generator
seed. Use this if a different random series of numbers is desired when
keeping everything else constant from this set: (MPI task count,
number of ruler lengths, ruler min/max, number of functions,
number of point pairs per ruler length). Default: 0.</li>
<li><code class="docutils literal"><span class="pre">theta</span></code>, float: For random pairs of points, the second point is found by
traversing a distance along a ray set by the angle (phi, theta) from the
first point. To keep this angle constant, set <code class="docutils literal"><span class="pre">theta</span></code> to a value in the
range [0, pi]. Default = None, which will randomize theta for every pair of
points.</li>
<li><code class="docutils literal"><span class="pre">phi</span></code>, float: Similar to theta above, but the range of values is
[0, 2*pi). Default = None, which will randomize phi for every pair of
points.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="add-functions">
<span id="tpf-add-fcns"></span><h3>Add Functions<a class="headerlink" href="#add-functions" title="Permalink to this headline">¶</a></h3>
<p>Each function is added to the TPF using the <code class="docutils literal"><span class="pre">add_function</span></code> command.
Each call must have the following inputs:</p>
<blockquote>
<div><ol class="arabic simple">
<li>The function name as previously defined.</li>
<li>A list with label(s) for the output(s) of the function.
Even if the function outputs only one value, this must be a list.
These labels are used for output.</li>
<li>A list with bools of whether or not to sqrt the output, in the same order
as the output label list. E.g. <code class="docutils literal"><span class="pre">[True,</span> <span class="pre">False]</span></code>.</li>
</ol>
</div></blockquote>
<p>The call to <code class="docutils literal"><span class="pre">add_function</span></code> returns a <code class="docutils literal"><span class="pre">FcnSet</span></code> object. For convenience,
it is best to store the output in a variable (as in the example above) so
it can be referenced later.
The functions can also be referenced through the <code class="docutils literal"><span class="pre">TwoPointFunctions</span></code> object
in the order in which they were added.
So would <code class="docutils literal"><span class="pre">tpf[0]</span></code> refer to the same thing as <code class="docutils literal"><span class="pre">f1</span></code> in the quick example,
above.</p>
</div>
<div class="section" id="set-pdf-parameters">
<span id="tpf-pdf"></span><h3>Set PDF Parameters<a class="headerlink" href="#set-pdf-parameters" title="Permalink to this headline">¶</a></h3>
<p>Once the function is added to the TPF, the probability distribution
bins need to be defined for each using the command <code class="docutils literal"><span class="pre">set_pdf_params</span></code>.
It has these inputs:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">bin_type</span></code>, string or list of strings (&#8220;lin&#8221; or &#8220;log&#8221;):
How to evenly subdivide the bins over the given range. If the
function has multiple outputs, the input needs to be a list with equal
elements.</li>
<li><code class="docutils literal"><span class="pre">bin_range</span></code>, list or list of lists:
Define the min/max values for the bins for the output(s) of the
function.
If there are multiple outputs, there must be an equal number of lists.</li>
<li><code class="docutils literal"><span class="pre">bin_number</span></code>, integer or list of integers: How many bins to create over
the min/max range defined by <code class="docutils literal"><span class="pre">bin_range</span></code> evenly spaced by the <code class="docutils literal"><span class="pre">bin_type</span></code>
parameter.
If there are multiple outputs, there must be an equal number of integers.</li>
</ul>
</div></blockquote>
<p>The memory costs associated with the PDF bins must be considered when writing
an analysis script.
There is one set of PDF bins created per function, per point separation length.
Each PDF bin costs product(bin_number)*8 bytes, where product(bin_number) is
the product of the entries in the bin_number list, and this is duplicated
on every task.
For multidimensional PDFs, the memory costs can grow very quickly.
For example, for 3 functions, each with two outputs, with 1000 point
separation lengths set for the TPF, and with 5000 PDF bins per output dimension,
the PDF bins will cost: 3*1000*(5000)^2*8=600 GB of memory <em>per task</em>!</p>
<p>Note: <code class="docutils literal"><span class="pre">bin_number</span></code> actually specifies the number of <em>bin edges</em> to make,
rather than the number of bins to make. The number of bins will actually be
<code class="docutils literal"><span class="pre">bin_number</span></code>-1 because values are dropped into bins between the two closest
bin edge values,
and values outside the min/max bin edges are thrown away.
If precisely <code class="docutils literal"><span class="pre">bin_number</span></code> bins are wanted, add 1 when setting the PDF
parameters.</p>
</div>
<div class="section" id="run-the-tpf">
<span id="tpf-run"></span><h3>Run the TPF<a class="headerlink" href="#run-the-tpf" title="Permalink to this headline">¶</a></h3>
<p>The command <code class="docutils literal"><span class="pre">run_generator()</span></code> pulls the trigger and runs the TPF.
There are no inputs.</p>
<p>After the generator runs, it will print messages like this, one per
function:</p>
<div class="highlight-python"><div class="highlight"><pre>yt         INFO       2010-03-13 12:46:54,541 Function rms_vel had 1 values too high and 4960 too low that were not binned.
</pre></div>
</div>
<p>Consider changing the range of the PDF bins to reduce or eliminate un-binned
values.</p>
</div>
<div class="section" id="output-the-results">
<span id="tpf-output"></span><h3>Output the Results<a class="headerlink" href="#output-the-results" title="Permalink to this headline">¶</a></h3>
<p>There are two ways to output data from the TPF for structure functions.</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">The command <code class="docutils literal"><span class="pre">write_out_means</span></code> writes out a text file per function
that contains the means for each dimension of the function output
for each point separation length.
The file is named &#8220;function_name.txt&#8221;, so in the example the file is named
&#8220;rms_vel.txt&#8221;.
In the example above, the <code class="docutils literal"><span class="pre">sqrt=True</span></code> option is turned on, which square-roots
the mean values. Here is some example output for the RMS velocity example:</p>
<div class="highlight-python"><div class="highlight"><pre># length    count       RMSvdiff
7.81250e-03 95040       8.00152e+04
1.24016e-02 100000      1.07115e+05
1.96863e-02 100000      1.53741e+05
3.12500e-02 100000      2.15070e+05
4.96063e-02 100000      2.97069e+05
7.87451e-02 99999       4.02917e+05
1.25000e-01 100000      5.54454e+05
1.98425e-01 100000      7.53650e+05
3.14980e-01 100000      9.57470e+05
5.00000e-01 100000      1.12415e+06
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">count</span></code> column lists the number of pair points successfully binned
at that point separation length.</p>
<p>If the output is multidimensional, pass a list of bools to control the
sqrt column by column (<code class="docutils literal"><span class="pre">sqrt=[False,</span> <span class="pre">True]</span></code>) to <code class="docutils literal"><span class="pre">add_function</span></code>.
For multidimensional functions, the means are calculated by first
collapsing the values in the PDF matrix in the other
dimensions, before multiplying the result by the bin edges for that output
dimension. So in the extremely simple fabricated case of:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Temperature difference bin edges</span>
<span class="c"># dimension 0</span>
<span class="n">Tdiff_bins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<span class="c"># Density difference bin edges</span>
<span class="c"># dimension 1</span>
<span class="n">Ddiff_bins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">5000</span><span class="p">]</span>

<span class="c"># 2-D PDF for a point pair length of 0.05</span>
<span class="n">PDF</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
        <span class="p">[</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span> <span class="p">]</span>
</pre></div>
</div>
<p>What the PDF is recording is that there is a 30% probability of getting a
temperature difference between [10, 100), at the same time of getting a
density difference between [50, 500). There is a 40% probability for Tdiff
in [10, 100) and Ddiff in [500, 5000). The text output of this PDF is
calculated like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Temperature</span>
<span class="n">T_PDF</span> <span class="o">=</span> <span class="n">PDF</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c"># ... which gets ...</span>
<span class="n">T_PDF</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
<span class="c"># Then to get the mean, multiply by the centers of the temperature bins.</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span> <span class="o">*</span> <span class="p">[</span><span class="mi">55</span><span class="p">,</span> <span class="mi">550</span><span class="p">]</span>
<span class="c"># ... which gets ...</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="mf">38.5</span><span class="p">,</span> <span class="mi">165</span><span class="p">]</span>
<span class="n">mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
<span class="c"># ... which gets ...</span>
<span class="n">mean</span> <span class="o">=</span> <span class="mf">203.5</span>

<span class="c"># Density</span>
<span class="n">D_PDF</span> <span class="o">=</span> <span class="n">PDF</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c"># ... which gets ...</span>
<span class="n">D_PDF</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]</span>
<span class="c"># As above...</span>
<span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">]</span> <span class="o">*</span> <span class="p">[</span><span class="mi">275</span><span class="p">,</span> <span class="mi">2750</span><span class="p">]</span>
<span class="n">mean</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
<span class="c"># ... which gets ...</span>
<span class="n">mean</span> <span class="o">=</span> <span class="mi">1760</span>
</pre></div>
</div>
<p>The text file would look something like this:</p>
<div class="highlight-python"><div class="highlight"><pre># length    count       Tdiff    Ddiff
0.05        980242      2.03500e+02 1.76000e+3
</pre></div>
</div>
</li>
<li><p class="first">The command <code class="docutils literal"><span class="pre">write_out_arrays()</span></code> writes the raw PDF bins, as well as the
bin edges for each output dimension to a HDF5 file named
<code class="docutils literal"><span class="pre">function_name.h5</span></code>.
Here is example content for the RMS velocity script above:</p>
<div class="highlight-python"><div class="highlight"><pre>$ h5ls rms_vel.h5
bin_edges_00_RMSvdiff    Dataset {1000}
bin_edges_names          Dataset {1}
counts                   Dataset {10}
lengths                  Dataset {10}
prob_bins_00000          Dataset {999}
prob_bins_00001          Dataset {999}
prob_bins_00002          Dataset {999}
prob_bins_00003          Dataset {999}
prob_bins_00004          Dataset {999}
prob_bins_00005          Dataset {999}
prob_bins_00006          Dataset {999}
prob_bins_00007          Dataset {999}
prob_bins_00008          Dataset {999}
prob_bins_00009          Dataset {999}
</pre></div>
</div>
<p>Every HDF5 file produced will have the datasets <code class="docutils literal"><span class="pre">lengths</span></code>,
<code class="docutils literal"><span class="pre">bin_edges_names</span></code>, and <code class="docutils literal"><span class="pre">counts</span></code>.
<code class="docutils literal"><span class="pre">lengths</span></code> contains the list of the pair separation
lengths used for the TPF, and is identical to the first column in the
text output file.
<code class="docutils literal"><span class="pre">bin_edges_names</span></code> lists the name(s) of the dataset(s) that contain the bin
edge values.
<code class="docutils literal"><span class="pre">counts</span></code> contains the number of successfully binned point pairs for each
point separation length, and is equivalent to the second column in the
text output file.
In the HDF5 file above, the <code class="docutils literal"><span class="pre">lengths</span></code> dataset looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>$ h5dump -d lengths rms_vel.h5
HDF5 &quot;rms_vel.h5&quot; {
DATASET &quot;lengths&quot; {
  DATATYPE  H5T_IEEE_F64LE
  DATASPACE  SIMPLE { ( 10 ) / ( 10 ) }
  DATA {
  (0): 0.0078125, 0.0124016, 0.0196863, 0.03125, 0.0496063, 0.0787451,
  (6): 0.125, 0.198425, 0.31498, 0.5
  }
}
}
</pre></div>
</div>
<p>There are ten length values. <code class="docutils literal"><span class="pre">prob_bins_00000</span></code> is the PDF for pairs of
points separated by the first length value given, which is 0.0078125.
Points separated by 0.0124016 are recorded in <code class="docutils literal"><span class="pre">prob_bins_00001</span></code>, and so
on.
The entries in the <code class="docutils literal"><span class="pre">prob_bins</span></code> datasets are the raw PDF for that function
for that point separation length.
If the function has multiple outputs, the arrays stored in the datasets
are multidimensional.</p>
<p><code class="docutils literal"><span class="pre">bin_edges_names</span></code> looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre>$ h5dump -d bin_edges_names rms_vel.h5
HDF5 &quot;rms_vel.h5&quot; {
DATASET &quot;bin_edges_names&quot; {
  DATATYPE  H5T_STRING {
    STRSIZE 22;
    STRPAD H5T_STR_NULLPAD;
    CSET H5T_CSET_ASCII;
    CTYPE H5T_C_S1;
  }
  DATASPACE  SIMPLE { ( 1 ) / ( 1 ) }
  DATA {
  (0): &quot;/bin_edges_00_RMSvdiff&quot;
  }
}
}
</pre></div>
</div>
<p>This gives the names of the datasets that contain the bin edges, in the
same order as the function output the data.
If the function outputs several items, there will be more than one
dataset listed in <code class="docutils literal"><span class="pre">bin_edges-names</span></code>.
<code class="docutils literal"><span class="pre">bin_edges_00_RMSvdiff</span></code> therefore contains the (dimension 0) bin edges
as specified when the PDF parameters were set.
If there were other output fields, they would be named
<code class="docutils literal"><span class="pre">bin_edges_01_outfield1</span></code>, <code class="docutils literal"><span class="pre">bin_edges_02_outfield2</span></code> respectively.</p>
</li>
</ol>
</div></blockquote>
</div>
</div>
<div class="section" id="strategies-for-computational-efficiency">
<span id="tpf-strategies"></span><h2>Strategies for Computational Efficiency<a class="headerlink" href="#strategies-for-computational-efficiency" title="Permalink to this headline">¶</a></h2>
<p>Here are a few recommendations that will make the function generator
run as quickly as possible, in particular when running in parallel.</p>
<blockquote>
<div><ul class="simple">
<li>Calculate how much memory the data fields and PDFs will require, and
figure out what fraction can fit on a single compute node. For example
(ignoring the PDF memory costs), if four data fields are required, and each
takes up 8GB of memory (as in each field has 1e9 doubles), 32GB total is
needed. If the analysis is being run on a machine with 4GB per node,
at least eight nodes must be used (but in practice it is often just under
4GB available to applications, so more than eight nodes are needed).
The number of nodes gives the minimal number of MPI tasks to use, which
corresponds to the minimal volume decomposition required.
Benchmark tests show that the function generator runs the quickest
when each MPI task owns as much of the full volume as possible.
If this number of MPI tasks calculated above is fewer than desired due to
the number of pairs to be generated, instead of further subdividing the volume,
use the <code class="docutils literal"><span class="pre">vol_ratio</span></code> parameter to multiply-assign tasks to the same subvolume.
The total number of compute nodes will have to be increased because field
data is being duplicated in memory, but tests have shown that things run
faster in this mode. The bottom line: pick a vol_ratio that is as large
as possible.</li>
<li>The ideal <code class="docutils literal"><span class="pre">comm_size</span></code> appears to be around 1e5 or 1e6 in size.</li>
<li>If possible, write the functions using only Numpy functions and methods.
The input and output must be in array format, but the logic inside the function
need not be. However, it will run much slower if optimized methods are not used.</li>
<li>Run a few test runs before doing a large run so that the PDF parameters can
be correctly set.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="advanced-two-point-function-techniques">
<h2>Advanced Two Point Function Techniques<a class="headerlink" href="#advanced-two-point-function-techniques" title="Permalink to this headline">¶</a></h2>
<div class="section" id="density-threshold">
<h3>Density Threshold<a class="headerlink" href="#density-threshold" title="Permalink to this headline">¶</a></h3>
<p>If points are to only be compared if they both are above some density threshold,
simply pass the density field to the function, and return a value
that lies outside the PDF min/max if the density is too low.
Here are the modifications to the RMS velocity example to do this that
requires a gas density of at least 1e-26 g cm^-3 at each point:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">rms_vel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
  <span class="c"># Pick out points with only good densities</span>
  <span class="n">a_good</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1.e-26</span>
  <span class="n">b_good</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1.e-26</span>
  <span class="c"># Pick out the pairs with both good densities</span>
  <span class="n">both_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">a_good</span><span class="p">,</span> <span class="n">b_good</span><span class="p">)</span>
  <span class="c"># Operate only on the velocity columns</span>
  <span class="n">vdiff</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
  <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">vdiff</span><span class="p">)</span>
  <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="c"># Multiplying by a boolean array has the effect of multiplying by 1 for</span>
  <span class="c"># True, and 0 for False. This operation below will force pairs of not</span>
  <span class="c"># good points to zero, outside the PDF (see below), and leave good</span>
  <span class="c"># pairs unchanged.</span>
  <span class="n">vdiff</span> <span class="o">*=</span> <span class="n">both_good</span>
  <span class="k">return</span> <span class="n">vdiff</span>

<span class="o">...</span>
<span class="n">tpf</span> <span class="o">=</span> <span class="n">TwoPointFunctions</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;velocity_x&quot;</span><span class="p">,</span> <span class="s">&quot;velocity_y&quot;</span><span class="p">,</span> <span class="s">&quot;velocity_z&quot;</span><span class="p">,</span> <span class="s">&quot;density&quot;</span><span class="p">],</span>
    <span class="n">total_values</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">comm_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">length_number</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">length_range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mi">128</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">length_type</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">)</span>

<span class="n">tpf</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">rms_vel</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;RMSvdiff&#39;</span><span class="p">],</span> <span class="p">[</span><span class="bp">False</span><span class="p">])</span>
<span class="n">tpf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_pdf_params</span><span class="p">(</span><span class="n">bin_type</span><span class="o">=</span><span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="n">bin_range</span><span class="o">=</span><span class="p">[</span><span class="mf">5e4</span><span class="p">,</span> <span class="mf">5.5e13</span><span class="p">],</span> <span class="n">bin_number</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>Because 0 is outside of the <code class="docutils literal"><span class="pre">bin_range</span></code>, a pair of points that don&#8217;t satisfy
the density requirements do not contribute to the PDF.
If density cutoffs are to be done in this fashion, the fractional volume that is
above the density threshold should be calculated first, and <code class="docutils literal"><span class="pre">total_values</span></code>
multiplied by the square of the inverse of this (which should be a multiplicative factor
greater than one, meaning more point pairs will be generated to compensate
for trashed points).</p>
</div>
<div class="section" id="multidimensional-pdfs">
<h3>Multidimensional PDFs<a class="headerlink" href="#multidimensional-pdfs" title="Permalink to this headline">¶</a></h3>
<p>It is easy to modify the example above to output in multiple dimensions. In
this example, the ratio of the densities of the two points is recorded at
the same time as the velocity differences.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">yt.mods</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.two_point_functions.api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s">&quot;data0005&quot;</span><span class="p">)</span>

<span class="c"># Calculate the S in RMS velocity difference between the two points.</span>
<span class="c"># Also store the ratio of densities (keeping them &gt;= 1).</span>
<span class="c"># All functions have four inputs. The first two are containers</span>
<span class="c"># for field values, and the second two are the raw point coordinates</span>
<span class="c"># for the point pair. The name of the function is used to name</span>
<span class="c"># output files.</span>
<span class="k">def</span> <span class="nf">rms_vel_D</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
  <span class="c"># Operate only on the velocity columns</span>
  <span class="n">vdiff</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
  <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">vdiff</span><span class="p">)</span>
  <span class="n">vdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vdiff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="c"># Density ratio</span>
  <span class="n">Dratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">b</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">a</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span>
  <span class="k">return</span> <span class="p">[</span><span class="n">vdiff</span><span class="p">,</span> <span class="n">Dratio</span><span class="p">]</span>

<span class="c"># Initialize a function generator object.</span>
<span class="c"># Set the number of pairs of points to calculate, how big a data queue to</span>
<span class="c"># use, the range of pair separations and how many lengths to use,</span>
<span class="c"># and how to divide that range (linear or log).</span>
<span class="n">tpf</span> <span class="o">=</span> <span class="n">TwoPointFunctions</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;velocity_x&quot;</span><span class="p">,</span> <span class="s">&quot;velocity_y&quot;</span><span class="p">,</span> <span class="s">&quot;velocity_z&quot;</span><span class="p">,</span> <span class="s">&quot;density&quot;</span><span class="p">],</span>
    <span class="n">total_values</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">comm_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">length_number</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">length_range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mi">128</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">length_type</span><span class="o">=</span><span class="s">&quot;log&quot;</span><span class="p">)</span>

<span class="c"># Adds the function to the generator.</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">tpf</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">rms_vel</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;RMSvdiff&#39;</span><span class="p">,</span> <span class="s">&#39;Dratio&#39;</span><span class="p">],</span> <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">])</span>

<span class="c"># Define the bins used to store the results of the function.</span>
<span class="c"># Note that the bin edges can have different division, &quot;lin&quot; and &quot;log&quot;.</span>
<span class="c"># In particular, a bin edge of 0 doesn&#39;t play well with &quot;log&quot;.</span>
<span class="n">f1</span><span class="o">.</span><span class="n">set_pdf_params</span><span class="p">(</span><span class="n">bin_type</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="s">&#39;lin&#39;</span><span class="p">],</span>
    <span class="n">bin_range</span><span class="o">=</span><span class="p">[[</span><span class="mf">5e4</span><span class="p">,</span> <span class="mf">5.5e13</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">10000.</span><span class="p">]],</span>
    <span class="n">bin_number</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>

<span class="c"># Runs the functions.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">run_generator</span><span class="p">()</span>

<span class="c"># This calculates the M in RMS and writes out a text file with</span>
<span class="c"># the RMS values and the lengths. The R happens because sqrt=[True, False]</span>
<span class="c"># in add_function.</span>
<span class="c"># The file is named &#39;rms_vel_D.txt&#39;. It will sqrt only the MS velocity column.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">write_out_means</span><span class="p">()</span>
<span class="c"># Writes out the raw PDF bins and bin edges to a HDF5 file.</span>
<span class="c"># The file is named &#39;rms_vel_D.h5&#39;.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">write_out_arrays</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="two-point-correlation-functions">
<h2>Two-Point Correlation Functions<a class="headerlink" href="#two-point-correlation-functions" title="Permalink to this headline">¶</a></h2>
<p>In a Gaussian random field of galaxies, the probability of finding a pair of
galaxies within the volumes <img class="math" src="../../_images/math/8d9d6b73c8cf4c78e82f0a1457b4f2952713702a.png" alt="dV_1"/> and <img class="math" src="../../_images/math/9b6b5b0b87e55ca238421e4100b0e30ccbf51b1a.png" alt="dV_2"/> is</p>
<div class="math">
<p><img src="../../_images/math/b4541508723f920e74df8ef7189b6f34c5fa34db.png" alt="dP = n^2 dV_1 dV_2"/></p>
</div><p>where n is the average number density of galaxies. Real galaxies are not
distributed randomly, rather they tend to be clustered on a characteristic
length scale.
Therefore, the probability of two galaxies being paired is a function of
radius</p>
<div class="math">
<p><img src="../../_images/math/34a71de416a61704be0e6621b2abf94acdbb9e86.png" alt="dP = n^2 (1 + \xi(\mathbf{r}_{12})) dV_1 dV_2"/></p>
</div><p>where <img class="math" src="../../_images/math/5f636d7a1665a6cce19114731733a61f1c91c443.png" alt="\xi(\mathbf{r}_{12})"/> gives the excess probability as a function of
<img class="math" src="../../_images/math/cc93afbfa2bdb4ae2bccf4b3c3e9bc2ea4de5e38.png" alt="\mathbf{r}_{12}"/>,
and is the two-point correlation function.
Values of <img class="math" src="../../_images/math/26bfd3bc4c5db78139d8897f9cfa5bba511a2f22.png" alt="\xi"/> greater than one mean galaxies are super-gaussian,
and visa-versa.
In order to use the TPF to calculate two point correlation functions,
the number of pairs of galaxies between the two dV volumes is measured.
A PDF is built that gives the probabilities of finding the number of pairs.
To find the excess probability, a function <cite>write_out_correlation</cite> does
something similar to <cite>write_out_means</cite> (above), but also normalizes by the
number density of galaxies and the dV volumes.
As an aside, a good rule of thumb is that
for galaxies, <img class="math" src="../../_images/math/5fe7c6eea4e487e5d4449281c90e1c9c58b00bb5.png" alt="\xi(r) = (r_0/r)^{1.8}"/> where <img class="math" src="../../_images/math/01024492a8eef6dde3517cabf2a79cfc608c6790.png" alt="r_0=5"/> Mpc/h.</p>
<a class="reference internal image-reference" href="../../_images/2ptcorrelation.png"><img alt="../../_images/2ptcorrelation.png" src="../../_images/2ptcorrelation.png" style="width: 275px; height: 192px;" /></a>
<p>It is possible to calculate the correlation function for galaxies using
the TPF using a script based on the example below.
Unlike the figure above, the volumes are spherical.
This script can be run in parallel.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">yt.mods</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">yt.utilities.kdtree</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.two_point_functions.api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># Specify the dataset on which we want to base our work.</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s">&#39;data0005&#39;</span><span class="p">)</span>

<span class="c"># Read in the halo centers of masses.</span>
<span class="n">CoM</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">data</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s">&#39;HopAnalysis.out&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">if</span> <span class="s">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">xp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">yp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
    <span class="n">zp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
    <span class="n">CoM</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xp</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">zp</span><span class="p">]))</span>
<span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># This is the same dV as in the formulation of the two-point correlation.</span>
<span class="n">dV</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">dV</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>

<span class="c"># Instantiate our TPF object.</span>
<span class="c"># For technical reasons (hopefully to be fixed someday) `vol_ratio`</span>
<span class="c"># needs to be equal to the number of tasks used if this is run</span>
<span class="c"># in parallel. A value of -1 automatically does this.</span>
<span class="n">tpf</span> <span class="o">=</span> <span class="n">TwoPointFunctions</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">],</span>
    <span class="n">total_values</span><span class="o">=</span><span class="mf">1e7</span><span class="p">,</span> <span class="n">comm_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">length_number</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">length_range</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">length_type</span><span class="o">=</span><span class="s">&quot;lin&quot;</span><span class="p">,</span> <span class="n">vol_ratio</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Build the kD tree of halos. This will be built on all</span>
<span class="c"># tasks so it shouldn&#39;t be too large.</span>
<span class="c"># All of these need to be set even if they&#39;re not used.</span>
<span class="c"># Convert the data to fortran major/minor ordering</span>
<span class="n">add_tree</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">CoM</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">nfound_many</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">comm_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int64&#39;</span><span class="p">)</span>
<span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>
<span class="c"># These must be set because the function find_many_r_nearest</span>
<span class="c"># does more than how we are using it, and it needs these.</span>
<span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">radius_n</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">nn_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">radius_n</span><span class="p">,</span> <span class="n">tpf</span><span class="o">.</span><span class="n">comm_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;float64&#39;</span><span class="p">)</span>
<span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">nn_tags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">radius_n</span><span class="p">,</span> <span class="n">tpf</span><span class="o">.</span><span class="n">comm_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int64&#39;</span><span class="p">)</span>
<span class="c"># Makes the kD tree.</span>
<span class="n">create_tree</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Remembering that two of the arguments for a function are the raw</span>
<span class="c"># coordinates, we define a two-point correlation function as follows.</span>
<span class="k">def</span> <span class="nf">tpcorr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
    <span class="c"># First, we will find out how many halos are within fKD.t1.radius of our</span>
    <span class="c"># first set of points, r1, which will be stored in fKD.t1.nfound_many.</span>
    <span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">qv_many</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">T</span>
    <span class="n">find_many_r_nearest</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nfirst</span> <span class="o">=</span> <span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">nfound_many</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c"># Second.</span>
    <span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">qv_many</span> <span class="o">=</span> <span class="n">r2</span><span class="o">.</span><span class="n">T</span>
    <span class="n">find_many_r_nearest</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nsecond</span> <span class="o">=</span> <span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">nfound_many</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c"># Now we simply multiply these two arrays together. The rest comes later.</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">nfirst</span> <span class="o">*</span> <span class="n">nsecond</span>
    <span class="k">return</span> <span class="n">nn</span>

<span class="c"># Now we add the function to the TPF.</span>
<span class="c"># ``corr_norm`` is used to normalize the correlation function.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">tpcorr</span><span class="p">,</span> <span class="n">out_labels</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;tpcorr&#39;</span><span class="p">],</span> <span class="n">sqrt</span><span class="o">=</span><span class="p">[</span><span class="bp">False</span><span class="p">],</span>
    <span class="n">corr_norm</span><span class="o">=</span><span class="n">dV</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">CoM</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c"># And define how we want to bin things.</span>
<span class="c"># It has to be linear bin_type because we want 0 to be in the range.</span>
<span class="c"># The big end of bin_range should correspond to the square of the maximum</span>
<span class="c"># number of halos expected inside dV in the volume.</span>
<span class="n">tpf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_pdf_params</span><span class="p">(</span><span class="n">bin_type</span><span class="o">=</span><span class="s">&#39;lin&#39;</span><span class="p">,</span> <span class="n">bin_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2500000</span><span class="p">],</span> <span class="n">bin_number</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c"># Runs the functions.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">run_generator</span><span class="p">()</span>

<span class="c"># Write out the data to &quot;tpcorr_correlation.txt&quot;</span>
<span class="c"># The file has two columns, the first is radius, and the second is</span>
<span class="c"># the value of \xi.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">write_out_correlation</span><span class="p">()</span>

<span class="c"># Empty the kdtree</span>
<span class="k">del</span> <span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">nfound_many</span><span class="p">,</span> <span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">nn_dist</span><span class="p">,</span> <span class="n">fKD</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">nn_tags</span>
<span class="n">free_tree</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>If one wishes to operate on field values, rather than discrete objects like
halos, the situation is a bit simpler, but still a bit confusing.
In the example below, we find the two-point correlation of cells above
a particular density threshold.
Instead of constant-size spherical dVs, the dVs here are the sizes of the grid
cells at each end of the rulers.
Because there can be cells of different volumes when using AMR,
the number of pairs counted is actually the number of most-refined-cells
contained within the volume of the cell.
For one level of refinement, this means that a root-grid cell has the equivalent
of 8 refined grid cells in it.
Therefore, when the number of pairs are counted, it has to be normalized by
the volume of the cells.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">yt.mods</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">yt.utilities.kdtree</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.two_point_functions.api</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># Specify the dataset on which we want to base our work.</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s">&#39;data0005&#39;</span><span class="p">)</span>

<span class="c"># We work in simulation&#39;s units, these are for conversion.</span>
<span class="n">vol_conv</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s">&#39;cm&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">3</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_smallest_dx</span><span class="p">()</span><span class="o">**</span><span class="mi">3</span>

<span class="c"># Our density limit, in gm/cm**3</span>
<span class="n">dens</span> <span class="o">=</span> <span class="mf">2e-31</span>

<span class="c"># We need to find out how many cells (equivalent to the most refined level)</span>
<span class="c"># are denser than our limit overall.</span>
<span class="k">def</span> <span class="nf">_NumDens</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">select</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;density&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dens</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;cell_volume&quot;</span><span class="p">][</span><span class="n">select</span><span class="p">]</span> <span class="o">/</span> <span class="n">vol_conv</span> <span class="o">/</span> <span class="n">sm</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">sum</span><span class="p">(),)</span>
<span class="k">def</span> <span class="nf">_combNumDens</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">add_quantity</span><span class="p">(</span><span class="s">&quot;TotalNumDens&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">_NumDens</span><span class="p">,</span>
    <span class="n">combine_function</span><span class="o">=</span><span class="n">_combNumDens</span><span class="p">,</span> <span class="n">n_ret</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">all</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">all_data</span><span class="p">()</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">all</span><span class="o">.</span><span class="n">quantities</span><span class="p">[</span><span class="s">&quot;TotalNumDens&quot;</span><span class="p">]()</span>

<span class="k">print</span> <span class="n">n</span><span class="p">,</span><span class="s">&#39;n&#39;</span>

<span class="c"># Instantiate our TPF object.</span>
<span class="n">tpf</span> <span class="o">=</span> <span class="n">TwoPointFunctions</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;density&#39;</span><span class="p">,</span> <span class="s">&#39;cell_volume&#39;</span><span class="p">],</span>
    <span class="n">total_values</span><span class="o">=</span><span class="mf">1e5</span><span class="p">,</span> <span class="n">comm_size</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
    <span class="n">length_number</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">length_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span>
    <span class="n">length_type</span><span class="o">=</span><span class="s">&quot;lin&quot;</span><span class="p">,</span> <span class="n">vol_ratio</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Define the density threshold two point correlation function.</span>
<span class="k">def</span> <span class="nf">dens_tpcorr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
    <span class="c"># We want to find out which pairs of Densities from a and b are both</span>
    <span class="c"># dense enough. The first column is density.</span>
    <span class="n">abig</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dens</span><span class="p">)</span>
    <span class="n">bbig</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dens</span><span class="p">)</span>
    <span class="n">both</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">abig</span><span class="p">,</span> <span class="n">bbig</span><span class="p">)</span>
    <span class="c"># We normalize by the volume of the most refined cells.</span>
    <span class="n">both</span> <span class="o">=</span> <span class="n">both</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">both</span> <span class="o">*=</span> <span class="n">a</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">vol_conv</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">sm</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">both</span>

<span class="c"># Now we add the function to the TPF.</span>
<span class="c"># ``corr_norm`` is used to normalize the correlation function.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">dens_tpcorr</span><span class="p">,</span> <span class="n">out_labels</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;tpcorr&#39;</span><span class="p">],</span> <span class="n">sqrt</span><span class="o">=</span><span class="p">[</span><span class="bp">False</span><span class="p">],</span>
    <span class="n">corr_norm</span><span class="o">=</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c"># And define how we want to bin things.</span>
<span class="c"># It has to be linear bin_type because we want 0 to be in the range.</span>
<span class="c"># The top end of bin_range should be 2^(2l)+1, where l is the number of</span>
<span class="c"># levels, and bin_number=2^(2l)+2</span>
<span class="n">tpf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_pdf_params</span><span class="p">(</span><span class="n">bin_type</span><span class="o">=</span><span class="s">&#39;lin&#39;</span><span class="p">,</span> <span class="n">bin_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">bin_number</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c"># Runs the functions.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">run_generator</span><span class="p">()</span>

<span class="c"># Write out the data to &quot;dens_tpcorr_correlation.txt&quot;</span>
<span class="c"># The file has two columns, the first is radius, and the second is</span>
<span class="c"># the value of \xi.</span>
<span class="n">tpf</span><span class="o">.</span><span class="n">write_out_correlation</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
    <div class="footer">
      &copy; Copyright 2013, the yt Project.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>