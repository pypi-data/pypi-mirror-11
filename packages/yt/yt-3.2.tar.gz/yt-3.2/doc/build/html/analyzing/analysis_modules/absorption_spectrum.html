<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Absorption Spectrum &mdash; The yt Project 3.2-dev documentation</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootswatch-3.3.4/readable/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.2-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="The yt Project 3.2-dev documentation" href="../../index.html" />
    <link rel="up" title="Synthetic Observation" href="synthetic_observation.html" />
    <link rel="next" title="Star Particle Analysis" href="star_analysis.html" />
    <link rel="prev" title="Planning Simulations to use LightCones or LightRays" href="planning_cosmology_simulations.html" />
    
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-391373-2']);
      _gaq.push(['_setDomainName', 'yt-project.org']);
      _gaq.push(['_setAllowHash', false]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><img src="../../_static/yt_icon.png">
          The yt Project</a>
        <span class="navbar-text navbar-version pull-left"><b>3.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../help/index.html">How to get help</a></li>
                <li><a href="../../quickstart/index.html">Quickstart notebooks</a></li>
                <li><a href="../../cookbook/index.html">Cookbook</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installing.html">Getting and Installing yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installing.html#getting-yt">Getting yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installing.html#testing-your-installation">Testing Your Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installing.html#switching-between-yt-2-x-and-yt-3-x">Switching between yt-2.x and yt-3.x</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">yt Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/data_inspection.html">Data Inspection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/simple_visualization.html">Simple Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/data_objects_and_time_series.html">Data Objects and Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/derived_fields_and_profiles.html">Derived Fields and Profiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../quickstart/volume_rendering.html">Volume Rendering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../yt3differences.html">What&#8217;s New and Different in yt 3.0?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../yt3differences.html#updating-to-yt-3-0-from-old-versions-and-going-back">Updating to yt 3.0 from Old Versions (and going back)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../yt3differences.html#converting-old-scripts-to-work-with-yt-3-0">Converting Old Scripts to Work with yt 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../yt3differences.html#cool-new-things">Cool New Things</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../yt3differences.html#api-changes">API Changes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbook/index.html">The Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#getting-the-sample-data">Getting the Sample Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#example-scripts">Example Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#example-notebooks">Example Notebooks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../visualizing/index.html">Visualizing Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/plots.html">How to Make Plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/callbacks.html">Plot Modifications: Overplotting Contours, Velocities, Particles, and More</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/manual_plotting.html">Using the Manual Plotting Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/volume_rendering.html">Volume Rendering: Making 3D Photorealistic Isocontoured Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/hardware_volume_rendering.html">Hardware Volume Rendering on NVidia Graphics cards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/sketchfab.html">3D Surfaces and Sketchfab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/mapserver.html">Mapserver - A Google-Maps-like Interface to your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/streamlines.html">Streamlines: Tracking the Trajectories of Tracers in your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/colormaps/index.html">Colormaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../visualizing/writing_fits_images.html">Writing FITS Images</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">General Data Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../fields.html">Fields in yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_derived_fields.html">Creating Derived Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../objects.html">Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../units/index.html">Symbolic Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filtering.html">Filtering your Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generating_processed_data.html">Generating Processed Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../time_series_analysis.html">Time Series Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parallel_computation.html">Parallel Computation With yt</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Topic-Specific Analysis Modules</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="halo_analysis.html">Halo Analysis</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="synthetic_observation.html">Synthetic Observation</a></li>
<li class="toctree-l2"><a class="reference internal" href="exporting.html">Exporting to External Radiation Transport Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="two_point_functions.html">Two Point Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="clump_finding.html">Clump Finding</a></li>
<li class="toctree-l2"><a class="reference internal" href="particle_trajectories.html">Particle Trajectories</a></li>
<li class="toctree-l2"><a class="reference internal" href="ellipsoid_analysis.html">Halo Ellipsoid Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examining/index.html">Loading and Examining Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examining/loading_data.html">Loading Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examining/generic_array_data.html">Loading Generic Array Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examining/generic_particle_data.html">Loading Generic Particle Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examining/spherical_data.html">Loading Spherical Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examining/low_level_inspection.html">Low-Level Data Inspection: Accessing Raw Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developing/index.html">Developing in yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../developing/intro.html">Getting Involved</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/developing.html">How to Develop yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/building_the_docs.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/debugdrive.html">Debugging yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_datatypes.html">Creating Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_derived_fields.html">Creating Derived Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_derived_quantities.html">Creating Derived Quantities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/creating_frontend.html">Creating A New Code Frontend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../developing/external_analysis.html">Using yt with External Analysis Tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference Materials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/code_support.html">Code Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/command-line.html">Command-Line Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/api/api.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/configuration.html">Customizing yt: The Configuration and Plugin Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/field_list.html">Field List</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/changelog.html">ChangeLog</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#version-installation">Version &amp; Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#code-errors-and-failures">Code Errors and Failures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#units">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#fields">Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#data-objects">Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#developing">Developing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/index.html#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../help/index.html">Getting Help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#don-t-panic-and-don-t-give-up">Don&#8217;t panic and don&#8217;t give up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#update-to-the-latest-version">Update to the latest version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#search-the-documentation-faq-and-mailing-lists">Search the documentation, FAQ, and mailing lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#look-at-the-source-code">Look at the source code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#isolate-and-document-your-problem">Isolate and document your problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#go-on-irc-to-ask-a-question">Go on IRC to ask a question</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#ask-the-mailing-list">Ask the mailing list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#submit-a-bug-report">Submit a bug report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../help/index.html#special-issues">Special Issues</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#what-is-yt">What is yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#who-is-yt">Who is yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#history-of-yt">History of yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#how-do-i-contact-yt">How do I contact yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/index.html#how-do-i-cite-yt">How do I cite yt?</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Absorption Spectrum</a><ul>
<li><a class="reference internal" href="#creating-an-absorption-spectrum">Creating an Absorption Spectrum</a></li>
<li><a class="reference internal" href="#adding-features-to-the-spectrum">Adding Features to the Spectrum</a></li>
<li><a class="reference internal" href="#making-the-spectrum">Making the Spectrum</a></li>
<li><a class="reference internal" href="#fitting-an-absorption-spectrum">Fitting an Absorption Spectrum</a></li>
<li><a class="reference internal" href="#loading-an-absorption-spectrum">Loading an Absorption Spectrum</a></li>
<li><a class="reference internal" href="#specifying-species-properties">Specifying Species Properties</a></li>
<li><a class="reference internal" href="#generating-fit-of-spectrum">Generating Fit of Spectrum</a></li>
<li><a class="reference internal" href="#saving-a-spectrum-fit">Saving a Spectrum Fit</a></li>
<li><a class="reference internal" href="#procedure-for-generating-fits">Procedure for Generating Fits</a></li>
<li><a class="reference internal" href="#finding-line-complexes">Finding Line Complexes</a></li>
<li><a class="reference internal" href="#fitting-a-line-complex">Fitting a Line Complex</a></li>
<li><a class="reference internal" href="#checking-fit-results">Checking Fit Results</a></li>
<li><a class="reference internal" href="#saturated-lyman-alpha-fitting-tools">Saturated Lyman Alpha Fitting Tools</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="absorption-spectrum">
<span id="id1"></span><h1>Absorption Spectrum<a class="headerlink" href="#absorption-spectrum" title="Permalink to this headline">¶</a></h1>
<p>Absorption line spectra, such as shown below, can be made with data created
by the (<a class="reference internal" href="light_ray_generator.html#light-ray-generator"><span>Light Ray Generator</span></a>).  For each element of the ray, column
densities are calculated multiplying the number density within a grid cell
with the path length of the ray through the cell.  Line profiles are
generated using a voigt profile based on the temperature field.  The lines
are then shifted according to the redshift recorded by the light ray tool
and (optionally) the line of sight peculiar velocity.  Inclusion of the
peculiar velocity requires setting <code class="docutils literal"><span class="pre">get_los_velocity</span></code> to True in the call to
<a class="reference internal" href="../../reference/api/generated/yt.analysis_modules.cosmological_observation.light_ray.light_ray.LightRay.make_light_ray.html#yt.analysis_modules.cosmological_observation.light_ray.light_ray.LightRay.make_light_ray" title="yt.analysis_modules.cosmological_observation.light_ray.light_ray.LightRay.make_light_ray"><code class="xref py py-meth docutils literal"><span class="pre">make_light_ray()</span></code></a>.</p>
<p>The spectrum generator will output a file containing the wavelength and
normalized flux.  It will also output a text file listing all important lines.</p>
<a class="reference internal image-reference" href="../../_images/spectrum_full.png"><img alt="../../_images/spectrum_full.png" src="../../_images/spectrum_full.png" style="width: 500px;" /></a>
<p>An absorption spectrum for the wavelength range from 900 to 1800 Angstroms
made with a light ray extending from z = 0 to z = 0.4.</p>
<a class="reference internal image-reference" href="../../_images/spectrum_zoom.png"><img alt="../../_images/spectrum_zoom.png" src="../../_images/spectrum_zoom.png" style="width: 500px;" /></a>
<p>A zoom-in of the above spectrum.</p>
<div class="section" id="creating-an-absorption-spectrum">
<h2>Creating an Absorption Spectrum<a class="headerlink" href="#creating-an-absorption-spectrum" title="Permalink to this headline">¶</a></h2>
<p>To instantiate an AbsorptionSpectrum object, the arguments required are the
minimum and maximum wavelengths, and the number of wavelength bins.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">yt.analysis_modules.absorption_spectrum.api</span> <span class="kn">import</span> <span class="n">AbsorptionSpectrum</span>

<span class="n">sp</span> <span class="o">=</span> <span class="n">AbsorptionSpectrum</span><span class="p">(</span><span class="mf">900.0</span><span class="p">,</span> <span class="mf">1800.0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-features-to-the-spectrum">
<h2>Adding Features to the Spectrum<a class="headerlink" href="#adding-features-to-the-spectrum" title="Permalink to this headline">¶</a></h2>
<p>Absorption lines and continuum features can then be added to the spectrum.
To add a line, you must know some properties of the line: the rest wavelength,
f-value, gamma value, and the atomic mass in amu of the atom.  That line must
be tied in some way to a field in the dataset you are loading, and this field
must be added to the LightRay object when it is created.  Below, we will
add the H Lyman-alpha line, which is tied to the neutral hydrogen field
(&#8216;H_number_density&#8217;).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_label</span> <span class="o">=</span> <span class="s">&#39;HI Lya&#39;</span>
<span class="n">field</span> <span class="o">=</span> <span class="s">&#39;H_number_density&#39;</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="mf">1215.6700</span> <span class="c"># Angstroms</span>
<span class="n">f_value</span> <span class="o">=</span> <span class="mf">4.164E-01</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">6.265e+08</span>
<span class="n">mass</span> <span class="o">=</span> <span class="mf">1.00794</span>

<span class="n">sp</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">my_label</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">f_value</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">label_threshold</span><span class="o">=</span><span class="mf">1.e10</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above example, the <em>field</em> argument tells the spectrum generator which
field from the ray data to use to calculate the column density.  The
<code class="docutils literal"><span class="pre">label_threshold</span></code> keyword tells the spectrum generator to add all lines
above a column density of 10 <sup>10</sup> cm <sup>-2</sup> to the
text line list.  If None is provided, as is the default, no lines of this
type will be added to the text list.</p>
<p>Continuum features with optical depths that follow a power law can also be
added.  Like adding lines, you must specify details like the wavelength
and the field in the dataset and LightRay that is tied to this feature.
Below, we will add H Lyman continuum.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_label</span> <span class="o">=</span> <span class="s">&#39;HI Lya&#39;</span>
<span class="n">field</span> <span class="o">=</span> <span class="s">&#39;H_number_density&#39;</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="mf">912.323660</span> <span class="c"># Angstroms</span>
<span class="n">normalization</span> <span class="o">=</span> <span class="mf">1.6e17</span>
<span class="n">index</span> <span class="o">=</span> <span class="mf">3.0</span>

<span class="n">sp</span><span class="o">.</span><span class="n">add_continuum</span><span class="p">(</span><span class="n">my_label</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">normalization</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="making-the-spectrum">
<h2>Making the Spectrum<a class="headerlink" href="#making-the-spectrum" title="Permalink to this headline">¶</a></h2>
<p>Once all the lines and continuum are added, it is time to make a spectrum out
of some light ray data.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">make_spectrum</span><span class="p">(</span><span class="s">&#39;lightray.h5&#39;</span><span class="p">,</span>
                                    <span class="n">output_file</span><span class="o">=</span><span class="s">&#39;spectrum.fits&#39;</span><span class="p">,</span>
                                    <span class="n">line_list_file</span><span class="o">=</span><span class="s">&#39;lines.txt&#39;</span><span class="p">,</span>
                                    <span class="n">use_peculiar_velocity</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>A spectrum will be made using the specified ray data and the wavelength and
flux arrays will also be returned.  If <code class="docutils literal"><span class="pre">use_peculiar_velocity</span></code> is set to
False, the lines will only be shifted according to the redshift.</p>
<p>Three output file formats are supported for writing out the spectrum: fits,
hdf5, and ascii.  The file format used is based on the extension provided
in the <code class="docutils literal"><span class="pre">output_file</span></code> keyword: <code class="docutils literal"><span class="pre">.fits</span></code> for a fits file,
<code class="docutils literal"><span class="pre">.h5</span></code> for an hdf5 file, and anything else for an ascii file.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To write out a fits file, you must install the <a class="reference external" href="http://www.astropy.org">astropy</a> python library in order to access the astropy.io.fits module.  You can usually do this by simply running <cite>pip install astropy</cite> at the command line.</p>
</div>
</div>
<div class="section" id="fitting-an-absorption-spectrum">
<h2>Fitting an Absorption Spectrum<a class="headerlink" href="#fitting-an-absorption-spectrum" title="Permalink to this headline">¶</a></h2>
<p>This tool can be used to fit absorption spectra, particularly those
generated using the (<code class="docutils literal"><span class="pre">AbsorptionSpectrum</span></code>) tool. For more details
on its uses and implementation please see (<a class="reference external" href="http://arxiv.org/abs/1307.2244">Egan et al. (2013)</a>). If you find this tool useful we
encourage you to cite accordingly.</p>
</div>
<div class="section" id="loading-an-absorption-spectrum">
<h2>Loading an Absorption Spectrum<a class="headerlink" href="#loading-an-absorption-spectrum" title="Permalink to this headline">¶</a></h2>
<p>To load an absorption spectrum created by
(<code class="xref py py-class docutils literal"><span class="pre">AbsorptionSpectrum`</span></code>),
we specify the output file name. It is advisable to use either an .h5
or .fits file, rather than an ascii file to save the spectrum as rounding
errors produced in saving to a ascii file will negatively impact fit quality.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="s">&#39;spectrum.h5&#39;</span><span class="p">)</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s">&quot;wavelength&quot;</span><span class="p">][:]</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">][:]</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="specifying-species-properties">
<h2>Specifying Species Properties<a class="headerlink" href="#specifying-species-properties" title="Permalink to this headline">¶</a></h2>
<p>Before fitting a spectrum, you must specify the properties of all the
species included when generating the spectrum.</p>
<p>The physical properties needed for each species are the rest wavelength,
f-value, gamma value, and atomic mass. These will be the same values
as used to generate the initial absorption spectrum. These values are
given in list form as some species generate multiple lines (as in the
OVI doublet). The number of lines is also specified on its own.</p>
<p>To fine tune the fitting procedure and give results in a minimal
number of optimizing steps, we specify expected maximum and minimum
values for the column density, doppler parameter, and redshift. These
values can be well outside the range of expected values for a typical line
and are mostly to prevent the algorithm from fitting to negative values
or becoming numerically unstable.</p>
<p>Common initial guesses for doppler parameter and column density should also
be given. These values will not affect the specific values generated by
the fitting algorithm, provided they are in a reasonably appropriate range
(ie: within the range given by the max and min values for the parameter).</p>
<p>For a spectrum containing both the H Lyman-alpha line and the OVI doublet,
we set up a fit as shown below.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">HI_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="s">&#39;HI&#39;</span><span class="p">,</span>
        <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="mi">4164</span><span class="p">],</span>
        <span class="s">&#39;Gamma&#39;</span><span class="p">:[</span><span class="mf">6.265E8</span><span class="p">],</span>
        <span class="s">&#39;wavelength&#39;</span><span class="p">:[</span><span class="mf">1215.67</span><span class="p">],</span>
        <span class="s">&#39;numLines&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;maxN&#39;</span><span class="p">:</span> <span class="mf">1E22</span><span class="p">,</span> <span class="s">&#39;minN&#39;</span><span class="p">:</span><span class="mf">1E11</span><span class="p">,</span>
        <span class="s">&#39;maxb&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s">&#39;minb&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;maxz&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&#39;minz&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;init_b&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
        <span class="s">&#39;init_N&#39;</span><span class="p">:</span><span class="mf">1E14</span><span class="p">}</span>

<span class="n">OVI_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="s">&#39;OVI&#39;</span><span class="p">,</span>
        <span class="s">&#39;f&#39;</span><span class="p">:[</span><span class="o">.</span><span class="mi">1325</span><span class="p">,</span><span class="o">.</span><span class="mo">065</span><span class="mi">80</span><span class="p">],</span>
        <span class="s">&#39;Gamma&#39;</span><span class="p">:[</span><span class="mf">4.148E8</span><span class="p">,</span><span class="mf">4.076E8</span><span class="p">],</span>
        <span class="s">&#39;wavelength&#39;</span><span class="p">:[</span><span class="mf">1031.9261</span><span class="p">,</span><span class="mf">1037.6167</span><span class="p">],</span>
        <span class="s">&#39;numLines&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
        <span class="s">&#39;maxN&#39;</span><span class="p">:</span><span class="mf">1E17</span><span class="p">,</span><span class="s">&#39;minN&#39;</span><span class="p">:</span><span class="mf">1E11</span><span class="p">,</span>
        <span class="s">&#39;maxb&#39;</span><span class="p">:</span><span class="mi">300</span><span class="p">,</span> <span class="s">&#39;minb&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;maxz&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s">&#39;minz&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;init_b&#39;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
        <span class="s">&#39;init_N&#39;</span><span class="p">:</span><span class="mf">1E12</span><span class="p">}</span>

<span class="n">speciesDicts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;HI&#39;</span><span class="p">:</span><span class="n">HI_parameters</span><span class="p">,</span><span class="s">&#39;OVI&#39;</span><span class="p">:</span><span class="n">OVI_parameters</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="generating-fit-of-spectrum">
<h2>Generating Fit of Spectrum<a class="headerlink" href="#generating-fit-of-spectrum" title="Permalink to this headline">¶</a></h2>
<p>After loading a spectrum and specifying the properties of the species
used to generate the spectrum, an apporpriate fit can be generated.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">orderFits</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;OVI&#39;</span><span class="p">,</span><span class="s">&#39;HI&#39;</span><span class="p">]</span>

<span class="n">fitted_lines</span><span class="p">,</span> <span class="n">fitted_flux</span> <span class="o">=</span> <span class="n">generate_total_fit</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span>
    <span class="n">flux</span><span class="p">,</span> <span class="n">orderFits</span><span class="p">,</span> <span class="n">speciesDicts</span><span class="p">)</span>
</pre></div>
</div>
<p>The orderFits variable is used to determine in what order the species
should be fitted. This may affect the results of the resulting fit,
as lines may be fit as an incorrect species. For best results, it is
recommended to fit species the generate multiple lines first, as a fit
will only be accepted if all of the lines are fit appropriately using
a single set of parameters. At the moment no cross correlation between
lines of different species is performed.</p>
<p>The parameters of the lines that are needed to fit the spectrum are contained
in the <code class="docutils literal"><span class="pre">fitted_lines</span></code> variable. Each species given in <code class="docutils literal"><span class="pre">orderFits</span></code> will
be a key in the <code class="docutils literal"><span class="pre">fitted_lines</span></code> dictionary. The entry for each species
key will be another dictionary containing entries for &#8216;N&#8217;,&#8217;b&#8217;,&#8217;z&#8217;, and
&#8216;group#&#8217; which are the column density, doppler parameter, redshift,
and associate line complex respectively. The i <sup>th</sup> line
of a given species is then given by the parameters <code class="docutils literal"><span class="pre">N[i]</span></code>, <code class="docutils literal"><span class="pre">b[i]</span></code>,
and <code class="docutils literal"><span class="pre">z[i]</span></code> and is part of the same complex (and was fitted at the same time)
as all lines with the same group number as <code class="docutils literal"><span class="pre">group#[i]</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">fitted_flux</span></code> is an ndarray of the same size as <code class="docutils literal"><span class="pre">flux</span></code> and
<code class="docutils literal"><span class="pre">wavelength</span></code> that contains the cummulative absorption spectrum generated
by the lines contained in <code class="docutils literal"><span class="pre">fitted_lines</span></code>.</p>
</div>
<div class="section" id="saving-a-spectrum-fit">
<h2>Saving a Spectrum Fit<a class="headerlink" href="#saving-a-spectrum-fit" title="Permalink to this headline">¶</a></h2>
<p>Saving the results of a fitted spectrum for further analysis is
accomplished automatically using the h5 file format. A group
is made for each species that is fit, and each species group has
a group for the corresponding N, b, z, and group# values.</p>
</div>
<div class="section" id="procedure-for-generating-fits">
<span id="fitting-procedure"></span><h2>Procedure for Generating Fits<a class="headerlink" href="#procedure-for-generating-fits" title="Permalink to this headline">¶</a></h2>
<p>To generate a fit for a spectrum
<a class="reference internal" href="../../reference/api/generated/yt.analysis_modules.absorption_spectrum.absorption_spectrum_fit.generate_total_fit.html#yt.analysis_modules.absorption_spectrum.absorption_spectrum_fit.generate_total_fit" title="yt.analysis_modules.absorption_spectrum.absorption_spectrum_fit.generate_total_fit"><code class="xref py py-func docutils literal"><span class="pre">generate_total_fit()</span></code></a>
is called.
This function controls the identification of line complexes, the fit
of a series of absorption lines for each appropriate species, checks of
those fits, and returns the results of the fits.</p>
</div>
<div class="section" id="finding-line-complexes">
<h2>Finding Line Complexes<a class="headerlink" href="#finding-line-complexes" title="Permalink to this headline">¶</a></h2>
<p>Line complexes are found using the
<code class="xref py py-func docutils literal"><span class="pre">find_complexes()</span></code>
function. The process by which line complexes are found involves walking
through the array of flux in order from minimum to maximum wavelength, and
finding series of spatially contiguous cells whose flux is less than some
limit.  These regions are then checked in terms of an additional flux limit
and size.  The bounds of all the passing regions are then listed and returned.
Those bounds that cover an exceptionally large region of wavelength space will
be broken up if a suitable cut point is found. This method is only appropriate
for noiseless spectra.</p>
<p>The optional parameter <code class="docutils literal"><span class="pre">complexLim</span></code> (default = 0.999), controls the limit
that triggers the identification of a spatially contiguous region of flux
that could be a line complex. This number should be very close to 1 but not
exactly equal. It should also be at least an order of magnitude closer to 1
than the later discussed <code class="docutils literal"><span class="pre">fitLim</span></code> parameter, because a line complex where
the flux of the trough is very close to the flux of the edge can be incredibly
unstable when optimizing.</p>
<p>The <code class="docutils literal"><span class="pre">fitLim</span></code> parameter controls what is the maximum flux that the trough
of the region can have and still be considered a line complex. This
effectively controls the sensitivity to very low column absorbers. Default
value is <code class="docutils literal"><span class="pre">fitLim</span></code> = 0.99. If a region is identified where the flux of the
trough is greater than this value, the region is simply ignored.</p>
<p>The <code class="docutils literal"><span class="pre">minLength</span></code> parameter controls the minimum number of array elements
that an identified region must have. This value must be greater than or
equal to 3 as there are a minimum of 3 free parameters that must be fit.
Default is <code class="docutils literal"><span class="pre">minLength</span></code> = 3.</p>
<p>The <code class="docutils literal"><span class="pre">maxLength</span></code> parameter controls the maximum number of array elements
that an identified region can have before it is split into separate regions.
Default is <code class="docutils literal"><span class="pre">maxLength</span></code> = 1000. This should be adjusted based on the
resolution of the spectrum to remain appropriate. The value correspond
to a wavelength of roughly 50 angstroms.</p>
<p>The <code class="docutils literal"><span class="pre">splitLim</span></code> parameter controls how exceptionally large regions are split.
When such a region is identified by having more array elements than
<code class="docutils literal"><span class="pre">maxLength</span></code>, the point of maximum flux (or minimum absorption) in the
middle two quartiles is identified. If that point has a flux greater than
or equal to <code class="docutils literal"><span class="pre">splitLim</span></code>, then two separate complexes are created: one from
the lower wavelength edge to the minimum absorption point and the other from
the minimum absorption point to the higher wavelength edge. The default
value is <code class="docutils literal"><span class="pre">splitLim</span></code> =.99, but it should not drastically affect results, so
long as the value is reasonably close to 1.</p>
</div>
<div class="section" id="fitting-a-line-complex">
<h2>Fitting a Line Complex<a class="headerlink" href="#fitting-a-line-complex" title="Permalink to this headline">¶</a></h2>
<p>After a complex is identified, it is fitted by iteratively adding and
optimizing a set of Voigt Profiles for a particular species until the
region is considered successfully fit. The optimizing is accomplished
using scipy&#8217;s least squares optimizer. This requires an initial estimate
of the parameters to be fit (column density, b-value, redshift) for each
line.</p>
<p>Each time a line is added, the guess of the parameters is based on
the difference between the line complex and the fit so far. For the first line
this just means the initial guess is based solely on the flux of the line
complex. The column density is given by the initial column density given
in the species parameters dictionary. If the line is saturated (some portion
of the flux with a value less than .1) than the larger initial column density
guess is chosen. If the flux is relatively high (all values &gt;.9) than the
smaller initial guess is given. These values are chosen to make optimization
faster and more stable by being closer to the actual value, but the final
results of fitting should not depend on them as they merely provide a
starting point.</p>
<p>After the parameters for a line are optimized for the first time, the
optimized parameters are then used for the initial guess on subsequent
iterations with more lines.</p>
<p>The complex is considered successfully fit when the sum of the squares of
the difference between the flux generated from the fit and the desired flux
profile is less than <code class="docutils literal"><span class="pre">errBound</span></code>. <code class="docutils literal"><span class="pre">errBound</span></code> is related to the optional
parameter to
<code class="xref py py-meth docutils literal"><span class="pre">generate_total_fit()</span></code>,
<code class="docutils literal"><span class="pre">maxAvgError</span></code> by the number of array elements in the region such that
<code class="docutils literal"><span class="pre">errBound</span></code> = number of elements * <code class="docutils literal"><span class="pre">maxAvgError</span></code>.</p>
<p>There are several other conditions under which the cycle of adding and
optimizing lines will halt. If the error of the optimized fit from adding
a line is an order of magnitude worse than the error of the fit without
that line, then it is assumed that the fitting has become unstable and
the latest line is removed. Lines are also prevented from being added if
the total number of lines is greater than the number of elements in the flux
array being fit divided by 3. This is because there must not be more free
parameters in a fit than the number of points to constrain them.</p>
</div>
<div class="section" id="checking-fit-results">
<h2>Checking Fit Results<a class="headerlink" href="#checking-fit-results" title="Permalink to this headline">¶</a></h2>
<p>After an acceptable fit for a region is determined, there are several steps
the algorithm must go through to validate the fits.</p>
<p>First, the parameters must be in a reasonable range. This is a check to make
sure that the optimization did not become unstable and generate a fit that
diverges wildly outside the region where the fit was performed. This way, even
if particular complex cannot be fit, the rest of the spectrum fitting still
behaves as expected. The range of acceptability for each parameter is given
in the species parameter dictionary. These are merely broad limits that will
prevent numerical instability rather than physical limits.</p>
<p>In cases where a single species generates multiple lines (as in the OVI
doublet), the fits are then checked for higher wavelength lines. Originally
the fits are generated only considering the lowest wavelength fit to a region.
This is because we perform the fitting of complexes in order from the lowest
wavelength to the highest, so any contribution to a complex being fit must
come from the lower wavelength as the higher wavelength contributions would
already have been subtracted out after fitting the lower wavelength.</p>
</div>
<div class="section" id="saturated-lyman-alpha-fitting-tools">
<h2>Saturated Lyman Alpha Fitting Tools<a class="headerlink" href="#saturated-lyman-alpha-fitting-tools" title="Permalink to this headline">¶</a></h2>
<p>In cases where a large or saturated line (there exists a point in the complex
where the flux is less than .1) fails to be fit properly at first pass, a
more robust set of fitting tools is used to try and remedy the situation.
The basic approach is to simply try a much wider range of initial parameter
guesses in order to find the true optimization minimum, rather than getting
stuck in a local minimum. A set of hard coded initial parameter guesses
for Lyman alpha lines is given by the function
<code class="xref py py-func docutils literal"><span class="pre">get_test_lines()</span></code>.
Also included in these parameter guesses is an an initial guess of a high
column cool line overlapping a lower column warm line, indictive of a
broad Lyman alpha (BLA) absorber.</p>
</div>
</div>


    </div>
      
  </div>
</div>
    <div class="footer">
      &copy; Copyright 2013, the yt Project.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>