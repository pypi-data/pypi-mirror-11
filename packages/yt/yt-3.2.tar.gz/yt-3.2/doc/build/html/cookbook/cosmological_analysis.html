<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cosmological Analysis &mdash; The yt Project 3.2-dev documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.4/readable/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.2-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="The yt Project 3.2-dev documentation" href="../index.html" />
    <link rel="up" title="The Cookbook" href="index.html" />
    <link rel="next" title="Constructing Data Objects" href="constructing_data_objects.html" />
    <link rel="prev" title="A Few Complex Plots" href="complex_plots.html" />
    
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-391373-2']);
      _gaq.push(['_setDomainName', 'yt-project.org']);
      _gaq.push(['_setAllowHash', false]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><img src="../_static/yt_icon.png">
          The yt Project</a>
        <span class="navbar-text navbar-version pull-left"><b>3.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../help/index.html">How to get help</a></li>
                <li><a href="../quickstart/index.html">Quickstart notebooks</a></li>
                <li><a href="index.html">Cookbook</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Getting and Installing yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installing.html#getting-yt">Getting yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installing.html#testing-your-installation">Testing Your Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installing.html#switching-between-yt-2-x-and-yt-3-x">Switching between yt-2.x and yt-3.x</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">yt Quickstart</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/data_inspection.html">Data Inspection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/simple_visualization.html">Simple Visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/data_objects_and_time_series.html">Data Objects and Time Series</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/derived_fields_and_profiles.html">Derived Fields and Profiles</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart/volume_rendering.html">Volume Rendering</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../yt3differences.html">What&#8217;s New and Different in yt 3.0?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../yt3differences.html#updating-to-yt-3-0-from-old-versions-and-going-back">Updating to yt 3.0 from Old Versions (and going back)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../yt3differences.html#converting-old-scripts-to-work-with-yt-3-0">Converting Old Scripts to Work with yt 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../yt3differences.html#cool-new-things">Cool New Things</a></li>
<li class="toctree-l2"><a class="reference internal" href="../yt3differences.html#api-changes">API Changes</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Cookbook</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#getting-the-sample-data">Getting the Sample Data</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#example-scripts">Example Scripts</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#example-notebooks">Example Notebooks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../visualizing/index.html">Visualizing Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/plots.html">How to Make Plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/callbacks.html">Plot Modifications: Overplotting Contours, Velocities, Particles, and More</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/manual_plotting.html">Using the Manual Plotting Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/volume_rendering.html">Volume Rendering: Making 3D Photorealistic Isocontoured Images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/hardware_volume_rendering.html">Hardware Volume Rendering on NVidia Graphics cards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/sketchfab.html">3D Surfaces and Sketchfab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/mapserver.html">Mapserver - A Google-Maps-like Interface to your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/streamlines.html">Streamlines: Tracking the Trajectories of Tracers in your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/colormaps/index.html">Colormaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../visualizing/writing_fits_images.html">Writing FITS Images</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../analyzing/index.html">General Data Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/fields.html">Fields in yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/creating_derived_fields.html">Creating Derived Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/objects.html">Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/units/index.html">Symbolic Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/filtering.html">Filtering your Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/generating_processed_data.html">Generating Processed Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/time_series_analysis.html">Time Series Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/parallel_computation.html">Parallel Computation With yt</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../analyzing/analysis_modules/index.html">Topic-Specific Analysis Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/analysis_modules/halo_analysis.html">Halo Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/analysis_modules/synthetic_observation.html">Synthetic Observation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/analysis_modules/exporting.html">Exporting to External Radiation Transport Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/analysis_modules/two_point_functions.html">Two Point Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/analysis_modules/clump_finding.html">Clump Finding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/analysis_modules/particle_trajectories.html">Particle Trajectories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analyzing/analysis_modules/ellipsoid_analysis.html">Halo Ellipsoid Analysis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examining/index.html">Loading and Examining Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examining/loading_data.html">Loading Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examining/generic_array_data.html">Loading Generic Array Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examining/generic_particle_data.html">Loading Generic Particle Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examining/spherical_data.html">Loading Spherical Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examining/low_level_inspection.html">Low-Level Data Inspection: Accessing Raw Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developing/index.html">Developing in yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../developing/intro.html">Getting Involved</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/developing.html">How to Develop yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/building_the_docs.html">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/debugdrive.html">Debugging yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/creating_datatypes.html">Creating Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/creating_derived_fields.html">Creating Derived Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/creating_derived_quantities.html">Creating Derived Quantities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/creating_frontend.html">Creating A New Code Frontend</a></li>
<li class="toctree-l2"><a class="reference internal" href="../developing/external_analysis.html">Using yt with External Analysis Tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference Materials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/code_support.html">Code Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/command-line.html">Command-Line Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/api/api.html">API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/configuration.html">Customizing yt: The Configuration and Plugin Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/field_list.html">Field List</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/changelog.html">ChangeLog</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">Frequently Asked Questions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/index.html#version-installation">Version &amp; Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/index.html#code-errors-and-failures">Code Errors and Failures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/index.html#units">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/index.html#fields">Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/index.html#data-objects">Data Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/index.html#developing">Developing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/index.html#miscellaneous">Miscellaneous</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../help/index.html">Getting Help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#don-t-panic-and-don-t-give-up">Don&#8217;t panic and don&#8217;t give up</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#update-to-the-latest-version">Update to the latest version</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#search-the-documentation-faq-and-mailing-lists">Search the documentation, FAQ, and mailing lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#look-at-the-source-code">Look at the source code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#isolate-and-document-your-problem">Isolate and document your problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#go-on-irc-to-ask-a-question">Go on IRC to ask a question</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#ask-the-mailing-list">Ask the mailing list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#submit-a-bug-report">Submit a bug report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../help/index.html#special-issues">Special Issues</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../about/index.html">About yt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../about/index.html#what-is-yt">What is yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about/index.html#who-is-yt">Who is yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about/index.html#history-of-yt">History of yt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about/index.html#how-do-i-contact-yt">How do I contact yt?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about/index.html#how-do-i-cite-yt">How do I cite yt?</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Cosmological Analysis</a><ul>
<li><a class="reference internal" href="#plotting-halos">Plotting Halos</a></li>
<li><a class="reference internal" href="#running-rockstar-to-find-halos-on-multi-resolution-particle-datasets">Running Rockstar to Find Halos on Multi-Resolution-Particle Datasets</a></li>
<li><a class="reference internal" href="#halo-profiling-and-custom-analysis">Halo Profiling and Custom Analysis</a></li>
<li><a class="reference internal" href="#light-cone-projection">Light Cone Projection</a></li>
<li><a class="reference internal" href="#light-ray">Light Ray</a></li>
<li><a class="reference internal" href="#creating-and-fitting-absorption-spectra">Creating and Fitting Absorption Spectra</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="cosmological-analysis">
<h1>Cosmological Analysis<a class="headerlink" href="#cosmological-analysis" title="Permalink to this headline">¶</a></h1>
<p>These scripts demonstrate some basic and more advanced analysis that can be
performed on cosmological simulation datasets.  Most of the following
recipes are derived from functionality in yt&#8217;s <a class="reference internal" href="../analyzing/analysis_modules/index.html#analysis-modules"><span>Topic-Specific Analysis Modules</span></a>.</p>
<div class="section" id="plotting-halos">
<h2>Plotting Halos<a class="headerlink" href="#plotting-halos" title="Permalink to this headline">¶</a></h2>
<p>This is a mechanism for plotting circles representing identified particle halos
on an image.
See <a class="reference internal" href="../analyzing/analysis_modules/halo_analysis.html#halo-analysis"><span>Halo Analysis</span></a> and <a class="reference internal" href="../visualizing/callbacks.html#annotate-halos"><span>Overplot Halo Annotations</span></a> for more information.</p>
<p>(<a class="reference external" href="halo_plotting.py">halo_plotting.py</a>)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">yt</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.halo_analysis.halo_catalog</span> <span class="kn">import</span> <span class="n">HaloCatalog</span>

<span class="c"># Load the dataset</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&quot;Enzo_64/RD0006/RedshiftOutput0006&quot;</span><span class="p">)</span>

<span class="c"># Load the halo list from a rockstar output for this dataset</span>
<span class="n">halos</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;rockstar_halos/halos_0.0.bin&#39;</span><span class="p">)</span>

<span class="c"># Create the halo catalog from this halo list</span>
<span class="n">hc</span> <span class="o">=</span> <span class="n">HaloCatalog</span><span class="p">(</span><span class="n">halos_ds</span><span class="o">=</span><span class="n">halos</span><span class="p">)</span>
<span class="n">hc</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c"># Create a projection with the halos overplot on top</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">ProjectionPlot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;density&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">annotate_halos</span><span class="p">(</span><span class="n">hc</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="running-rockstar-to-find-halos-on-multi-resolution-particle-datasets">
<span id="cookbook-rockstar-nested-grid"></span><h2>Running Rockstar to Find Halos on Multi-Resolution-Particle Datasets<a class="headerlink" href="#running-rockstar-to-find-halos-on-multi-resolution-particle-datasets" title="Permalink to this headline">¶</a></h2>
<p>The version of Rockstar installed with yt does not have the capability
to work on datasets with particles of different masses.  Unfortunately,
many simulations possess particles of different masses, notably cosmological
zoom datasets.  This recipe uses Rockstar in two different ways to generate a
HaloCatalog from the highest resolution dark matter particles (the ones
inside the zoom region).  It then overlays some of those halos on a projection
as a demonstration.  See <a class="reference internal" href="../analyzing/analysis_modules/halo_finders.html#rockstar"><span>Rockstar Halo Finding</span></a> and <a class="reference internal" href="../visualizing/callbacks.html#annotate-halos"><span>Overplot Halo Annotations</span></a> for
more information.</p>
<p>(<a class="reference external" href="rockstar_nest.py">rockstar_nest.py</a>)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># You must run this job in parallel.  </span>
<span class="c"># There are several mpi flags which can be useful in order for it to work OK.</span>
<span class="c"># It requires at least 3 processors in order to run because of the way in which </span>
<span class="c"># rockstar divides up the work.  Make sure you have mpi4py installed as per </span>
<span class="c"># http://yt-project.org/docs/dev/analyzing/parallel_computation.html#setting-up-parallel-yt</span>
    
<span class="c"># Usage: mpirun -np &lt;num_procs&gt; --mca btl ^openib python this_script.py</span>

<span class="kn">import</span> <span class="nn">yt</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.halo_analysis.halo_catalog</span> <span class="kn">import</span> <span class="n">HaloCatalog</span>
<span class="kn">from</span> <span class="nn">yt.data_objects.particle_filters</span> <span class="kn">import</span> <span class="n">add_particle_filter</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.halo_finding.rockstar.api</span> <span class="kn">import</span> <span class="n">RockstarHaloFinder</span>
<span class="n">yt</span><span class="o">.</span><span class="n">enable_parallelism</span><span class="p">()</span> <span class="c"># rockstar halofinding requires parallelism</span>

<span class="c"># Create a dark matter particle filter</span>
<span class="c"># This will be code dependent, but this function here is true for enzo</span>

<span class="k">def</span> <span class="nf">DarkMatter</span><span class="p">(</span><span class="n">pfilter</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="nb">filter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="s">&quot;all&quot;</span><span class="p">,</span> <span class="s">&quot;particle_type&quot;</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">1</span> <span class="c"># DM = 1, Stars = 2</span>
    <span class="k">return</span> <span class="nb">filter</span>

<span class="n">add_particle_filter</span><span class="p">(</span><span class="s">&quot;dark_matter&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">DarkMatter</span><span class="p">,</span> <span class="n">filtered_type</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> \
                    <span class="n">requires</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;particle_type&quot;</span><span class="p">])</span>

<span class="c"># First, we make sure that this script is being run using mpirun with</span>
<span class="c"># at least 3 processors as indicated in the comments above.</span>
<span class="k">assert</span><span class="p">(</span><span class="n">yt</span><span class="o">.</span><span class="n">communication_system</span><span class="o">.</span><span class="n">communicators</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>

<span class="c"># Load the dataset and apply dark matter filter</span>
<span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;Enzo_64/DD0043/data0043&quot;</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">add_particle_filter</span><span class="p">(</span><span class="s">&#39;dark_matter&#39;</span><span class="p">)</span>

<span class="c"># Determine highest resolution DM particle mass in sim by looking</span>
<span class="c"># at the extrema of the dark_matter particle_mass field.</span>
<span class="n">ad</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">all_data</span><span class="p">()</span>
<span class="n">min_dm_mass</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">quantities</span><span class="o">.</span><span class="n">extrema</span><span class="p">((</span><span class="s">&#39;dark_matter&#39;</span><span class="p">,</span><span class="s">&#39;particle_mass&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="c"># Define a new particle filter to isolate all highest resolution DM particles</span>
<span class="c"># and apply it to dataset</span>
<span class="k">def</span> <span class="nf">MaxResDarkMatter</span><span class="p">(</span><span class="n">pfilter</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s">&quot;particle_mass&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">min_dm_mass</span>

<span class="n">add_particle_filter</span><span class="p">(</span><span class="s">&quot;max_res_dark_matter&quot;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">MaxResDarkMatter</span><span class="p">,</span> \
                    <span class="n">filtered_type</span><span class="o">=</span><span class="s">&#39;dark_matter&#39;</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;particle_mass&quot;</span><span class="p">])</span>
<span class="n">ds</span><span class="o">.</span><span class="n">add_particle_filter</span><span class="p">(</span><span class="s">&#39;max_res_dark_matter&#39;</span><span class="p">)</span>

<span class="c"># If desired, we can see the total number of DM and High-res DM particles</span>
<span class="c">#if yt.is_root():</span>
<span class="c">#    print &quot;Simulation has %d DM particles.&quot; % ad[&#39;dark_matter&#39;,&#39;particle_type&#39;].shape</span>
<span class="c">#    print &quot;Simulation has %d Highest Res DM particles.&quot; % ad[&#39;max_res_dark_matter&#39;, &#39;particle_type&#39;].shape</span>

<span class="c"># Run the halo catalog on the dataset only on the highest resolution dark matter </span>
<span class="c"># particles</span>
<span class="n">hc</span> <span class="o">=</span> <span class="n">HaloCatalog</span><span class="p">(</span><span class="n">data_ds</span><span class="o">=</span><span class="n">ds</span><span class="p">,</span> <span class="n">finder_method</span><span class="o">=</span><span class="s">&#39;rockstar&#39;</span><span class="p">,</span> \
                 <span class="n">finder_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;dm_only&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="s">&#39;particle_type&#39;</span><span class="p">:</span><span class="s">&#39;max_res_dark_matter&#39;</span><span class="p">})</span>
<span class="n">hc</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

<span class="c"># Or alternatively, just run the RockstarHaloFinder and later import the </span>
<span class="c"># output file as necessary.  You can skip this step if you&#39;ve already run it</span>
<span class="c"># once, but be careful since subsequent halo finds will overwrite this data.</span>
<span class="c">#rhf = RockstarHaloFinder(ds, particle_type=&quot;max_res_dark_matter&quot;)</span>
<span class="c">#rhf.run()</span>
<span class="c"># Load the halo list from a rockstar output for this dataset</span>
<span class="c"># Create a projection with the halos overplot on top</span>
<span class="c">#halos = yt.load(&#39;rockstar_halos/halos_0.0.bin&#39;)</span>
<span class="c">#hc = HaloCatalog(halos_ds=halos)</span>
<span class="c">#hc.load()</span>

<span class="c"># Regardless of your method of creating the halo catalog, use it to overplot the</span>
<span class="c"># halos on a projection.</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">ProjectionPlot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;density&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">annotate_halos</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">annotate_field</span> <span class="o">=</span> <span class="s">&#39;particle_identifier&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="s">&#39;Mpc&#39;</span><span class="p">),</span> <span class="n">factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="halo-profiling-and-custom-analysis">
<span id="cookbook-halo-finding"></span><h2>Halo Profiling and Custom Analysis<a class="headerlink" href="#halo-profiling-and-custom-analysis" title="Permalink to this headline">¶</a></h2>
<p>This script demonstrates the use of the halo catalog to create radial
profiles for each halo in a cosmological dataset.
See <a class="reference internal" href="../analyzing/analysis_modules/halo_catalogs.html#halo-catalog"><span>Halo Catalogs</span></a> for more information.</p>
<p>(<a class="reference external" href="halo_profiler.py">halo_profiler.py</a>)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">yt</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.halo_analysis.api</span> <span class="kn">import</span> <span class="n">HaloCatalog</span>

<span class="c"># Load the data set with the full simulation information</span>
<span class="c"># and rockstar halos</span>
<span class="n">data_ds</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;Enzo_64/RD0006/RedshiftOutput0006&#39;</span><span class="p">)</span>
<span class="n">halos_ds</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;rockstar_halos/halos_0.0.bin&#39;</span><span class="p">)</span>

<span class="c"># Instantiate a catalog using those two paramter files</span>
<span class="n">hc</span> <span class="o">=</span> <span class="n">HaloCatalog</span><span class="p">(</span><span class="n">data_ds</span><span class="o">=</span><span class="n">data_ds</span><span class="p">,</span> <span class="n">halos_ds</span><span class="o">=</span><span class="n">halos_ds</span><span class="p">)</span>

<span class="c"># Filter out less massive halos</span>
<span class="n">hc</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s">&quot;quantity_value&quot;</span><span class="p">,</span> <span class="s">&quot;particle_mass&quot;</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="mf">1e14</span><span class="p">,</span> <span class="s">&quot;Msun&quot;</span><span class="p">)</span>

<span class="c"># attach a sphere object to each halo whose radius extends</span>
<span class="c">#   to twice the radius of the halo</span>
<span class="n">hc</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="s">&quot;sphere&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

<span class="c"># use the sphere to calculate radial profiles of gas density</span>
<span class="c"># weighted by cell volume in terms of the virial radius</span>
<span class="n">hc</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="s">&quot;profile&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;radius&quot;</span><span class="p">],</span>
                <span class="p">[(</span><span class="s">&quot;gas&quot;</span><span class="p">,</span> <span class="s">&quot;overdensity&quot;</span><span class="p">)],</span>
                <span class="n">weight_field</span><span class="o">=</span><span class="s">&quot;cell_volume&quot;</span><span class="p">,</span>
                <span class="n">accumulation</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">storage</span><span class="o">=</span><span class="s">&quot;virial_quantities_profiles&quot;</span><span class="p">)</span>


<span class="n">hc</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="s">&quot;virial_quantities&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;radius&quot;</span><span class="p">],</span>
                <span class="n">profile_storage</span><span class="o">=</span><span class="s">&quot;virial_quantities_profiles&quot;</span><span class="p">)</span>
<span class="n">hc</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="s">&#39;delete_attribute&#39;</span><span class="p">,</span> <span class="s">&#39;virial_quantities_profiles&#39;</span><span class="p">)</span>

<span class="n">field_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">virial_radius</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;quantity&#39;</span><span class="p">,</span> <span class="s">&#39;radius_200&#39;</span><span class="p">))</span>
<span class="n">hc</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="s">&#39;sphere&#39;</span><span class="p">,</span> <span class="n">radius_field</span><span class="o">=</span><span class="s">&#39;radius_200&#39;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">field_parameters</span><span class="o">=</span><span class="n">field_params</span><span class="p">)</span>
<span class="n">hc</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="s">&#39;profile&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;virial_radius_fraction&#39;</span><span class="p">],</span> 
                <span class="p">[(</span><span class="s">&#39;gas&#39;</span><span class="p">,</span> <span class="s">&#39;temperature&#39;</span><span class="p">)],</span>
                <span class="n">storage</span><span class="o">=</span><span class="s">&#39;virial_profiles&#39;</span><span class="p">,</span>
                <span class="n">weight_field</span><span class="o">=</span><span class="s">&#39;cell_mass&#39;</span><span class="p">,</span>
                <span class="n">accumulation</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="s">&#39;profiles&#39;</span><span class="p">)</span>

<span class="c"># Save the profiles</span>
<span class="n">hc</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="s">&quot;save_profiles&quot;</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="s">&quot;virial_profiles&quot;</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="o">=</span><span class="s">&quot;profiles&quot;</span><span class="p">)</span>

<span class="n">hc</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="light-cone-projection">
<span id="cookbook-light-cone"></span><h2>Light Cone Projection<a class="headerlink" href="#light-cone-projection" title="Permalink to this headline">¶</a></h2>
<p>This script creates a light cone projection, a synthetic observation
that stacks together projections from multiple datasets to extend over
a given redshift interval.
See <a class="reference internal" href="../analyzing/analysis_modules/light_cone_generator.html#light-cone-generator"><span>Light Cone Generator</span></a> for more information.</p>
<p>(<a class="reference external" href="light_cone_projection.py">light_cone_projection.py</a>)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">yt</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.cosmological_observation.api</span> <span class="kn">import</span> \
     <span class="n">LightCone</span>

<span class="c"># Create a LightCone object extending from z = 0 to z = 0.1.</span>

<span class="c"># We have already set up the redshift dumps to be</span>
<span class="c"># used for this, so we will not use any of the time</span>
<span class="c"># data dumps.</span>
<span class="n">lc</span> <span class="o">=</span> <span class="n">LightCone</span><span class="p">(</span><span class="s">&#39;enzo_tiny_cosmology/32Mpc_32.enzo&#39;</span><span class="p">,</span>
               <span class="s">&#39;Enzo&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
               <span class="n">observer_redshift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
               <span class="n">time_data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># Calculate a randomization of the solution.</span>
<span class="n">lc</span><span class="o">.</span><span class="n">calculate_light_cone_solution</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">123456789</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s">&quot;LC/solution.txt&quot;</span><span class="p">)</span>

<span class="c"># Choose the field to be projected.</span>
<span class="n">field</span> <span class="o">=</span> <span class="s">&#39;szy&#39;</span>

<span class="c"># Use the LightCone object to make a projection with a 600 arcminute </span>
<span class="c"># field of view and a resolution of 60 arcseconds.</span>
<span class="c"># Set njobs to -1 to have one core work on each projection</span>
<span class="c"># in parallel.</span>
<span class="n">lc</span><span class="o">.</span><span class="n">project_light_cone</span><span class="p">((</span><span class="mf">600.0</span><span class="p">,</span> <span class="s">&quot;arcmin&quot;</span><span class="p">),</span> <span class="p">(</span><span class="mf">60.0</span><span class="p">,</span> <span class="s">&quot;arcsec&quot;</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span>
                      <span class="n">weight_field</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">save_stack</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">save_final_image</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">save_slice_images</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">njobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># By default, the light cone projections are kept in the LC directory, </span>
<span class="c"># but this moves them back to the current directory so that they&#39;re rendered</span>
<span class="c"># in our cookbook.</span>
<span class="kn">import</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">glob</span>
<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">&#39;LC/*png&#39;</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="light-ray">
<span id="cookbook-light-ray"></span><h2>Light Ray<a class="headerlink" href="#light-ray" title="Permalink to this headline">¶</a></h2>
<p>This script demonstrates how to make a synthetic quasar sight line that
extends over multiple datasets and can be used to generate a synthetic
absorption spectrum.
See <a class="reference internal" href="../analyzing/analysis_modules/light_ray_generator.html#light-ray-generator"><span>Light Ray Generator</span></a> and <a class="reference internal" href="../analyzing/analysis_modules/absorption_spectrum.html#absorption-spectrum"><span>Absorption Spectrum</span></a> for more information.</p>
<p>(<a class="reference external" href="light_ray.py">light_ray.py</a>)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yt</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.cosmological_observation.api</span> <span class="kn">import</span> \
    <span class="n">LightRay</span>

<span class="c"># Create a directory for the light rays</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&quot;LR&quot;</span><span class="p">):</span> 
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">&#39;LR&#39;</span><span class="p">)</span>
     
<span class="c"># Create a LightRay object extending from z = 0 to z = 0.1</span>
<span class="c"># and use only the redshift dumps.</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LightRay</span><span class="p">(</span><span class="s">&quot;enzo_tiny_cosmology/32Mpc_32.enzo&quot;</span><span class="p">,</span>
              <span class="s">&#39;Enzo&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">use_minimum_datasets</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">time_data</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># Make a light ray, and set njobs to -1 to use one core</span>
<span class="c"># per dataset.</span>
<span class="n">lr</span><span class="o">.</span><span class="n">make_light_ray</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">123456789</span><span class="p">,</span>
                  <span class="n">solution_filename</span><span class="o">=</span><span class="s">&#39;LR/lightraysolution.txt&#39;</span><span class="p">,</span>
                  <span class="n">data_filename</span><span class="o">=</span><span class="s">&#39;LR/lightray.h5&#39;</span><span class="p">,</span>
                  <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;temperature&#39;</span><span class="p">,</span> <span class="s">&#39;density&#39;</span><span class="p">],</span>
                  <span class="n">get_los_velocity</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">njobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Optionally, we can now overplot the part of this ray that intersects </span>
<span class="c"># one output from the source dataset in a ProjectionPlot</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;enzo_tiny_cosmology/RD0004/RD0004&#39;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">ProjectionPlot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="s">&#39;density&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">annotate_ray</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>This script demontrates how to make a light ray from a single dataset.</p>
<p id="cookbook-single-dataset-light-ray">(<a class="reference external" href="single_dataset_light_ray.py">single_dataset_light_ray.py</a>)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yt</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.cosmological_observation.api</span> <span class="kn">import</span> \
    <span class="n">LightRay</span>

<span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;IsolatedGalaxy/galaxy0030/galaxy0030&quot;</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LightRay</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

<span class="c"># With a single dataset, a start_position and </span>
<span class="c"># end_position or trajectory must be given.</span>
<span class="c"># Trajectory should be given as (r, theta, phi)</span>
<span class="n">lr</span><span class="o">.</span><span class="n">make_light_ray</span><span class="p">(</span><span class="n">start_position</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                  <span class="n">end_position</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
                  <span class="n">solution_filename</span><span class="o">=</span><span class="s">&#39;lightraysolution.txt&#39;</span><span class="p">,</span>
                  <span class="n">data_filename</span><span class="o">=</span><span class="s">&#39;lightray.h5&#39;</span><span class="p">,</span>
                  <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;temperature&#39;</span><span class="p">,</span> <span class="s">&#39;density&#39;</span><span class="p">],</span>
                  <span class="n">get_los_velocity</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c"># Optionally, we can now overplot this ray on a projection of the source </span>
<span class="c"># dataset</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">ProjectionPlot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s">&#39;z&#39;</span><span class="p">,</span> <span class="s">&#39;density&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">annotate_ray</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-and-fitting-absorption-spectra">
<h2>Creating and Fitting Absorption Spectra<a class="headerlink" href="#creating-and-fitting-absorption-spectra" title="Permalink to this headline">¶</a></h2>
<p>This script demonstrates how to use light rays to create corresponding
absorption spectra and then fit the spectra to find absorbing
structures.
See <a class="reference internal" href="../analyzing/analysis_modules/light_ray_generator.html#light-ray-generator"><span>Light Ray Generator</span></a> and <a class="reference internal" href="../analyzing/analysis_modules/absorption_spectrum.html#absorption-spectrum"><span>Absorption Spectrum</span></a> for more information.</p>
<p>(<a class="reference external" href="fit_spectrum.py">fit_spectrum.py</a>)</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">yt</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.cosmological_observation.light_ray.api</span> <span class="kn">import</span> <span class="n">LightRay</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.absorption_spectrum.api</span> <span class="kn">import</span> <span class="n">AbsorptionSpectrum</span>
<span class="kn">from</span> <span class="nn">yt.analysis_modules.absorption_spectrum.api</span> <span class="kn">import</span> <span class="n">generate_total_fit</span>

<span class="c"># Define a field to simulate OVI based on a constant relationship to HI</span>
<span class="c"># Do *NOT* use this for science, because this is not how OVI actually behaves;</span>
<span class="c"># it is just an example.</span>

<span class="k">def</span> <span class="nf">_OVI_number_density</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;H_number_density&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">2.0</span>

<span class="c"># Define a function that will accept a ds and add the new field </span>
<span class="c"># defined above.  This will be given to the LightRay below.</span>
<span class="k">def</span> <span class="nf">setup_ds</span><span class="p">(</span><span class="n">ds</span><span class="p">):</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s">&quot;O_p5_number_density&quot;</span><span class="p">,</span> 
                 <span class="n">function</span><span class="o">=</span><span class="n">_OVI_number_density</span><span class="p">,</span>
                 <span class="n">units</span><span class="o">=</span><span class="s">&quot;cm**-3&quot;</span><span class="p">)</span>

<span class="c"># Define species and associated parameters to add to continuum</span>
<span class="c"># Parameters used for both adding the transition to the spectrum</span>
<span class="c"># and for fitting</span>
<span class="c"># Note that for single species that produce multiple lines</span>
<span class="c"># (as in the OVI doublet), &#39;numLines&#39; will be equal to the number</span>
<span class="c"># of lines, and f,gamma, and wavelength will have multiple values.</span>

<span class="n">HI_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;HI&#39;</span><span class="p">,</span>
                 <span class="s">&#39;field&#39;</span><span class="p">:</span> <span class="s">&#39;H_number_density&#39;</span><span class="p">,</span>
                 <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="mi">4164</span><span class="p">],</span>
                 <span class="s">&#39;Gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.265E8</span><span class="p">],</span>
                 <span class="s">&#39;wavelength&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1215.67</span><span class="p">],</span>
                 <span class="s">&#39;mass&#39;</span><span class="p">:</span> <span class="mf">1.00794</span><span class="p">,</span>
                 <span class="s">&#39;numLines&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s">&#39;maxN&#39;</span><span class="p">:</span> <span class="mf">1E22</span><span class="p">,</span> <span class="s">&#39;minN&#39;</span><span class="p">:</span> <span class="mf">1E11</span><span class="p">,</span>
                 <span class="s">&#39;maxb&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s">&#39;minb&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                 <span class="s">&#39;maxz&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&#39;minz&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                 <span class="s">&#39;init_b&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
                 <span class="s">&#39;init_N&#39;</span><span class="p">:</span> <span class="mf">1E14</span><span class="p">}</span>

<span class="n">OVI_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;OVI&#39;</span><span class="p">,</span>
                  <span class="s">&#39;field&#39;</span><span class="p">:</span> <span class="s">&#39;O_p5_number_density&#39;</span><span class="p">,</span>
                  <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="mi">1325</span><span class="p">,</span> <span class="o">.</span><span class="mo">065</span><span class="mi">80</span><span class="p">],</span>
                  <span class="s">&#39;Gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.148E8</span><span class="p">,</span> <span class="mf">4.076E8</span><span class="p">],</span>
                  <span class="s">&#39;wavelength&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1031.9261</span><span class="p">,</span> <span class="mf">1037.6167</span><span class="p">],</span>
                  <span class="s">&#39;mass&#39;</span><span class="p">:</span> <span class="mf">15.9994</span><span class="p">,</span>
                  <span class="s">&#39;numLines&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="s">&#39;maxN&#39;</span><span class="p">:</span> <span class="mf">1E17</span><span class="p">,</span> <span class="s">&#39;minN&#39;</span><span class="p">:</span> <span class="mf">1E11</span><span class="p">,</span>
                  <span class="s">&#39;maxb&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s">&#39;minb&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="s">&#39;maxz&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s">&#39;minz&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="s">&#39;init_b&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                  <span class="s">&#39;init_N&#39;</span><span class="p">:</span> <span class="mf">1E12</span><span class="p">}</span>

<span class="n">species_dicts</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;HI&#39;</span><span class="p">:</span> <span class="n">HI_parameters</span><span class="p">,</span> <span class="s">&#39;OVI&#39;</span><span class="p">:</span> <span class="n">OVI_parameters</span><span class="p">}</span>

<span class="c"># Create a LightRay object extending from z = 0 to z = 0.1</span>
<span class="c"># and use only the redshift dumps.</span>
<span class="n">lr</span> <span class="o">=</span> <span class="n">LightRay</span><span class="p">(</span><span class="s">&#39;enzo_cosmology_plus/AMRCosmology.enzo&#39;</span><span class="p">,</span>
              <span class="s">&#39;Enzo&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">use_minimum_datasets</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">time_data</span><span class="o">=</span><span class="bp">False</span>
              <span class="p">)</span>

<span class="c"># Get all fields that need to be added to the light ray</span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;temperature&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">species_dicts</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;field&#39;</span><span class="p">])</span>

<span class="c"># Make a light ray, and set njobs to -1 to use one core</span>
<span class="c"># per dataset.</span>
<span class="n">lr</span><span class="o">.</span><span class="n">make_light_ray</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">123456780</span><span class="p">,</span>
                  <span class="n">solution_filename</span><span class="o">=</span><span class="s">&#39;lightraysolution.txt&#39;</span><span class="p">,</span>
                  <span class="n">data_filename</span><span class="o">=</span><span class="s">&#39;lightray.h5&#39;</span><span class="p">,</span>
                  <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">setup_function</span><span class="o">=</span><span class="n">setup_ds</span><span class="p">,</span>
                  <span class="n">get_los_velocity</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">njobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># Create an AbsorptionSpectrum object extending from</span>
<span class="c"># lambda = 900 to lambda = 1800, with 10000 pixels</span>
<span class="n">sp</span> <span class="o">=</span> <span class="n">AbsorptionSpectrum</span><span class="p">(</span><span class="mf">900.0</span><span class="p">,</span> <span class="mf">1400.0</span><span class="p">,</span> <span class="mi">50000</span><span class="p">)</span>

<span class="c"># Iterate over species</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">species_dicts</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="c"># Iterate over transitions for a single species</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;numLines&#39;</span><span class="p">]):</span>
        <span class="c"># Add the lines to the spectrum</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;field&#39;</span><span class="p">],</span>
                    <span class="n">params</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;f&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">params</span><span class="p">[</span><span class="s">&#39;Gamma&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;mass&#39;</span><span class="p">],</span>
                    <span class="n">label_threshold</span><span class="o">=</span><span class="mf">1.e10</span><span class="p">)</span>


<span class="c"># Make and save spectrum</span>
<span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">make_spectrum</span><span class="p">(</span><span class="s">&#39;lightray.h5&#39;</span><span class="p">,</span>
                                    <span class="n">output_file</span><span class="o">=</span><span class="s">&#39;spectrum.h5&#39;</span><span class="p">,</span>
                                    <span class="n">line_list_file</span><span class="o">=</span><span class="s">&#39;lines.txt&#39;</span><span class="p">,</span>
                                    <span class="n">use_peculiar_velocity</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="c"># Define order to fit species in</span>
<span class="n">order_fits</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;OVI&#39;</span><span class="p">,</span> <span class="s">&#39;HI&#39;</span><span class="p">]</span>

<span class="c"># Fit spectrum and save fit</span>
<span class="n">fitted_lines</span><span class="p">,</span> <span class="n">fitted_flux</span> <span class="o">=</span> <span class="n">generate_total_fit</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span>
                                               <span class="n">flux</span><span class="p">,</span> <span class="n">order_fits</span><span class="p">,</span> <span class="n">species_dicts</span><span class="p">,</span>
                                               <span class="n">output_file</span><span class="o">=</span><span class="s">&#39;spectrum_fit.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
    <div class="footer">
      &copy; Copyright 2013, the yt Project.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>