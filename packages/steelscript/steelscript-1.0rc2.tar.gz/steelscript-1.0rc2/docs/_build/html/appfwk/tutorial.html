<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>9.11. Writing a Plugin &mdash; steelscript  documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../_static/extra.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="steelscript  documentation" href="../index.html" />
    <link rel="up" title="9. SteelScript Application Framework" href="toc.html" />
    <link rel="next" title="9.12. Analysis Tables" href="analysis.html" />
    <link rel="prev" title="9.10. Plugins" href="plugins.html" />
    <script type="text/javascript" src="//nexus.ensighten.com/riverbed/rvbss/Bootstrap.js"></script>
     

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="analysis.html" title="9.12. Analysis Tables"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="plugins.html" title="9.10. Plugins"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">steelscript  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../toc.html" >Table of Contents</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="toc.html" accesskey="U">9. SteelScript Application Framework</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="writing-a-plugin">
<span id="plugin-tutorial"></span><h1>9.11. Writing a Plugin<a class="headerlink" href="#writing-a-plugin" title="Permalink to this headline">¶</a></h1>
<p>This tutorial presents a step-by-step description of how to develop a
SteelScript App Framework  plugin. No tutorial can be as useful as an example.
Therefore, in this tutorial, a steelscript-stock plugin is used to explain
the process of how to construct SteelScript App Framework plugin. Note that
the stock data is fetched from yahoo finance API as a third party resource.
By changing the data source as well as modifying the reports, App Framework
plugin can be used to display data from almost any where, such as a csv file,
a rest API or a device with reporting capability, etc.</p>
<div class="section" id="creating-the-skeleton-of-a-plugin">
<h2>9.11.1. Creating the skeleton of a plugin<a class="headerlink" href="#creating-the-skeleton-of-a-plugin" title="Permalink to this headline">¶</a></h2>
<p>First we need to run the command <code class="docutils literal"><span class="pre">steel</span> <span class="pre">appfwk</span> <span class="pre">mkplugin</span></code> in a shell:</p>
<div class="highlight-python"><div class="highlight"><pre>$ cd /tmp
$ steel appfwk mkplugin
Give a simple name for your plugin (a-z, 0-9, _): stock
Give your plugin a title []: Steelscript Stock
Briefly describe your plugin []: Steelscript Stock App Framework Plugin
Author&#39;s name []: author
Author&#39;s email []: email
Writing:  /private/tmp/steelscript-stock/LICENSE
Writing:  /private/tmp/steelscript-stock/MANIFEST.in
Writing:  /private/tmp/steelscript-stock/README.rst
Writing:  /private/tmp/steelscript-stock/setup.py
Writing:  /private/tmp/steelscript-stock/gitpy_versioning/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/admin.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/models.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/plugin.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/datasources/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/datasources/stock_source.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/devices/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/devices/stock_device.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/libs/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/reports/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/appfwk/reports/stock_report.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/commands/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/commands/README.rst
Writing:  /private/tmp/steelscript-stock/steelscript/stock/commands/subcommand.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/core/__init__.py
Writing:  /private/tmp/steelscript-stock/steelscript/stock/core/README.rst
Checking if git is installed...done
Initializing project as git repo...done
Creating initial git commit...done
Tagging as release 0.0.1...done
</pre></div>
</div>
</div>
<div class="section" id="installing-from-source">
<h2>9.11.2. Installing from source<a class="headerlink" href="#installing-from-source" title="Permalink to this headline">¶</a></h2>
<p>Once you have created the source tree of you plugin, you need to install it as below.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>steelscript-stock
<span class="nv">$ </span>pip install -e .
</pre></div>
</div>
<p>Details about installing steelscript plugin can be found
<a class="reference internal" href="plugins.html#installing-a-plugin"><span>Installing a plugin</span></a>.</p>
</div>
<div class="section" id="developing-data-fetch-api">
<span id="data-fetch-api"></span><h2>9.11.3. Developing data fetch API<a class="headerlink" href="#developing-data-fetch-api" title="Permalink to this headline">¶</a></h2>
<p>You need to develop an API to fetch data to feed the App Framework engine. This step is recommended
to be done early as we can understand better the data format, which would help define the
structure of the App Framework reports later.</p>
<p>First we need to create a python module app.py in steelscript/stock/core directory. The reason
the module <code class="docutils literal"><span class="pre">app.py</span></code> resides in <code class="docutils literal"><span class="pre">core</span></code> directory instead of <code class="docutils literal"><span class="pre">appfwk</span></code> directory is that the API can
be used independently without App Framework. Below shows how a stock data API might look like.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">steelscript.common.timeutils</span> <span class="kn">import</span> <span class="n">TimeParser</span>
<span class="kn">from</span> <span class="nn">steelscript.common.connection</span> <span class="kn">import</span> <span class="n">Connection</span>

<span class="c"># Mapping from price measure to the relative position</span>
<span class="c"># in the response string</span>
<span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;open&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
           <span class="s">&#39;high&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
           <span class="s">&#39;low&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
           <span class="s">&#39;close&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
           <span class="s">&#39;volume&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>

<span class="n">tp</span> <span class="o">=</span> <span class="n">TimeParser</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">parse_date</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tp</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date</span> <span class="o">+</span> <span class="s">&quot; 00:00&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StockApiException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">get_historical_prices</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span>
                          <span class="n">resolution</span><span class="o">=</span><span class="s">&#39;day&#39;</span><span class="p">,</span> <span class="n">date_obj</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get historical prices for the given ticker symbol.</span>
<span class="sd">    Returns a list of dicts keyed by &#39;date&#39; and measures</span>

<span class="sd">    :param string begin: begin date of the inquire interval</span>
<span class="sd">      in the format of YYYY-MM-DD</span>
<span class="sd">    :param string end: end date of the inquire interval</span>
<span class="sd">      in the format of YYYY-MM-DD</span>
<span class="sd">    :param string symbol: symbol of one stock to query</span>
<span class="sd">    :param list measures: a list of prices that needs to be queried,</span>
<span class="sd">      should be a subset of [&quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;]</span>
<span class="sd">    :param string resolution: &#39;day&#39; or &#39;week&#39;</span>
<span class="sd">    :param boolean date_obj: dates are converted to datetime objects</span>
<span class="sd">      from date strings if True. Otherwise, dates are stored as strings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="s">&#39;http://ichart.finance.yahoo.com&#39;</span><span class="p">)</span>
    <span class="n">start_month</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">start_day</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">day</span>
    <span class="n">start_year</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">begin</span><span class="p">)</span><span class="o">.</span><span class="n">year</span>
    <span class="n">end_month</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">end_day</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">day</span>
    <span class="n">end_year</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">year</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
              <span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="n">start_month</span><span class="p">,</span>
              <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="n">start_day</span><span class="p">,</span>
              <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="n">start_year</span><span class="p">,</span>
              <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="n">end_month</span><span class="p">,</span>
              <span class="s">&#39;e&#39;</span><span class="p">:</span> <span class="n">end_day</span><span class="p">,</span>
              <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="n">end_year</span><span class="p">,</span>
              <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="s">&#39;ignore&#39;</span><span class="p">:</span><span class="s">&#39;.csv&#39;</span><span class="p">}</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s">&#39;/table.csv&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

    <span class="c"># extract data and skip first row with column titles</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">iter_lines</span><span class="p">())[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c"># iterate over the data backwards as the daily prices are sorted</span>
    <span class="c"># backwards by the dates</span>
    <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="c"># day is a string with date, prices, volume separated by commas,</span>
        <span class="c"># &#39;&lt;date&gt;,&lt;open&gt;,&lt;high&gt;,&lt;low&gt;,&lt;close&gt;,&lt;volume&gt;,&lt;adj_close&gt;&#39;</span>
        <span class="c"># as &#39;2014-02-19,20.22,20.55,20.11,20.50,1599600,20.50&#39;</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">day</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">parse_date</span><span class="p">(</span><span class="n">day</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">date_obj</span> <span class="k">else</span> <span class="n">day</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">daily_prices</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
                <span class="n">daily_prices</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">day</span><span class="p">[</span><span class="n">mapping</span><span class="p">[</span><span class="n">m</span><span class="p">]])</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daily_prices</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>
</pre></div>
</div>
<p>The above function get_historical_prices leverages the yahoo stock api to get the
daily transaction volumes as well as daily prices (including high, low, open and close)
for a stock within a date range. The return date format is a list of python dicts, with
each dict represent the data of the stock for one day.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">steelscript.stock.core.app</span> <span class="kn">import</span> <span class="n">get_historical_prices</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="p">(</span><span class="n">get_historical_prices</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="s">&#39;2015-04-01&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;2015-04-05&#39;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s">&#39;rvbd&#39;</span><span class="p">,</span> <span class="n">measures</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;open&#39;</span><span class="p">,</span><span class="s">&#39;close&#39;</span><span class="p">,</span> <span class="s">&#39;high&#39;</span><span class="p">,</span> <span class="s">&#39;low&#39;</span><span class="p">,</span><span class="s">&#39;volume&#39;</span><span class="p">]))</span>
<span class="go">[{&#39;close&#39;: 20.92,</span>
<span class="go">  &#39;date&#39;: &#39;2015-04-01&#39;,</span>
<span class="go">  &#39;high&#39;: 20.92,</span>
<span class="go">  &#39;low&#39;: 20.9,</span>
<span class="go">  &#39;open&#39;: 20.91,</span>
<span class="go">  &#39;volume&#39;: 1754900.0},</span>
<span class="go"> {&#39;close&#39;: 20.92,</span>
<span class="go">  &#39;date&#39;: &#39;2015-04-02&#39;,</span>
<span class="go">  &#39;high&#39;: 20.94,</span>
<span class="go">  &#39;low&#39;: 20.9,</span>
<span class="go">  &#39;open&#39;: 20.91,</span>
<span class="go">  &#39;volume&#39;: 1851400.0},</span>
<span class="go"> {&#39;close&#39;: 20.92,</span>
<span class="go">  &#39;date&#39;: &#39;2015-04-03&#39;,</span>
<span class="go">  &#39;high&#39;: 20.92,</span>
<span class="go">  &#39;low&#39;: 20.92,</span>
<span class="go">  &#39;open&#39;: 20.92,</span>
<span class="go">  &#39;volume&#39;: 0.0}]</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-app-framework-reports">
<h2>9.11.4. Creating App Framework reports<a class="headerlink" href="#creating-app-framework-reports" title="Permalink to this headline">¶</a></h2>
<p>From the above API, we can see that in order to generate stock data, we need to pass in
parameters, including stock symbol, start date, end date, the price names, resolution.
The returned data can have information such as dates, daily (include open, close
high, low) prices, and daily transaction volumes.</p>
<p>Now that the data format has been understood, one can set out to create the Application
Framework components for reports. The first step will be defining a data source, which
sets up the required criteria fields for users to input, and then extract data using the
<a class="reference internal" href="#data-fetch-api"><span>API</span></a> based on the input criteria values. Then we need to write the
report using the defined data source to render the data. For illustrative purpose, let us
build a simple report that can show the close price of a stock given a range of dates.</p>
<div class="section" id="writing-data-source">
<h3>9.11.4.1. Writing data source<a class="headerlink" href="#writing-data-source" title="Permalink to this headline">¶</a></h3>
<p>The generated stock_source.py has included some skeleton code, including
the declaration of the <code class="docutils literal"><span class="pre">StockColumn</span></code> class, the <code class="docutils literal"><span class="pre">StockTable</span></code> class and the <code class="docutils literal"><span class="pre">StockQuery</span></code> class.
For normal reports, there is no need to modify the <code class="docutils literal"><span class="pre">StockColumn</span></code> class. We need to
modify the <code class="docutils literal"><span class="pre">StockTable</span></code> class in order to add criteria, which maps to the parameters passed
to the data fetch API. Details are shown below.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">steelscript.appfwk.apps.datasource.models</span> <span class="kn">import</span> <span class="n">TableField</span>
<span class="kn">from</span> <span class="nn">steelscript.appfwk.apps.datasource.forms</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DateTimeField</span><span class="p">,</span> <span class="n">ReportSplitDateWidget</span><span class="p">,</span>
                                                      <span class="n">fields_add_time_selection</span><span class="p">,</span> <span class="n">fields_add_resolution</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">steelscript.appfwk.apps.datasource.models</span> <span class="kn">import</span> <span class="n">TableField</span><span class="p">,</span> <span class="n">DatasourceTable</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">steelscript.appfwk.apps.jobs</span> <span class="kn">import</span> <span class="n">QueryComplete</span>

<span class="k">class</span> <span class="nc">StockColumn</span><span class="p">(</span><span class="n">Column</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">COLUMN_OPTIONS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">class</span> <span class="nc">StockTable</span><span class="p">(</span><span class="n">DatasourceTable</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># When a custom column is used, it must be linked</span>
    <span class="n">_column_class</span> <span class="o">=</span> <span class="s">&#39;StockColumn&#39;</span>

    <span class="c"># Using StockQuery class to extract data</span>
    <span class="n">_query_class</span> <span class="o">=</span> <span class="s">&#39;StockQuery&#39;</span>

    <span class="c"># TABLE_OPTIONS is a dictionary of options that are specific to</span>
    <span class="c"># StockQuery objects in this file.  These will be overridden by</span>
    <span class="c"># keyword arguments to the StockTable.create() call in a report</span>
    <span class="c"># file</span>
    <span class="n">TABLE_OPTIONS</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>

    <span class="c"># FIELD_OPTIONS is a dictionary of default values for field</span>
    <span class="c"># options.  These by be overridden by keyword arguments to the</span>
    <span class="c"># StockTable.create() call in a report file</span>
    <span class="n">FIELD_OPTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;duration&#39;</span><span class="p">:</span> <span class="s">&#39;4w&#39;</span><span class="p">,</span>
                     <span class="s">&#39;durations&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;4w&#39;</span><span class="p">,</span> <span class="s">&#39;12w&#39;</span><span class="p">,</span> <span class="s">&#39;24w&#39;</span><span class="p">,</span> <span class="s">&#39;52w&#39;</span><span class="p">,</span> <span class="s">&#39;260w&#39;</span><span class="p">,</span> <span class="s">&#39;520w&#39;</span><span class="p">),</span>
                     <span class="s">&#39;resolution&#39;</span><span class="p">:</span> <span class="s">&#39;day&#39;</span><span class="p">,</span>
                     <span class="s">&#39;resolutions&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;day&#39;</span><span class="p">,</span> <span class="s">&#39;week&#39;</span><span class="p">)</span>
                     <span class="p">}</span>

    <span class="k">def</span> <span class="nf">post_process_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_options</span><span class="p">):</span>
        <span class="c"># Add a time selection field</span>
        <span class="n">fields_add_time_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_end</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                  <span class="n">initial_duration</span><span class="o">=</span><span class="n">field_options</span><span class="p">[</span><span class="s">&#39;duration&#39;</span><span class="p">],</span>
                                  <span class="n">durations</span><span class="o">=</span><span class="n">field_options</span><span class="p">[</span><span class="s">&#39;durations&#39;</span><span class="p">])</span>

        <span class="c"># Add time resolution selection</span>
        <span class="n">fields_add_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">initial</span><span class="o">=</span><span class="n">field_options</span><span class="p">[</span><span class="s">&#39;resolution&#39;</span><span class="p">],</span>
                              <span class="n">resolutions</span><span class="o">=</span><span class="n">field_options</span><span class="p">[</span><span class="s">&#39;resolutions&#39;</span><span class="p">])</span>

        <span class="c"># Add end date field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_add_end_date</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_add_stock_symbol</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">fields_add_stock_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s">&#39;stock_symbol&#39;</span><span class="p">,</span>
                                <span class="n">initial</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">TableField</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">keyword</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s">&#39;Stock Symbol&#39;</span><span class="p">,</span>
                           <span class="n">initial</span><span class="o">=</span><span class="n">initial</span><span class="p">,</span>
                           <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">field</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fields_add_end_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_end_date</span><span class="o">=</span><span class="s">&#39;now-0&#39;</span><span class="p">):</span>
        <span class="c"># Add a date field</span>
        <span class="c"># the front javascript code will determine the default date</span>
        <span class="c"># according to initial_end_date, so if initial_end_date is</span>
        <span class="c"># &#39;now-0&#39;, today will be the default end date</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">TableField</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s">&#39;end_date&#39;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="s">&#39;End Date&#39;</span><span class="p">,</span>
                           <span class="n">field_cls</span><span class="o">=</span><span class="n">DateTimeField</span><span class="p">,</span>
                           <span class="n">field_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;widget&#39;</span><span class="p">:</span> <span class="n">ReportSplitDateWidget</span><span class="p">,</span>
                                         <span class="s">&#39;widget_attrs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;initial_date&#39;</span><span class="p">:</span>
                                                          <span class="n">initial_end_date</span><span class="p">}},</span>
                           <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">field</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</pre></div>
</div>
<p>From the above, it can be seen that the function <code class="docutils literal"><span class="pre">post_process_table</span></code> in the <code class="docutils literal"><span class="pre">StockTable</span></code> class
defines the criteria fields. There are four fields added, including duration, end date, stock symbol
and resolution (the start date can be figured out using end date and duration). The values of
duration and resolution are limited to a few.</p>
<p>After the <code class="docutils literal"><span class="pre">StockTable</span></code> class in the same module, we need to define the <code class="docutils literal"><span class="pre">run</span></code> method in
<code class="docutils literal"><span class="pre">StockQuery</span></code> class, which is about using the values from the criteria fields in the
<code class="docutils literal"><span class="pre">StockTable</span></code> class to derive the data by leveraging the
<a class="reference internal" href="#data-fetch-api"><span>data fetch API</span></a>. See below for details:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">pandas</span>

<span class="kn">from</span> <span class="nn">steelscript.stock.core.app</span> <span class="kn">import</span> <span class="n">get_historical_prices</span>
<span class="kn">from</span> <span class="nn">steelscript.appfwk.apps.datasource.models</span> <span class="kn">import</span> <span class="n">TableField</span><span class="p">,</span> <span class="n">TableQueryBase</span>

<span class="k">class</span> <span class="nc">StockQuery</span><span class="p">(</span><span class="n">TableQueryBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">job</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">criteria</span>

        <span class="c"># These are date time strings in the format of YYYY-MM-DD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">criteria</span><span class="o">.</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">criteria</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">criteria</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>

        <span class="c"># resolution is either &#39;day&#39; or &#39;week&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="s">&#39;day&#39;</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">criteria</span><span class="o">.</span><span class="n">resolution</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;1 day&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;week&#39;</span>

        <span class="c"># stock symbol string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">stock_symbol</span>

        <span class="c"># Dict storing stock prices/volumes according to specific report</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">get_historical_prices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;close&#39;</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="n">date_obj</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prices</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">QueryComplete</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This method only returns a <code class="docutils literal"><span class="pre">QueryComplete</span></code> object with a <code class="docutils literal"><span class="pre">pandas.DataFrame</span></code>
object as an attribute after it is successful. If this function failed or no data is
obtained, an error message will be presented in App Framework widget.</p>
</div>
</div>
<div class="section" id="writing-reports">
<h3>9.11.4.2. Writing Reports<a class="headerlink" href="#writing-reports" title="Permalink to this headline">¶</a></h3>
<p>After finishing off writing data sources, finally it is time to collect results.
In &lt;plugin&gt;/appfwk/reports/stock_report.py, we first need to define a report and
create a section asscociated with it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">steelscript.appfwk.apps.report.models</span> <span class="kn">import</span> <span class="n">Report</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">&quot;Stock Report&quot;</span><span class="p">)</span>
<span class="n">report</span><span class="o">.</span><span class="n">add_section</span><span class="p">()</span>
</pre></div>
</div>
<p>Next step is to instantiate the <code class="docutils literal"><span class="pre">StockTable</span></code> class and add columns to the table object.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">steelscript.stock.appfwk.datasources.stock_source</span> <span class="kn">as</span> <span class="nn">stock</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">stock</span><span class="o">.</span><span class="n">StockTable</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;stock-close-price&#39;</span><span class="p">,</span>
                                <span class="n">duration</span><span class="o">=</span><span class="s">&#39;52w&#39;</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s">&#39;day&#39;</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="s">&#39;Date&#39;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s">&#39;date&#39;</span><span class="p">,</span> <span class="n">iskey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s">&#39;close&#39;</span><span class="p">,</span> <span class="s">&#39;Close Price&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When creating the stock table object, the passed-in duration and resolution values need to be
one of the few options listed in <code class="docutils literal"><span class="pre">FIELD_OPTIONS</span></code> in <code class="docutils literal"><span class="pre">StockTable</span></code> class. When adding columns to the
table, the first parameter, representing the name of the column, needs to be one of the keys in the dict
returned by the <a class="reference internal" href="#data-fetch-api"><span>Data fetch API</span></a>. For <code class="docutils literal"><span class="pre">date</span></code> column, the <code class="docutils literal"><span class="pre">datatype</span></code> parameter
needs to be &#8216;date&#8217;. Since we plan to plot the data against the dates, the <code class="docutils literal"><span class="pre">date</span></code> column needs to
be specified as the key column, as done by setting <code class="docutils literal"><span class="pre">iskey=True</span></code>.</p>
</div>
<p>Last step is to add a widget to the report and bind the table to the widget at the same time.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Bind the table to a widget for display</span>
<span class="kn">import</span> <span class="nn">steelscript.appfwk.apps.report.modules.yui3</span> <span class="kn">as</span> <span class="nn">yui3</span>
<span class="n">report</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">yui3</span><span class="o">.</span><span class="n">TimeSeriesWidget</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="s">&#39;Close Price&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since the report is a plot based on time, we use yui3.TimeSeriesWidget as the
widget class. Setting <code class="docutils literal"><span class="pre">width=12</span></code> will span the widget across the whole browser, as the whole browser
has 12 &#8216;columns&#8217;.</p>
</div>
</div>
</div>
<div class="section" id="rendering-reports">
<h2>9.11.5. Rendering reports<a class="headerlink" href="#rendering-reports" title="Permalink to this headline">¶</a></h2>
<p>Before running the report, we need to ask the App Framework site to load it. If the report was
added to the <code class="docutils literal"><span class="pre">&lt;appfwk_project&gt;/reports</span></code> directory, one needs to click &#8216;Reload All Reports&#8217;
option from the dropdown menu of the admin button at the top right corner. If the report was added to
the plugin directory, one needs to first click &#8216;Edit Plugins&#8217; option from the dropdown menu
of the admin button, then click the &#8216;Update All Report&#8217; button at the bottom, then check the boxes
for &#8216;Collect Reports&#8217;, &#8216;and Overwrite Reports&#8217; and &#8216;Reload Reports&#8217; at the popup window, and finally
click the &#8216;Go!&#8217; button, shown as the image below. More information about picking up plugin reports are
described <a class="reference internal" href="plugins.html#plugin-reports"><span>here</span></a>.</p>
<img alt="../_images/update-all-reports-popup.png" src="../_images/update-all-reports-popup.png" />
<p>Now, Let us start running the App Framework site in the browser.
After clicking &#8216;Stock Report&#8217; in the dropdown menu of the &#8216;Reports&#8217; tab in the top tool bar, the criteria
fields are shown as below.</p>
<img alt="../_images/stock-criteria.png" src="../_images/stock-criteria.png" />
<p>After click &#8216;Run&#8217; button, the &#8216;close&#8217; price per day for the stock &#8216;rvbd&#8217; for the last year is shown as below.</p>
<img alt="../_images/stock-widget.png" src="../_images/stock-widget.png" />
</div>
<div class="section" id="leveraging-app-framework-device">
<h2>9.11.6. Leveraging App Framework device<a class="headerlink" href="#leveraging-app-framework-device" title="Permalink to this headline">¶</a></h2>
<p>For this stock plugin, there is no physical stock device to configure. But often times,
we need to interact with a device to fetch data and generate reports. Although it is possible
just to put necessary device-related fields in the criteria and run the <a class="reference internal" href="#data-fetch-api"><span>data fetch API</span></a>,
the operation suffers from two flaws: firstly, the criteria fields would be cluttered with
hostname, port, username, password and module fields, all of which would not change between running
reports against the same device; Secondly, it would be very costly to reconnect to the device
every time the report is run. Configuring a device separately from running reports can reduce
the amount information to deal with when filling criteria. It can also cache the device connection
and thus reduce network latency for future reporting runs.</p>
<p>In order to be able to use &#8216;Device&#8217; functionality in the App Framework plugin, the first step is to write
a corresponding device class which can be used as the main interface to interact with the appliance,
handling initialization, setup, and communication. One example is the
<a class="reference external" href="https://support.riverbed.com/apis/steelscript/netprofiler/netprofiler.html#netprofiler-objects">NetProfiler</a>
class. The second step involves modifying <code class="docutils literal"><span class="pre">appfwk/devices/&lt;plugin&gt;_device.py</span></code> to
instantiate the defined appliance class. In the case of NetProfiler,
the code is shown as below.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">steelscript.netprofiler.core.netprofiler</span> <span class="kn">import</span> <span class="n">NetProfiler</span>

<span class="k">def</span> <span class="nf">new_device_instance</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c"># Used by DeviceManager to create a NetProfiler instance</span>
    <span class="k">return</span> <span class="n">NetProfiler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Lastly, when writing data source, a device field needs to be added to the criteria. Take NetProfiler
for example, the code is shown as below.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">steelscript.appfwk.apps.devices.forms</span> <span class="kn">import</span> <span class="n">fields_add_device_selection</span>


<span class="k">class</span> <span class="nc">NetProfilerTable</span><span class="p">(</span><span class="n">DatasourceTable</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">post_process_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_options</span><span class="p">):</span>
        <span class="n">fields_add_device_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="o">=</span><span class="s">&#39;netprofiler_device&#39;</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="s">&#39;NetProfiler&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s">&#39;netprofiler&#39;</span><span class="p">,</span>
                                    <span class="n">enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Now admin user can configure a device for the plugin, and normal users can select corresponding
device before running associated reports against it. More info can be found <a class="reference internal" href="configuration.html#devices"><span>here</span></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/rb-ss-logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="overview.html">SteelScript Application Framework</a></h3>
  <ul>
<li><a class="reference internal" href="#">9.11. Writing a Plugin</a><ul>
<li><a class="reference internal" href="#creating-the-skeleton-of-a-plugin">9.11.1. Creating the skeleton of a plugin</a></li>
<li><a class="reference internal" href="#installing-from-source">9.11.2. Installing from source</a></li>
<li><a class="reference internal" href="#developing-data-fetch-api">9.11.3. Developing data fetch API</a></li>
<li><a class="reference internal" href="#creating-app-framework-reports">9.11.4. Creating App Framework reports</a><ul>
<li><a class="reference internal" href="#writing-data-source">9.11.4.1. Writing data source</a></li>
<li><a class="reference internal" href="#writing-reports">9.11.4.2. Writing Reports</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rendering-reports">9.11.5. Rendering reports</a></li>
<li><a class="reference internal" href="#leveraging-app-framework-device">9.11.6. Leveraging App Framework device</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="plugins.html"
                        title="previous chapter">9.10. Plugins</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="analysis.html"
                        title="next chapter">9.12. Analysis Tables</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/appfwk/tutorial.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>
<a href="../license.html">License</a>
</h3>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="analysis.html" title="9.12. Analysis Tables"
             >next</a> |</li>
        <li class="right" >
          <a href="plugins.html" title="9.10. Plugins"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">steelscript  documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../toc.html" >Table of Contents</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="toc.html" >9. SteelScript Application Framework</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015 Riverbed Technology, Inc..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>